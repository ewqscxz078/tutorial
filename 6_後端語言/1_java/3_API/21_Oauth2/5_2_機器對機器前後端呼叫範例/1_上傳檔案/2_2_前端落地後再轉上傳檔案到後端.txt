ref ChatGPT

æƒ…å¢ƒ2:å…©æ®µå¼ï¼šå‰ç«¯è½åœ°å†ä¸Šå‚³åˆ°å¾Œç«¯
	[ä½¿ç”¨è€…] â†’ HTTP ä¸Šå‚³æª”æ¡ˆ â†’ [å‰ç«¯æœå‹™ï¼ˆClientï¼‰]
			   å‰ç«¯æ¥åˆ° MultipartFile ä¹‹å¾Œï¼Œå†é€é WebClient + JWT â†’
			   å‘¼å« Resource Server å‚³é€æª”æ¡ˆ â†’ [å¾Œç«¯æœå‹™ï¼ˆResource Serverï¼‰]
	1.ä½¿ç”¨è€…å‚³æª”æ¡ˆçµ¦ã€Œå‰ç«¯æœå‹™ã€

	2.å‰ç«¯æœå‹™å°‡æ¥æ”¶åˆ°çš„ Multipart æª”æ¡ˆé€é WebClient æ­é… JWT ä¸Šå‚³åˆ°å¾Œç«¯ï¼ˆå…§ç¶²æˆ–å—ä¿è­·çš„ APIï¼‰


ğŸ“ 1. ä½¿ç”¨è€… â†’ å‰ç«¯æœå‹™ï¼ˆControllerï¼‰
	@RestController
	public class UserUploadController {

		private final FileRelayService fileRelayService;

		public UserUploadController(FileRelayService fileRelayService) {
			this.fileRelayService = fileRelayService;
		}

		@PostMapping("/upload")
		public ResponseEntity<String> userUpload(@RequestParam("file") MultipartFile file) throws IOException {
			String result = fileRelayService.forwardFileToBackend(file);
			return ResponseEntity.ok("å‰ç«¯æ”¶åˆ°æª”æ¡ˆï¼Œå¾Œç«¯å›æ‡‰ï¼š" + result);
		}
	}


ğŸ“ 2. å‰ç«¯æœå‹™ â†’ å¾Œç«¯æœå‹™ï¼ˆWebClient å‚³é€æª”æ¡ˆï¼‰
	@Service
	public class FileRelayService {

		private final WebClient webClient;

		public FileRelayService(WebClient webClient) {
			this.webClient = webClient;
		}

		public String forwardFileToBackend(MultipartFile file) throws IOException {
			return webClient.post()
					.uri("http://localhost:8081/api/files/upload")
					.contentType(MediaType.MULTIPART_FORM_DATA)
					.body(BodyInserters.fromMultipartData("file",
							new MultipartBodyBuilder()
								.part("file", file.getResource())
								.filename(file.getOriginalFilename())
								.build()
								.toSingleValueMap()))
					.retrieve()
					.bodyToMono(String.class)
					.block();
		}
	}

	è©²ç¯„ä¾‹:æ²’æœ‰å…ˆåœ¨å‰ç«¯ã€Œæ˜ç¢ºè½åœ°åˆ°ç£ç¢Ÿã€ï¼Œä½†æœƒæœ‰ã€Œè¨˜æ†¶é«”æˆ–è‡¨æ™‚æª”æ¡ˆè½åœ°ã€çš„æƒ…æ³ï¼ˆç”± Spring è‡ªå‹•è™•ç†ï¼‰
		ğŸ” å…·é«”ä¾†èªªï¼š
			MultipartFile file
				é€™å€‹ file æ˜¯ç”± Spring MVC åœ¨ multipart/form-data ä¸Šå‚³è§£ææ™‚å»ºç«‹çš„ï¼Œå…·é«”æœƒç”¨ StandardMultipartHttpServletRequest æŠŠå…§å®¹è½‰æˆ CommonsMultipartFile æˆ–å…¶ä»–å¯¦ä½œã€‚
				Spring çš„è¡Œç‚ºæ˜¯ï¼š
					å°æª”æ¡ˆæœƒå­˜åœ¨ è¨˜æ†¶é«”ä¸­ï¼ˆin-memoryï¼‰
					å¤§æª”æ¡ˆï¼ˆé€šå¸¸è¶…é spring.servlet.multipart.file-size-thresholdï¼Œé è¨­ 0ï¼‰æœƒå¯«åˆ° è‡¨æ™‚ç›®éŒ„ï¼ˆå¦‚ /tmpï¼‰
				æ‰€ä»¥å³ä½¿ä½ æ²’é¡¯å¼ .transferTo(new File(...)) è½åœ°ï¼ŒSpring èƒŒå¾Œæœ‰å¯èƒ½å·²ç¶“å…ˆè½åœ°äº†è‡¨æ™‚æª”æ¡ˆã€‚
			ç•¶ä½ å‘¼å«ï¼š
				file.getResource()
					å…¶å¯¦æœƒå›å‚³ä¸€å€‹ FileSystemResource æˆ– ByteArrayResourceï¼Œè¦– Spring å¦‚ä½•è™•ç†è©²æª”æ¡ˆè€Œå®šã€‚
		âœ… æ‰€ä»¥é€™æ®µç¨‹å¼å±¬æ–¼ï¼š
			| å±¤ç´š         | è©•åƒ¹                                                                                   |
			| ------------ | -------------------------------------------------------------------------------------- |
			| è½åœ°èˆ‡å¦     | âœ…**ä½¿ç”¨è€…ä¸æ˜ç¢ºè½åœ°**ï¼Œä½†**å¯èƒ½ç”± Spring å¯¦ä½œè½åœ°è‡³ tmp**                             |
			| å‚³é€æ–¹å¼     | âœ… æ˜¯åŸºæ–¼ Resource ä½œç‚º multipart å‚³é€é«”ï¼Œé€é `WebClient`                             |
			| æ˜¯å¦çœŸæ­£ä¸²æµ | âŒ ä¸¦é true streamingï¼ˆInputStream to InputStreamï¼‰<br>âœ… æ˜¯åŸºæ–¼æª”æ¡ˆæˆ– ByteArray è½‰ç™¼ |


ğŸ“ 3. å¾Œç«¯æœå‹™æ¥æ”¶
	@PostMapping("/api/files/upload")
	public ResponseEntity<String> handleUpload(
			@RequestPart("file") MultipartFile file,
			@AuthenticationPrincipal Jwt jwt) throws IOException {

		String clientId = jwt.getSubject();
		String fileName = file.getOriginalFilename();
		System.out.println("ä¾†è‡ª: " + clientId + ", æª”å: " + fileName);
		// å„²å­˜...
		return ResponseEntity.ok("æª”æ¡ˆ " + fileName + " ä¸Šå‚³æˆåŠŸ");
	}


ğŸ“ å°è£œå……
	è‹¥æª”æ¡ˆå…§å®¹å¾ˆå¤§ï¼Œå¯è€ƒæ…®ä½¿ç”¨ streamingï¼ˆInputStreamResourceï¼‰ å‚³è¼¸
	è‹¥éœ€æƒæ¯’ã€å£“ç¸®ã€åŠ å¯†ï¼Œå¯æ–¼å¾Œç«¯è™•ç†å¾Œå›å‚³ metadata
	å¯åŠ ä¸Š traceId æˆ– fileId æ–¹ä¾¿å‰å¾Œæœå‹™è¿½è¹¤