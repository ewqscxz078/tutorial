ref ChatGPT

æƒ…å¢ƒ1: å‰ç«¯ï¼ˆæˆ– batch jobï¼‰ç›´æ¥è®€æª”ä¸¦é€é WebClient å‚³çµ¦å¾Œç«¯
	âœ… 1. Auth Server è¨»å†Š Clientï¼ˆç•¥ï¼‰
		client-id: file-uploader
		client-secret: uploader-secret
		grant-type: client_credentials
		scope: file.upload

	âœ… 2. Client ç«¯ç¨‹å¼ï¼ˆå‰ç«¯æŸbatchjob ä¸Šå‚³æª”æ¡ˆï¼‰
		ğŸ”§ application.yml
			spring:
			  security:
				oauth2:
				  client:
					registration:
					  file-uploader:
						client-id: file-uploader
						client-secret: uploader-secret
						authorization-grant-type: client_credentials
						scope: file.upload
						provider: auth-server
					provider:
					  auth-server:
						token-uri: http://localhost:9000/oauth2/token
		â˜• Java ç¨‹å¼ç¢¼ï¼ˆä½¿ç”¨ WebClient å‚³ multipart æª”æ¡ˆï¼‰
			@Autowired
			private WebClient webClient;

			public void uploadFile(Path filePath) throws IOException {
				Resource resource = new FileSystemResource(filePath);

				webClient.post()
					.uri("http://localhost:8081/api/files/upload")
					.contentType(MediaType.MULTIPART_FORM_DATA)
					.body(BodyInserters.fromMultipartData("file", resource))
					.retrieve()
					.bodyToMono(String.class)
					.doOnNext(resp -> System.out.println("âœ… ä¸Šå‚³å®Œæˆ: " + resp))
					.block();
			}

	âœ… 3. Resource Server ç«¯ç¨‹å¼ï¼ˆæ¥æ”¶æª”æ¡ˆï¼‰
		ğŸ”§ application.yml
			spring:
			  security:
				oauth2:
				  resourceserver:
					jwt:
					  jwk-set-uri: http://localhost:9000/oauth2/jwks
		â˜• Java REST Controller
			@RestController
			@RequestMapping("/api/files")
			public class FileUploadController {

				@PostMapping("/upload")
				public ResponseEntity<String> handleUpload(
						@RequestPart("file") MultipartFile file,
						@AuthenticationPrincipal Jwt jwt) throws IOException {

					String clientId = jwt.getSubject(); // ex: file-uploader
					String fileName = file.getOriginalFilename();
					System.out.println("ğŸ” ä¸Šå‚³è€…: " + clientId + ", æª”æ¡ˆ: " + fileName);

					// å„²å­˜æª”æ¡ˆ
					Path dest = Path.of("/tmp/uploads/", fileName);
					file.transferTo(dest);

					return ResponseEntity.ok("Uploaded: " + fileName);
				}
			}

		âœ… Security è¨­å®šï¼ˆResource Server æ”¾è¡Œ /api/files/upload ä¸¦é©—è­‰ JWTï¼‰
			@Bean
			public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
				http
					.authorizeHttpRequests(auth -> auth
						.requestMatchers("/api/files/upload").hasAuthority("SCOPE_file.upload")
						.anyRequest().authenticated()
					)
					.oauth2ResourceServer(oauth2 -> oauth2.jwt());

				return http.build();
			}

ğŸ” å°æŠ€å·§
	å¯ä¾ clientIdï¼ˆå³ JWT çš„ subï¼‰å»ºç«‹å°ˆå±¬æª”æ¡ˆç›®éŒ„
	ä¸Šå‚³è€…å¯å¸¶é™„åŠ åƒæ•¸ï¼ˆå¦‚æª”æ¡ˆç”¨é€”ã€å‚™è¨»ã€ä¸Šå‚³æ™‚é–“ç­‰ï¼‰
	å¯æ­é… checksumã€scan æˆ–å¾ŒçºŒéåŒæ­¥è™•ç†æµç¨‹

