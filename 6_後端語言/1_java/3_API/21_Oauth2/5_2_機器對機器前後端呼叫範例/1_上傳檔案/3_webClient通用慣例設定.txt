ref ChatGPT

å…±ç”¨è¨­å®šçš„ WebClient Builder / Bean

ğŸ›  æ–¹å¼ä¸€ï¼šå»ºç«‹å…¨åŸŸ @Bean WebClientï¼ˆå»ºè­°ï¼‰

	@Configuration
	public class WebClientConfig {

		@Bean
		public WebClient webClient(ClientRegistrationRepository clients,
								   OAuth2AuthorizedClientRepository authClients) {

			ServletOAuth2AuthorizedClientExchangeFilterFunction oauth2 =
				new ServletOAuth2AuthorizedClientExchangeFilterFunction(clients, authClients);
			oauth2.setDefaultClientRegistrationId("file-proxy-client");

			return WebClient.builder()
				.apply(oauth2.oauth2Configuration())  // è‡ªå‹•åŠ  Bearer Token
				.defaultHeader(HttpHeaders.ACCEPT, MediaType.APPLICATION_JSON_VALUE)
				.filter((request, next) -> {
					// ä¾‹å¤–æ””æˆªå™¨ï¼ˆå…¨åŸŸï¼‰
					return next.exchange(request)
						.flatMap(response -> {
							if (response.statusCode().isError()) {
								return response.bodyToMono(String.class)
									.flatMap(body -> Mono.error(new RuntimeException("å¾Œç«¯éŒ¯èª¤ï¼š" + body)));
							}
							return Mono.just(response);
						});
				})
				.clientConnector(new ReactorClientHttpConnector(
					HttpClient.create().responseTimeout(Duration.ofSeconds(10))  // å…¨åŸŸ timeout
				))
				.build();
		}
	}

	å‘¼å«ç«¯
		@Autowired
		private WebClient webClient;

		webClient.post()
			.uri("http://localhost:8081/api/files/upload")
			.body(...)
			.retrieve()
			.bodyToMono(String.class)
			...

ğŸ›  æ–¹å¼äºŒï¼šå°è£ WebClient å·¥å…·é¡ï¼ˆä¹Ÿå¯ä»¥ï¼‰
	å¦‚æœä½ æœ‰å¾ˆå¤šç¨®ä¸åŒè¡Œç‚ºçš„ WebClientï¼Œä¹Ÿå¯ä»¥å»ºä¸€å€‹ WebClientFactory æˆ– WebClientHelperï¼š
		@Component
		public class WebClientHelper {

			private final WebClient.Builder builder;

			public WebClientHelper(WebClient.Builder builder) {
				this.builder = builder;
			}

			public WebClient create(String registrationId) {
				return builder
					.filter(...)
					.build();
			}
		}


âœ… å¯¦å‹™ä¸Šå»ºè­°æ€éº¼åšï¼Ÿ
	| é …ç›®                                    | å»ºè­°åšæ³•                                                  |
	| --------------------------------------- | --------------------------------------------------------- |
	| å¤šè™•éœ€è¦ç›¸åŒè¨­å®š                        | âœ… ä½¿ç”¨ `@Bean WebClient`ï¼ˆå…±ç”¨é…ç½®ï¼‰                     |
	| éœ€è¦ä¾ clientId åˆ‡æ›                    | âœ… ä½¿ç”¨ `OAuth2AuthorizedClientManager` å‹•æ…‹è¨­å®š          |
	| å¤šå€‹ WebClient profileï¼ˆå«ä¸åŒ baseUrlï¼‰| âœ… å»ºç«‹å¤šå€‹å‘½å `@Bean WebClient` æˆ–ç”¨ `WebClientFactory` |
	| éœ€è¦æ¯æ¬¡è‡ªè¨‚ header                     | å¯åœ¨ `.filter(...)` ä¸­å‹•æ…‹åŠ ä¸Š `request.headers(...)`     |
