å¿…è¦è¨­å®šé …ç›®ç¸½è¦½
	| é …ç›®                                             | èªªæ˜                                                |
	| ------------------------------------------------ | ------------------------------------------------- |
	| ğŸ”‘ è¨­å®š Resource Server çš„ JWT é©—è­‰æ–¹å¼          | é€šå¸¸æ˜¯ issuer-uri æˆ– jwk-set-uri                      |
	| ğŸ” è¨­å®šæ¬Šé™ä¿è­·è¦å‰‡ï¼ˆå¦‚ scopeã€è§’è‰²ï¼‰            | ä½¿ç”¨ `@PreAuthorize`ã€æˆ– HTTP security è¨­å®š             |
	| ğŸ“„ é…ç½® application.yml / application.properties | å‘Šè¨´ Spring Boot å¦‚ä½•é©—è­‰ JWT                           |
	| ğŸ§ª Optionalï¼šåŠ å…¥æ¬Šé™é©—è­‰æ¸¬è©¦æ©Ÿåˆ¶                | e.g. `@PreAuthorize("hasAuthority('SCOPE_xxx')")` |


1. åŠ å…¥ä¾è³´ï¼ˆSpring Bootï¼‰
	<dependency>
	  <groupId>org.springframework.boot</groupId>
	  <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
	</dependency>

2. application.yml è¨­å®š Resource Server æ¨¡å¼
	spring:
	  security:
		oauth2:
		  resourceserver:
			jwt:
			  issuer-uri: https://auth.example.com
				#issuer-uriï¼šæŒ‡å®š Auth Server çš„ /.well-known/openid-configuration ä½ç½®
				#Spring Security æœƒè‡ªå‹•å»æŠ“ jwks_uriï¼Œå–å¾— JWT å…¬é‘°

3. ä¿è­· APIï¼ˆè¨­å®šæ¬Šé™æ§åˆ¶ï¼‰
	æ–¹æ³•ä¸€ï¼šç°¡å–®ä¿è­·æ‰€æœ‰ API
		@Bean
		SecurityFilterChain security(HttpSecurity http) throws Exception {
			http
			  .csrf(csrf -> csrf.disable())
			  .sessionManagement(sess -> sess.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
			  .authorizeHttpRequests(authz -> authz
				  .anyRequest().authenticated()
			  )
			  .oauth2ResourceServer(oauth2 -> oauth2.jwt());
			return http.build();
		}

	æ–¹æ³•äºŒï¼šæ­é… scope é©—è­‰
		@RestController
		public class DemoController {

			@GetMapping("/api/data")
			@PreAuthorize("hasAuthority('SCOPE_read')")
			public String getData() {
				return "Protected Data";
			}
		}
		é€™æ™‚ä½ è¦ç¢ºä¿ JWT ä¸­åŒ…å« scope: read çš„ claimã€‚

		ä¹Ÿå¯ä»¥é€™æ¨£ç”¨
			| å¯«æ³•                                                             | æ„ç¾©                      |
			| -------------------------------------------------------------- | ----------------------- |
			| `hasAuthority('SCOPE_read')`                                   | å¿…é ˆæœ‰ `read` scope        |
			| `hasAuthority('ROLE_ADMIN')`                                   | å¿…é ˆæœ‰ `roles` æ¬Šé™ç‚º `ADMIN` |
			| `hasAnyAuthority('SCOPE_read', 'SCOPE_write')`                 | æœ‰ä»»ä¸€ scope å³å¯            |
			| `hasAuthority('SCOPE_admin') and hasAuthority('SCOPE_manage')` | åŒæ™‚è¦æœ‰å…©å€‹æ¬Šé™                |
		è¦è®“é€™è¡Œåˆ¤æ–·ç”Ÿæ•ˆçš„å‰æ
			ä½ å¿…é ˆï¼š
				1.ä½¿ç”¨ Spring Security Resource Server æ¨¡å¼
				2.JWT ä¸­æœ‰ scope æ¬„ä½ï¼ˆæˆ–å°æ‡‰ claimï¼‰
				3.ä½¿ç”¨ .oauth2ResourceServer().jwt() çš„é©—è­‰æ©Ÿåˆ¶
				4.æœ‰é–‹å•Ÿ @EnableGlobalMethodSecurity(prePostEnabled = true)ï¼ˆæˆ– Spring Security 6 ç”¨ @EnableMethodSecurityï¼‰

4. Auth Server è¦ç”¢å‡º JWT ä¸¦å…è¨±è©² client scope
	RegisteredClient.withId(UUID.randomUUID().toString())
		.clientId("client-a")
		.clientSecret("{noop}secret123")
		.authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
		.scope("read")
		.build();

5. æ¸¬è©¦æ–¹å¼ï¼ˆå–å¾— JWTï¼‰
	curl -X POST https://auth.example.com/oauth2/token \
	  -u client-a:secret123 \
	  -d grant_type=client_credentials

	å›å‚³å¾Œæ‹¿åˆ°çš„ access_tokenï¼š
	curl https://your-backend/api/data \
	  -H "Authorization: Bearer <access_token>"


Q: Scope é€šå¸¸åªæœ‰ readã€write æˆ– read write çš„è¨­å®šæ–¹å¼? å¯ä»¥è‡ªè¨‚?
	scope æ˜¯å®Œå…¨å¯ä»¥è‡ªè¨‚
	Scope èˆ‡æ¬Šé™çš„å‘½åå»ºè­°
		| é¡å‹              | å‘½åæ–¹å¼ç¯„ä¾‹                      | å‚™è¨»                     |
		| ----------------- | --------------------------------- | ------------------------ |
		| è³‡æ–™æ“ä½œ          | `read_x`, `write_x`               | å°æ‡‰ CRUD è¡Œç‚º           |
		| ç®¡ç†å¾Œå°åŠŸèƒ½      | `admin_x`, `manage_x`             | ä»£è¡¨éœ€æ›´é«˜æ¬Šé™           |
		| REST é¢¨æ ¼è³‡æºåˆ†é¡ | `order.view`, `user.create`       | æ¨¡ä»¿è³‡æºè·¯ç”±éšå±¤çµæ§‹     |
		| å‘½åç©ºé–“          | `task:execute`, `log:read`        | ä½¿ç”¨å†’è™ŸåŠƒåˆ†æ¨¡çµ„ã€å‹•ä½œç­‰ |

	åœ¨ Auth Server è¨»å†Š RegisteredClient æ™‚ç›´æ¥è‡ªè¨‚
		RegisteredClient.withId(UUID.randomUUID().toString())
			.clientId("client-a")
			.clientSecret("{noop}secret123")
			.authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
			.scope("read_profile")
			.scope("admin_manage_user")
			.build();

	åœ¨ Resource Server ä¸­é€™æ¨£æˆæ¬Šæ§åˆ¶
		@GetMapping("/api/profile")
		@PreAuthorize("hasAuthority('SCOPE_read_profile')")
		public String profile() {
			return "OK";
		}

		@PostMapping("/api/admin/users")
		@PreAuthorize("hasAuthority('SCOPE_admin_manage_user')")
		public String adminOnly() {
			return "Admin done";
		}

	JWT ä¸­ç¯„ä¾‹ payloadï¼š
		{
		  "iss": "https://auth.example.com",
		  "sub": "client-a",
		  "scope": "read_profile admin_manage_user",
		  "exp": 1715458000
		}

	çµè«–
		| å•é¡Œ                               | å›ç­”                          |
		| ---------------------------------- | --------------------------- |
		| scope å¯ä»¥è‡ªè¨‚å—ï¼Ÿ                 | âœ… å®Œå…¨å¯ä»¥ï¼Œè‡ªç”±å®šç¾©                 |
		| æœ‰æ¨è–¦å‘½åæ–¹å¼å—ï¼Ÿ                 | âœ… å»ºè­°ä½¿ç”¨ `è³‡æº.å‹•ä½œ` æˆ– `æ¨¡çµ„:æ¬Šé™` æ ¼å¼ |
		| æˆæ¬Šæ™‚ç”¨ scope å°±å¯ä»¥æ§ç®¡ API å—ï¼Ÿ | âœ… å¯é€é `@PreAuthorize` ç²¾ç´°æ§åˆ¶  |


scope å‘½åè¦å‰‡æŒ‡å— + åˆ†å±¤æ¬Šé™å»ºè­°è¡¨
	ä¸€ã€å‘½åé¢¨æ ¼å»ºè­°ï¼ˆScope å‘½åï¼‰
		| å‘½åæ–¹å¼    | ç¯„ä¾‹                          | èªªæ˜                   |
		| ------- | --------------------------- | -------------------- |
		| `è³‡æº.å‹•ä½œ` | `order.read`ã€`user.create`  | é¡ä¼¼ REST è·¯ç”±ï¼Œæ¸…æ¥šè¡¨ç¤ºè³‡æºèˆ‡æ“ä½œ |
		| `æ¨¡çµ„:å‹•ä½œ` | `task:execute`ã€`log:view`   | é©åˆæ¨¡çµ„å‹ç³»çµ±ï¼ˆå†’è™Ÿåˆ†éš”å¯åˆ†é¡ï¼‰     |
		| `é¡åˆ¥_å‹•ä½œ` | `admin_manage_user`         | ä½¿ç”¨åº•ç·šï¼Œé©åˆæè¿°è¤‡é›œæ¨¡çµ„/è·è²¬     |
		| `å‹•è©è³‡æº`  | `readProfile`, `writeOrder` | å‚³çµ± OAuth2 é¢¨æ ¼ï¼Œç°¡æ½”ä½†åˆ†é¡ä¸æ˜ |
		ğŸ”§ å»ºè­°ï¼š
			è‹¥æ˜¯ RESTful ç³»çµ± â†’ æ¨è–¦ è³‡æº.å‹•ä½œ
			è‹¥æ˜¯æ¨¡çµ„åˆ†å±¤è¨­è¨ˆ â†’ æ¨è–¦ æ¨¡çµ„:å‹•ä½œ
			å‘½åç›¡é‡å…·å¯è®€æ€§ï¼Œé¿å…ç¸®å¯«ï¼ˆå¦‚ r_o, w_uï¼‰

	äºŒã€åŠŸèƒ½æ¨¡çµ„ç¯„ä¾‹è¦åŠƒï¼ˆåˆ†å±¤è¨­è¨ˆï¼‰
		| åŠŸèƒ½æ¨¡çµ„   | å»ºè­° Scope åç¨±                              | å°æ‡‰æ¬Šé™ç”¨é€”           |
		| ---------- | -------------------------------------------- | ---------------- |
		| ä½¿ç”¨è€…ç®¡ç† | `user.read`, `user.write`, `user.delete`     | æŸ¥è©¢ã€ç·¨è¼¯ã€åˆªé™¤ä½¿ç”¨è€…è³‡æ–™    |
		| è§’è‰²/æ¬Šé™  | `role.view`, `role.assign`                   | æª¢è¦–è§’è‰²æ¸…å–®ã€æŒ‡æ´¾è§’è‰²      |
		| è¨‚å–®ç³»çµ±   | `order.read`, `order.create`, `order.cancel` | è®€å–è¨‚å–®ã€ä¸‹å–®ã€å–æ¶ˆè¨‚å–®     |
		| å ±è¡¨ç³»çµ±   | `report.view`, `report.export`               | çœ‹å ±è¡¨ã€åŒ¯å‡º Excel/PDF |
		| ä»»å‹™æ’ç¨‹   | `task:execute`, `task:manage`                | è§¸ç™¼ä»»å‹™ã€èª¿æ•´æ’ç¨‹è¨­å®š      |
		| è¨­å®šä¸­å¿ƒ   | `config.view`, `config.update`               | ç³»çµ±åƒæ•¸è¨­å®š           |
		| ç®¡ç†ç«¯åŠŸèƒ½ | `admin:dashboard`, `admin:user_manage`       | ç®¡ç†å“¡æ§åˆ¶å°ã€ä½¿ç”¨è€…ç®¡ç†æ“ä½œ   |

	ä¸‰ã€Scope å±¤ç´šå»ºè­°ï¼ˆç´°åˆ† vs åˆä½µï¼‰
		| é¡å‹            | å»ºè­°                    | ç¯„ä¾‹                                  |
		| --------------- | ----------------------- | ------------------------------------- |
		| ğŸŒ± åŸºæœ¬æ“ä½œ     | æ‹†é–‹æˆç´°é …              | `user.read` vs `user.write`           |
		| ğŸŒ³ ç®¡ç†å“¡åŠŸèƒ½   | å¯ç”¨ä¸€çµ„ç¸½æ¬Šé™          | `admin.all`ï¼ˆä½†è¦å°å¿ƒæ¿«æ¬Šï¼‰           |
		| ğŸ“¦ é€šç”¨åŠŸèƒ½     | åˆä½µç‚º `system.read` ç­‰ | é©ç”¨æŸ¥è©¢é¡ API                        |
		| ğŸ§© å¤šç§Ÿæˆ¶æˆ–æ¨¡çµ„ | å»ºè­°åŠ å‰ç¶´åç¨±          | `tenant1.user.read`ã€`report:summary` |

	å››ã€æ‡‰ç”¨å»ºè­°ï¼ˆèˆ‡å¾Œç«¯æ­é…ï¼‰
		Spring Security ä¸­ï¼š
			@PreAuthorize("hasAuthority('SCOPE_order.create')")
			public void createOrder() {...}
		JWT Claim ç¯„ä¾‹ï¼š
			{
			  "scope": "order.read order.create report.view"
			}

	äº”ã€å¸¸è¦‹éŒ¯èª¤è§€å¿µæ¾„æ¸…
		| å¸¸è¦‹èª¤è§£                       | æ­£ç¢ºè§€å¿µ                          |
		| ------------------------------ | ----------------------------- |
		| scope åªèƒ½ç”¨ `read` / `write`  | âŒ å¯ä»¥è‡ªè¨‚ä»»æ„æ¬Šé™å­—ä¸²                  |
		| æ¯å€‹ API éƒ½è¦ä¸€å€‹ scope        | âŒ å¯ä¾æ¨¡çµ„åˆ†é¡ä¸€çµ„ scope æ§å¤šå€‹ API      |
		| scope åƒ…ç”¨ä¾†é¡¯ç¤ºï¼Œä¸åšæ¬Šé™æ§ç®¡ | âŒ æ‡‰åœ¨å¾Œç«¯ `@PreAuthorize` åš´æ ¼æˆæ¬Šæª¢æŸ¥ |
		| ä¸€å€‹ token æ‡‰è©²åŒ…å«æ‰€æœ‰æ¬Šé™    | âŒ åªæ‡‰ç™¼å‡ºè©² client è©²æ“ä½œæ‰€éœ€çš„æœ€å°æ¬Šé™é›†    |
	âœ… å°çµå»ºè­°
		âœ… å»ºè­°å…ˆå¾ç³»çµ±çš„ åŠŸèƒ½æ¨¡çµ„æˆ– REST API åˆ†é¡ å‡ºç™¼è¦åŠƒ scope
		âœ… ä½¿ç”¨ä¸€è‡´çš„å‘½åè¦å‰‡ï¼ˆå¦‚ è³‡æº.å‹•ä½œï¼‰å¯å¤§å¹…æå‡å¯ç¶­è­·æ€§
		âœ… scope â‰  è§’è‰²ï¼Œä½†å¯è¼”åŠ©å¯¦ä½œ RBAC
		âœ… å°‡ scope æ¬Šé™èˆ‡ @PreAuthorize åš´æ ¼æ­é…æ˜¯æœ€ä½³å¯¦å‹™


scope æ˜¯ç‚ºäº†åœ¨å¾Œç«¯èƒ½è¾¨åˆ¥ä¸¦é™åˆ¶ä¾†è‡ªä¸åŒ clientï¼ˆå°¤å…¶æ˜¯å¤šå€‹å‰ç«¯ï¼‰å„è‡ªæ“æœ‰çš„å­˜å–æ¬Šé™
	æ˜¯ä¸€ç¨®ã€Œæˆæ¬Šè²æ˜ã€
		å®ƒä»£è¡¨ï¼šã€Œé€™å€‹ clientï¼ˆæˆ– userï¼‰è¢«æˆæ¬Šå¯ä»¥åšä»€éº¼ï¼Ÿã€

	å¾Œç«¯ API å¾ˆå¯èƒ½è¢«å¤šç¨® client ä½¿ç”¨
		| Client            | ç”¨é€”                 | æ¬Šé™éœ€æ±‚                       |
		| ----------------- | -------------------- | ------------------------------ |
		| å‰å°å‰ç«¯ï¼ˆSPAï¼‰   | é¡¯ç¤ºå€‹äººè³‡æ–™ã€ä¸‹è¨‚å–® | `profile.read`, `order.create` |
		| å¾Œå°ç®¡ç†ç³»çµ±      | ç®¡ç†ä½¿ç”¨è€…ã€å¯©æ ¸è¨‚å–® | `user.manage`, `order.approve` |
		| ä»»å‹™æ’ç¨‹ç³»çµ±      | è‡ªå‹•å–æ¶ˆé€¾æœŸè¨‚å–®     | `order.cancel`, `report.view`  |
		| å¤–éƒ¨æ•´åˆ client   | ä¸²æ¥è¨‚å–®æŸ¥è©¢ API     | `order.read`                   |

	å¾Œç«¯éœ€è¦é  scope ä¾†ï¼š
		âœ… åˆ†è¾¨ä¸åŒ client çš„è¡Œç‚ºé‚Šç•Œ
		âœ… æ§åˆ¶æ¯æ”¯ API æ˜¯å¦å…è¨±è¢«æŸ client åŸ·è¡Œ
		âœ… é™ä½æ¿«æ¬Šé¢¨éšªï¼ˆæœ€å°æ¬Šé™åŸå‰‡ï¼‰

	å’Œè§’è‰²ï¼ˆroleï¼‰æœ‰ä»€éº¼ä¸åŒï¼Ÿ
		| åˆ†é¡      | å®šç¾©                      | å…¸å‹ç”¨é€”                     |
		| --------- | ------------------------- | ------------------------ |
		| `scope`   | OAuth2 çš„æˆæ¬Šç¯„åœï¼ˆè¡Œç‚ºï¼‰ | æ§åˆ¶ API å±¤ç´šæ¬Šé™ï¼Œé‡å° client å®šç¾© |
		| `role`    | ä½¿ç”¨è€…/ç³»çµ±è§’è‰²ï¼ˆèº«åˆ†ï¼‰   | æ§åˆ¶ä½¿ç”¨è€…èº«åˆ†ï¼ˆå¦‚ adminã€managerï¼‰ |

		ğŸ”¸ scope æ¯”è¼ƒåƒã€Œä½ å…è¨±åšä»€éº¼ã€
		ğŸ”¸ role æ¯”è¼ƒåƒã€Œä½ æ˜¯èª°ã€



Q:å¦‚æœé€™æ¨£å¯«  @PreAuthorize("hasAuthority('SCOPE_order.create')")
	çœ‹èµ·ä¾†å¾ˆæ­»ï¼Œæ¯å€‹ api æˆæ¬Šæ–¹å¼ä¸èƒ½å¯«æˆå‹•æ…‹é»çš„æ–¹å¼?

A: è§£æ³•ï¼šä½¿ç”¨ã€Œå‹•æ…‹æˆæ¬Šã€é‚è¼¯æ›¿ä»£ @PreAuthorize
	æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨è‡ªè¨‚ AccessDecisionVoter / AuthorizationManager
		è‡ªè¨‚ä¸€å€‹æˆæ¬Šé‚è¼¯ï¼Œä¾‹å¦‚ï¼š
			public class ScopeBasedAuthorizationManager implements AuthorizationManager<RequestAuthorizationContext> {

				@Override
				public AuthorizationDecision check(Supplier<Authentication> authentication, RequestAuthorizationContext context) {
					HttpServletRequest request = context.getRequest();
					String method = request.getMethod();
					String path = request.getRequestURI();

					// ç¯„ä¾‹ï¼šå°æ‡‰ scope = method + pathï¼Œä¾‹å¦‚ "GET /api/order" -> "SCOPE_order.read"
					String requiredScope = convertPathToScope(method, path);

					boolean hasScope = authentication.get().getAuthorities().stream()
						.anyMatch(auth -> auth.getAuthority().equals(requiredScope));

					return new AuthorizationDecision(hasScope);
				}

				private String convertPathToScope(String method, String path) {
					// ç¯„ä¾‹ï¼šGET /api/order â†’ SCOPE_order.read
					if (method.equals("GET") && path.startsWith("/api/order")) return "SCOPE_order.read";
					if (method.equals("POST") && path.startsWith("/api/order")) return "SCOPE_order.create";
					return "SCOPE_unknown";
				}
			}

		æ­é… authorizeHttpRequests() å‹•æ…‹å¥—ç”¨ï¼š
			http.authorizeHttpRequests(authz -> authz
				.requestMatchers("/api/**").access(new ScopeBasedAuthorizationManager())
				.anyRequest().authenticated()
			);

		å®Œå…¨å‹•æ…‹ã€å¯ä»¥å¾è·¯ç”±æˆ–è‡ªè¨‚ç­–ç•¥è½‰æ›æˆ scope

	æ–¹æ¡ˆäºŒï¼šåœ¨ Controller æˆ– Filter ä¸­è‡ªå·±é©—è­‰ scope
		é©åˆä½ éœ€è¦æ›´éˆæ´»çš„æ§åˆ¶é‚è¼¯ï¼Œç¯„ä¾‹å¦‚ï¼š
			@GetMapping("/api/order")
			public String order(HttpServletRequest request, @AuthenticationPrincipal Jwt jwt) {
				List<String> scopes = jwt.getClaimAsStringList("scope");
				if (!scopes.contains("order.read")) {
					throw new AccessDeniedException("No permission");
				}
				return "OK";
			}
		æˆ–æŠ½å‡ºå…±ç”¨çš„ methodï¼š
			public void checkScope(Jwt jwt, String required) {
				List<String> scopes = jwt.getClaimAsStringList("scope");
				if (!scopes.contains(required)) {
					throw new AccessDeniedException("Missing scope: " + required);
				}
			}

	ç¸½çµï¼šSpring Security çš„ @PreAuthorize é©åˆéœæ…‹æˆæ¬Šï¼Œè‹¥éœ€å‹•æ…‹æˆæ¬Šï¼š
		| è§£æ³•                                 | é©ç”¨æƒ…å¢ƒ                          | å¯å‹•æ…‹åˆ¤æ–·ï¼Ÿ |
		| ------------------------------------ | --------------------------------- | ------ |
		| `@PreAuthorize("hasAuthority(...)")` | ç°¡å–®æ¬Šé™æ§åˆ¶ï¼ˆéœæ…‹ï¼‰              | âŒ      |
		| è‡ªè¨‚ `AuthorizationManager`          | æƒ³æ ¹æ“š API è·¯ç”±æˆ– method æ±ºå®šæ¬Šé™ | âœ…      |
		| æ‰‹å‹•åœ¨ Controller é©—è­‰ claim         | è¶…å½ˆæ€§ã€è‡ªè¨‚éŒ¯èª¤å›æ‡‰æˆ– logging    | âœ…      |

	å»ºè­° ç”¢å‡ºä¸€å€‹ YAML æ ¼å¼çš„ã€Œclient + scope å°æ‡‰æ¸…å–®ã€æ¨¡ç‰ˆï¼Œæ–¹ä¾¿åœ¨ CI/CD ç®¡ç†
		YAML æ¨¡æ¿ï¼šclient-scope-config.yml
			auth:
			  clients:
				- clientId: frontend-user
				  clientSecret: ${FRONTEND_USER_SECRET}
				  grantTypes: [client_credentials]
				  scopes:
					- profile.read
					- order.create

				- clientId: backend-batch
				  clientSecret: ${BATCH_CLIENT_SECRET}
				  grantTypes: [client_credentials]
				  scopes:
					- order.cancel
					- report.generate

				- clientId: admin-portal
				  clientSecret: ${ADMIN_PORTAL_SECRET}
				  grantTypes: [client_credentials]
				  scopes:
					- user.manage
					- role.assign
					- config.update

		å°æ‡‰ Java è®€å–è¨­å®šï¼ˆSpring Bootï¼‰
			@ConfigurationProperties(prefix = "auth")
			public class AuthClientProperties {
				private List<OAuthClient> clients;

				// getters/setters

				public static class OAuthClient {
					private String clientId;
					private String clientSecret;
					private List<String> grantTypes;
					private List<String> scopes;
					// getters/setters
				}
			}
		åˆå§‹åŒ–è¨»å†Šï¼š
			@Bean
			CommandLineRunner registerClients(
				RegisteredClientRepository repo,
				AuthClientProperties authClientProps,
				PasswordEncoder encoder
			) {
				return args -> {
					for (var c : authClientProps.getClients()) {
						if (repo.findByClientId(c.getClientId()) != null) continue;

						RegisteredClient client = RegisteredClient.withId(UUID.randomUUID().toString())
							.clientId(c.getClientId())
							.clientSecret(encoder.encode(c.getClientSecret()))
							.scopes(sc -> sc.addAll(c.getScopes()))
							.authorizationGrantTypes(gt ->
								c.getGrantTypes().forEach(type ->
									gt.add(AuthorizationGrantType.from(type)))
							)
							.build();

						repo.save(client);
					}
				};
			}
		âœ… å¥½è™•
			CI/CD å¯é›†ä¸­æ§åˆ¶å“ªäº› client æœ‰å“ªäº› scope

			Config ç¶­è­·æ¸…æ™°ã€å¯ç‰ˆæœ¬æ§åˆ¶

			æ–° client / scope åŠ å…¥æ™‚ç„¡éœ€æ”¹ç¨‹å¼ï¼Œåªéœ€ä¿®æ”¹ YAML


Q:application.yml æœ‰ issuer-uriã€jwk-set-uri ä¹‹åˆ†å·®ç•°?
	spring:
	  security:
		oauth2:
		  resourceserver:
			jwt:
			  issuer-uri: https://auth.example.com
			  #jwk-set-uri: https://auth.example.com/oauth2/jwks


A:é€™æ˜¯ Spring Security è‡ªå‹•åŒ–é…ç½® JWT é©—è­‰çš„æ–¹å¼ä¹‹ä¸€ã€‚é€™è£¡çš„ issuer-uri å’Œ jwk-set-uri éƒ½æ˜¯ç”¨ä¾†å‘Šè¨´ Spring Security å¦‚ä½•å–å¾— JWT çš„é©—è­‰è³‡è¨Šï¼ˆä¾‹å¦‚å…¬é–‹é‡‘é‘°ï¼‰ï¼Œ
	ä½†å®ƒå€‘çš„å·®ç•°å¦‚ä¸‹ï¼š

	ğŸ” issuer-uri vs jwk-set-uri å·®ç•°
		| é …ç›®     | `issuer-uri`                                    | `jwk-set-uri`                                                 |
		| -------- | ----------------------------------------------- | ------------------------------------------------------------- |
		| æ„åœ–     | æŒ‡å‘ OAuth2 æˆæ¬Šä¼ºæœå™¨çš„ **ç™¼è¡Œè€…è­˜åˆ¥ URI**     | ç›´æ¥æŒ‡å®š JWT é©—è­‰ç”¨çš„ JWK å…¬é‘°åˆ—è¡¨ URL                        |
		| é©ç”¨å ´æ™¯ | Spring Security è‡ªå‹•æ ¹æ“š OIDC metadata ç™¼ç¾è¨­å®š | ç•¶ä½ æƒ³**æ˜ç¢ºæŒ‡å®šé‡‘é‘°ä½ç½®**æˆ–ä½ çš„æœå‹™**ä¸æä¾› OIDC metadata**  |
		| ç¯„ä¾‹     | `https://auth.example.com`                      | `https://auth.example.com/.well-known/jwks.json`              |
		| é¡å¤–å¥½è™• | å¯æ”¯æ´æ›´å¤šè‡ªå‹•è¨­å®šï¼ˆaudienceã€introspection ç­‰ï¼‰| åƒ…é™æ–¼å–å¾—å…¬é‘°æ¸…å–®                                            |

	ç•¶ä½ çš„ Auth Server æœ‰æ”¯æ´ OpenID Connect metadataï¼ˆä¾‹å¦‚ï¼š
		https://auth.example.com/.well-known/openid-configurationï¼‰ï¼ŒSpring Security æœƒå¾ä¸­è‡ªå‹•æ‰¾å‡ºï¼š
			jwks_uri
			issuer
			introspection_endpoint
			userinfo_endpoint
			...
		
		ç¢ºèªæ˜¯å¦æ”¯æ´
			curl http://localhost:9000/auth-server/.well-known/openid-configuration | jq 
		
	ğŸ›  ä½¿ç”¨ jwk-set-uriï¼ˆç•¶ Auth Server æ²’æ”¯æ´ OIDCï¼‰
		* é©åˆè‡ªå·±å®¢è£½çš„ Authorization Server
		* æˆ– Auth Server æ²’æœ‰æä¾› .well-known/openid-configuration
		
		
	âœ… çµè«–
		* å„ªå…ˆä½¿ç”¨ issuer-uriï¼Œå‰ææ˜¯ä½ çš„ Auth Server æœ‰æ”¯æ´ OpenID Connect Discoveryã€‚

		* è‹¥ä½ æ‰‹å‹•æä¾›é‡‘é‘°ä½ç½®æˆ– Auth Server æ²’æœ‰ metadataï¼Œå‰‡ä½¿ç”¨ jwk-set-uriã€‚
		
		
çµ±ä¸€å‰ç«¯æ©Ÿå™¨ webClient åˆ° starter => gateway
	import org.springframework.boot.autoconfigure.security.oauth2.client.OAuth2ClientProperties;
	import org.springframework.context.annotation.Bean;
	import org.springframework.context.annotation.Configuration;
	import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;
	import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;
	import org.springframework.security.oauth2.client.web.reactive.function.client.ServletOAuth2AuthorizedClientExchangeFilterFunction;
	import org.springframework.web.reactive.function.client.WebClient;

	@Configuration
	public class FrontEndWebClientConfiguration {
		@Bean
		WebClient webClient(final ClientRegistrationRepository clients, final OAuth2ClientProperties oAuth2ClientProperties,
				final OAuth2AuthorizedClientRepository authClients) {
			final ServletOAuth2AuthorizedClientExchangeFilterFunction oauth2 = new ServletOAuth2AuthorizedClientExchangeFilterFunction(
					clients, authClients);
			// final Map<String, Registration> map =
			// oAuth2ClientProperties.getRegistration();
			// final Registration registration = map.get("jwt-client");

			oauth2.setDefaultClientRegistrationId("hello-client");
			return WebClient.builder() //
					.apply(oauth2.oauth2Configuration()) // è‡ªå‹•åŠ  Authorization header
					// .filter(logRequest()) // log æˆ– traceId æ”œå¸¶ï¼Œç”¨ä¾è³´ micrometer-tracing-bridge-brave è‡ªå‹•è™•ç†
					// .filter(handleGatewayError()) // çµ±ä¸€éŒ¯èª¤è™•ç†
					// .clientConnector(createConnectorWithTimeout()) // timeout è¨­å®š
					.build();
		}
	}


	ğŸ”§ éŒ¯èª¤è™•ç† Filterï¼ˆä¾‹å¦‚çµ±ä¸€åŒ…è£ gateway éŒ¯èª¤ï¼‰
		private ExchangeFilterFunction handleGatewayError() {
			return ExchangeFilterFunction.ofResponseProcessor(response -> {
				if (response.statusCode().isError()) {
					return response.bodyToMono(String.class)
							.defaultIfEmpty("Unknown error")
							.flatMap(body -> {
								return Mono.error(new RuntimeException("Gateway error: " + body));
							});
				} else {
					return Mono.just(response);
				}
			});
		}

	â± å»ºç«‹ Timeout è¨­å®šç”¨çš„ clientConnector
		private ReactorClientHttpConnector createConnectorWithTimeout() {
			HttpClient httpClient = HttpClient.create()
				.responseTimeout(Duration.ofSeconds(5))   // ä¼ºæœå™¨å›æ‡‰è¶…æ™‚
				.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 3000); // TCP é€£ç·š timeout

			return new ReactorClientHttpConnector(httpClient);
		}

	ğŸ” è‹¥ä½ è¦åŠ  Retry
		webClient.get()
			.uri("/api/xxx")
			.retrieve()
			.bodyToMono(MyResult.class)
			.retryWhen(Retry.backoff(3, Duration.ofMillis(500)))
