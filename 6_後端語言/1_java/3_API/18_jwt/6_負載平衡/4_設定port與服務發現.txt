ref ChatGPT

Q:å¦‚æœæˆ‘ç”¨ spring-cloud-starter-loadbalancer é€™æ¨£æ¯å€‹å¾Œç«¯è¦è¨­å®š port è¦éŒ¯é–‹
	ä¹‹å‰éƒ½æ˜¯é€é apache å¹«æˆ‘å°å¤–å°å…§è½‰æ›ï¼Œæœ¬æ©Ÿé›–ç„¶å¯ä»¥è‡ªå·±è¨­å®š port ï¼Œä½†å¯¦éš›ç’°å¢ƒè¨­å®šçš„port ä¸æœƒæ˜¯é€™æ¨£

A:ğŸ¯ å•é¡Œé‡é»ä½ å·²æŒæ¡ï¼š
	ä½¿ç”¨ spring-cloud-starter-loadbalancer æ™‚ï¼Œæ¯å€‹å¯¦ä¾‹è¦åœ¨ä¸åŒ port å•Ÿå‹•æ‰èƒ½è¢«è¾¨è­˜ç‚ºä¸åŒå¯¦ä¾‹ã€‚
	ä½†å¯¦éš›éƒ¨ç½²æ™‚ï¼š

		* ä¸æœƒé  port å€åˆ†ï¼ˆé€šå¸¸éƒ½è·‘åœ¨ 8080 æˆ–å®¹å™¨å…§å›ºå®š portï¼‰

		* æ˜¯é  ä¸»æ©Ÿä½å€ï¼ˆhost/IPï¼‰+ åŸ å£ï¼Œæˆ–åœ¨å®¹å™¨ä¸­é  Kubernetes Service / Eureka metadata ä¾†è­˜åˆ¥å¯¦ä¾‹

	âœ… å°æ¯”ç’°å¢ƒå·®ç•°
		| ç’°å¢ƒ         | è­˜åˆ¥å¯¦ä¾‹æ–¹å¼                          | å¯¦å‹™è™•ç†æ–¹å¼                              |
		| ------------ | ------------------------------------- | ----------------------------------------- |
		| ğŸ–¥ï¸ æœ¬æ©Ÿæ¨¡æ“¬  | å¤šå€‹ portï¼ˆ8081, 8082, 8083ï¼‰         | æ‰‹å‹•è¨­å®š `server.port`                    |
		| â˜ï¸ ç”Ÿç”¢éƒ¨ç½²  | ç›¸åŒ portï¼ˆ8080ï¼‰ä½†ä¸åŒä¸»æ©Ÿæˆ–å®¹å™¨ IP  | ç”± Eureka / K8s è¨»å†Šè³‡è¨Šæ±ºå®šå¯¦ä¾‹ä½å€      |
		| ğŸ§© K8s ä¸­    | ç›¸åŒ portï¼ŒPod åç¨±ä¸åŒ               | K8s Service é€é selector + DNS è¼ªè©¢èª¿åº¦  |


	âœ… æ‰€ä»¥æœ¬æ©Ÿæ¨¡æ“¬èˆ‡å¯¦éš›å·®ç•°æ€éº¼è§£æ³•ï¼Ÿ
		âœ… è§£æ³• 1ï¼šæœ¬æ©Ÿç”¨ä¸åŒ port æ¸¬è©¦å³å¯
			é€™æ˜¯æœ€ç°¡å–®æ–¹å¼ï¼Œç”¨ YAML profile æ§åˆ¶æ¯å€‹å¯¦ä¾‹å•Ÿä¸åŒ portã€‚
				server:
				  port: 8081
				spring:
				  application:
					name: backend-service

			å¦ä¸€å¯¦ä¾‹å•Ÿ 8082ï¼Œå³å¯æ¨¡æ“¬å¤šå¯¦ä¾‹è² è¼‰å¹³è¡¡ã€‚

		âœ… è§£æ³• 2ï¼šå¯¦éš›éƒ¨ç½²é  Eureka / K8s / Docker å‹•æ…‹å¯¦ä¾‹è¨»å†Š
			å¯¦å‹™ä¸Šä½ ä¸éœ€è¦æŒ‡å®š portï¼Œåªè¦å•Ÿå‹•æ™‚ Eureka è‡ªå‹•è¨»å†Š host:portï¼š
				eureka:
				  instance:
					prefer-ip-address: true
					instance-id: ${spring.application.name}:${spring.cloud.client.ip-address}:${server.port}

						* åœ¨ K8s ä¸­ï¼Œä¸€å€‹ Deployment + å¤šå€‹ Podï¼Œæ¯å€‹ Pod ç”¨ localhost:8080 + IP å€åˆ†

						* Eureka è‡ªå‹•è¨»å†Šé€™äº›å¯¦ä¾‹ï¼Œè®“ LoadBalancer è² è²¬èª¿åº¦

		âœ… è§£æ³• 3ï¼šä½ ä»å¯çµåˆ Apacheï¼Œåƒ…ç”¨ WebClient æ§åˆ¶ headerã€failoverï¼Œä½†å¯¦éš›å¯¦ä¾‹ç”¨ Apache é…è½‰ç™¼
			ä¸éé€™ç¨®æ–¹å¼ä¸‹å°±ä¸å»ºè­°å†ç”¨ Spring Cloud LoadBalancer äº†ï¼Œå› ç‚ºä½ å·²æŠŠå¯¦ä¾‹ routing äº¤çµ¦ Apacheã€‚

	ğŸ§  ç¸½çµç­–ç•¥å»ºè­°ï¼š
		| ç›®çš„                                                             | å»ºè­°åšæ³•                                                     |
		| ---------------------------------------------------------------- | ------------------------------------------------------------ |
		| âœ… æœ¬æ©Ÿæ¸¬è©¦å¤šå¯¦ä¾‹                                                | ç”¨ä¸åŒ port æ¨¡æ“¬                                             |
		| âœ… ä¸Šç·šéƒ¨ç½²å¯¦ä¾‹                                                  | æ¯å°è·‘åŒæ¨£ portï¼Œé ä¸»æ©Ÿ IP + Eureka åšå¯¦ä¾‹è­˜åˆ¥               |
		| âœ… ä¸æƒ³è‡ªå·±é… port ç®¡ç†                                          | ç”¨å®¹å™¨ï¼ˆDocker/K8sï¼‰è·‘ï¼Œè®“å¹³å°å¹«ä½ åˆ†é…                       |
		| âŒ å¦‚æœå¯¦ä¾‹éƒ½è¢« Apache åŒ…èµ·ä¾†ã€LoadBalancer target æ˜¯ Apache URI | ä¸å»ºè­°ç”¨ Spring Cloud LoadBalancerï¼Œå› ç‚ºå®ƒå·²ç„¡æ³•æ§åˆ¶ä¸‹æ¸¸å¯¦ä¾‹ |

	âœ… æœ€å¾Œçµè«–ä¸€å¥è©±ï¼š
		Spring Cloud LoadBalancer åœ¨æœ¬æ©Ÿç”¨ port æ¨¡æ“¬æ²’å•é¡Œï¼Œ
		å¯¦éš›éƒ¨ç½²æ™‚æœƒé  ä¸»æ©Ÿ IP + port è¨»å†Šåˆ° Eureka æˆ– Service Discoveryï¼Œä¸éœ€ä½ æ‰‹å‹•åˆ† portã€‚
		å¦‚æœä½ å¯¦ä¾‹éƒ½èµ° Apache Reverse Proxyï¼Œå°±è©²è®“ Apache åšè² è¼‰å¹³è¡¡ï¼Œè€Œä¸æ˜¯ LoadBalancer å»é¸ Apache è·¯ç”± URIã€‚


# âœ… æœ¬æ©Ÿæ¨¡æ“¬å¤šåŸ å¤šå¯¦ä¾‹é…ç½®ï¼ˆapplication-local.ymlï¼‰

	spring:
	  application:
		name: backend-service
	  profiles:
		active: local

	---
	# profile: instance1
	spring:
	  config:
		activate:
		  on-profile: instance1
	server:
	  port: 8081

	---
	# profile: instance2
	spring:
	  config:
		activate:
		  on-profile: instance2
	server:
	  port: 8082

	---
	# âœ… Spring Cloud LoadBalancer éœæ…‹å¯¦ä¾‹æ¨¡å¼ï¼ˆfrontend-serviceï¼‰
	spring:
	  cloud:
		loadbalancer:
		  clients:
			backend-service:
			  instances:
				- uri: http://localhost:8081
				- uri: http://localhost:8082

	---

	# âœ… å¯¦éš›éƒ¨ç½²ç”¨ Eureka æ¨¡å¼é…ç½®ï¼ˆapplication-prod.ymlï¼‰
	spring:
	  application:
		name: backend-service
	  profiles:
		active: prod
	server:
	  port: 8080

	eureka:
	  client:
		service-url:
		  defaultZone: http://eureka-server:8761/eureka/
	  instance:
		prefer-ip-address: true
		instance-id: ${spring.application.name}:${spring.cloud.client.ip-address}:${server.port}

âœ… æˆ‘å·²ç‚ºä½ æº–å‚™å¥½æœ¬æ©Ÿèˆ‡å¯¦éš›éƒ¨ç½²ç’°å¢ƒä¸‹ä½¿ç”¨ Spring Cloud LoadBalancer çš„ YAML é…ç½®æ¨¡æ¿ï¼ŒåŒ…æ‹¬ï¼š

	æœ¬æ©Ÿå¤šå¯¦ä¾‹å•Ÿå‹•ï¼ˆç”¨ port æ¨¡æ“¬ï¼‰

	WebClient LoadBalancer éœæ…‹å¯¦ä¾‹è¨»å†Š

	å¯¦éš›ç’°å¢ƒ Eureka è¨»å†Šå¯¦ä¾‹è¨­å®š

	ä½ å¯ä»¥ç”¨ --spring.profiles.active=instance1 / instance2 åŒæ™‚å•Ÿå¤šå°ä¾†æ¨¡æ“¬æœ¬æ©Ÿè² è¼‰æ¸¬è©¦ï¼Œæ­£å¼éƒ¨ç½²æ™‚åªè¦æ”¹ç”¨ prod profileï¼Œå³å¯è‡ªå‹•è¨»å†Šè‡³ Eurekaã€‚

ç¨‹å¼å‘¼å«
	# âœ… WebClient Builder è¨»å†Šç‚º LoadBalanced Bean

	# WebClientConfig.java
	@Configuration
	public class WebClientConfig {

		@Bean
		@LoadBalanced
		public WebClient.Builder loadBalancedWebClientBuilder() {
			return WebClient.builder();
		}

	}

	---

	# âœ… ä½¿ç”¨ç¯„ä¾‹ï¼šé€é serviceId å‘¼å« backend-service

	@Service
	public class BackendClient {

		private final WebClient webClient;

		public BackendClient(WebClient.Builder builder) {
			this.webClient = builder.build();
		}

		public String callBackend() {
			return webClient.get()
					.uri("http://backend-service/api/hello")
					.retrieve()
					.bodyToMono(String.class)
					.block();
		}
	}