åŸ·è¡Œæ¦‚è¦ç›®æ¨™: client A æ‰“ api header with åˆ° client B
	client A
		1.è¨­å®š auth server åœ¨å“ª(application.yml)
		2.ç™¼èµ·è«‹æ±‚åˆ° å¾ AUTH server å–å¾— jwt
		3.ç™¼èµ·è«‹æ±‚åˆ° client B api with jwt
	client B
		1.client B è¨­å®š è®“ Spring Security çŸ¥é“ Auth Serverï¼ˆJWT ç™¼è¡Œè€…ï¼‰ (application.yml)
		2.ä¸¦åœ¨ client B api åƒæ•¸æœ‰ @AuthenticationPrincipal Jwt jwtï¼Œå‰‡ client B æ”¶åˆ°æœƒè‡ªè¡Œè‡ªå‹•é©—è­‰ jwt

client A
	1.è¨­å®š auth server åœ¨å“ª(application.yml)
		client-b:
		  api-url: http://localhost:8082/api
		spring:
		  security:
			oauth2:
			  client:
				registration:
				  keycloak:
					provider: keycloak
					client-id: client-a
					client-secret: my-secret
					authorization-grant-type: client_credentials
				provider:
				  keycloak:
					token-uri: http://localhost:8080/realms/myrealm/protocol/openid-connect/token
		é€™æ¨£ Spring Security çŸ¥é“ Auth Serverï¼ˆKeycloakï¼‰åœ¨å“ªè£¡ï¼Œæœƒè‡ªå‹•å¹«ä½ å–å¾— JWTï¼
	2.ç™¼èµ·è«‹æ±‚åˆ° å¾ AUTH server å–å¾— jwt
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-oauth2-client</artifactId>
		</dependency>
		Client A ç›´æ¥ä½¿ç”¨ OAuth2AuthorizedClientService å–å¾— JWT
			import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
			import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;
			import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;
			import org.springframework.security.oauth2.client.authentication.OAuth2AuthorizationContext;
			import org.springframework.security.oauth2.core.OAuth2AccessToken;
			import org.springframework.stereotype.Service;
			import org.springframework.web.client.RestTemplate;
			import org.springframework.http.*;

			@Service
			public class ClientAService {

				private final OAuth2AuthorizedClientManager authorizedClientManager;

				public ClientAService(OAuth2AuthorizedClientManager authorizedClientManager) {
					this.authorizedClientManager = authorizedClientManager;
				}

				public String getAccessToken() {
					OAuth2AuthorizedClient authorizedClient = authorizedClientManager.authorize(
							OAuth2AuthorizationContext.withClientRegistrationId("keycloak").principal("client-a").build());

					if (authorizedClient == null || authorizedClient.getAccessToken() == null) {
						throw new IllegalStateException("Unable to obtain access token.");
					}

					return authorizedClient.getAccessToken().getTokenValue();
				}

				public String callClientBApi() {
					String jwtToken = getAccessToken(); // è®“ Spring Security è‡ªå‹•ç®¡ç† JWT

					String clientBApiUrl = "http://localhost:8082/api/orders";  // Client B API
					RestTemplate restTemplate = new RestTemplate();
					HttpHeaders headers = new HttpHeaders();
					headers.set("Authorization", "Bearer " + jwtToken);

					HttpEntity<String> request = new HttpEntity<>(headers);
					ResponseEntity<String> response = restTemplate.exchange(clientBApiUrl, HttpMethod.GET, request, String.class);

					return response.getBody();
				}
			}


	3.ç™¼èµ·è«‹æ±‚åˆ° client B api with jwt
		ä½¿ç”¨ Spring Cloud OpenFeignï¼ˆæ¨è–¦ï¼Œé¿å…æ‰‹å¯« HTTP è«‹æ±‚ï¼‰
			<dependency>
				<groupId>org.springframework.cloud</groupId>
				<artifactId>spring-cloud-starter-openfeign</artifactId>
			</dependency>
		å®šç¾© Feign Clientï¼ˆå‹•æ…‹è«‹æ±‚ Client B APIï¼‰
			import org.springframework.cloud.openfeign.FeignClient;
			import org.springframework.web.bind.annotation.GetMapping;

			@FeignClient(name = "clientB", url = "${client-b.api-url}")
			public interface ClientBFeignClient {

				@GetMapping("/api/orders")
				String getOrders();
			}
		ç°¡åŒ–è®Šæˆ
			import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;
			import org.springframework.security.oauth2.client.authentication.OAuth2AuthorizationContext;
			import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
			import org.springframework.security.oauth2.core.OAuth2AccessToken;
			import org.springframework.stereotype.Service;

			@Service
			public class ClientAService {

				private final OAuth2AuthorizedClientManager authorizedClientManager;
				private final ClientBFeignClient clientBFeignClient;

				public ClientAService(OAuth2AuthorizedClientManager authorizedClientManager, ClientBFeignClient clientBFeignClient) {
					this.authorizedClientManager = authorizedClientManager;
					this.clientBFeignClient = clientBFeignClient;
				}

				public String getAccessToken() {
					OAuth2AuthorizedClient authorizedClient = authorizedClientManager.authorize(
							OAuth2AuthorizationContext.withClientRegistrationId("keycloak").principal("client-a").build());

					if (authorizedClient == null || authorizedClient.getAccessToken() == null) {
						throw new IllegalStateException("Unable to obtain access token.");
					}

					return authorizedClient.getAccessToken().getTokenValue();
				}

				public String callClientBApi() {
					String jwtToken = getAccessToken();
					return clientBFeignClient.getOrders(); // é€é Feign å‘¼å« Client B API
				}
			}
			Feign æœƒè‡ªå‹•å¹«ä½ è™•ç† HTTP è«‹æ±‚ï¼Œé¿å…æ‰‹å¯« RestTemplateï¼Œè€Œä¸” URL æ˜¯å‹•æ…‹çš„ï¼

		è®“ Feign Client å¸¶ä¸Š JWT
			æ–¹æ³• 1ï¼šä½¿ç”¨ Feign Request Interceptorï¼ˆæ¨è–¦ï¼‰
				é€é RequestInterceptor è‡ªå‹•ç‚ºæ‰€æœ‰ Feign è«‹æ±‚åŠ ä¸Š JWTï¼Œé€™æ¨£ Feign Client å°±èƒ½å¤ å¸¶ JWT è«‹æ±‚ Client B APIï¼
					import feign.RequestInterceptor;
					import feign.RequestTemplate;
					import org.springframework.context.annotation.Bean;
					import org.springframework.security.oauth2.client.OAuth2AuthorizedClient;
					import org.springframework.security.oauth2.client.OAuth2AuthorizedClientManager;
					import org.springframework.security.oauth2.client.authentication.OAuth2AuthorizationContext;
					import org.springframework.security.oauth2.core.OAuth2AccessToken;
					import org.springframework.stereotype.Component;

					@Component
					public class FeignClientInterceptor implements RequestInterceptor {

						private final OAuth2AuthorizedClientManager authorizedClientManager;

						public FeignClientInterceptor(OAuth2AuthorizedClientManager authorizedClientManager) {
							this.authorizedClientManager = authorizedClientManager;
						}

						@Override
						public void apply(RequestTemplate requestTemplate) {
							String jwtToken = getAccessToken(); // å–å¾— JWT Token
							requestTemplate.header("Authorization", "Bearer " + jwtToken); // è¨­å®š Header
						}

						private String getAccessToken() {
							OAuth2AuthorizedClient authorizedClient = authorizedClientManager.authorize(
									OAuth2AuthorizationContext.withClientRegistrationId("keycloak").principal("client-a").build());

							if (authorizedClient == null || authorizedClient.getAccessToken() == null) {
								throw new IllegalStateException("Unable to obtain access token.");
							}

							return authorizedClient.getAccessToken().getTokenValue();
						}
					}
			æ–¹æ³• 2ï¼šæ‰‹å‹•å‚³é JWT
				import org.springframework.cloud.openfeign.FeignClient;
				import org.springframework.web.bind.annotation.GetMapping;
				import org.springframework.web.bind.annotation.RequestHeader;

				@FeignClient(name = "clientB", url = "${client-b.api-url}")
				public interface ClientBFeignClient {
					@GetMapping("/api/orders")
					String getOrders(@RequestHeader("Authorization") String authorization);
				}

				public class ClientAService {
					....
					public String callClientBApi() {
						String jwtToken = "Bearer " + getAccessToken();  // å–å¾— JWT Token
						return clientBFeignClient.getOrders(jwtToken); // æ‰‹å‹•å‚³é Token
					}
				}

		å¦‚ä½•åœ¨ç·¨è­¯æœŸï¼ˆCompile Timeï¼‰ç™¼ç¾ API è®Šæ›´ï¼Ÿ
			å¦‚æœä½ çš„éœ€æ±‚æ˜¯ åœ¨ç·¨è­¯æœŸï¼ˆCompile Timeï¼‰å°±èƒ½ç™¼ç¾ Client B API çš„ URL è®Šæ›´
				æ–¹æ³• 1ï¼šå®šç¾© API æ¥å£ï¼Œè®“ Client A & Client B å…±äº«
					ä½¿ç”¨ interface ä¾†çµ±ä¸€ API å®šç¾©ï¼Œè®“ Client A å’Œ Client B éƒ½å¼•ç”¨ç›¸åŒçš„ API æè¿°ï¼
						package com.example.common.api;

						import org.springframework.web.bind.annotation.GetMapping;
						import org.springframework.web.bind.annotation.RequestMapping;
						import org.springframework.web.bind.annotation.RestController;

						@RequestMapping("/api/orders")
						public interface OrderApi {

							@GetMapping
							String getOrders();
						}
						é€™æ¨£ API çš„å®šç¾©æ˜¯å…±ç”¨çš„ï¼ŒClient A å’Œ Client B éƒ½è¦å¼•ç”¨é€™å€‹ common-apiï¼
					Client B ä¸­å¯¦ä½œé€™å€‹ API
						@RestController
						public class ClientBController implements OrderApi {

							@Override
							public String getOrders() {
								return "Orders from Client B";
							}
						}
					 Client A çš„ Feign Client ä½¿ç”¨ OrderApi
						import org.springframework.cloud.openfeign.FeignClient;
						import com.example.common.api.OrderApi;

						@FeignClient(name = "clientB", url = "${client-b.api-url}")
						public interface ClientBFeignClient extends OrderApi {
						}
				æ–¹æ³• 2ï¼šä½¿ç”¨ Eureka / Consul æœå‹™è¨»å†Šç™¼ç¾
					å¦‚æœ Client B API è®Šæ›´ï¼Œè®“ Client A è‡ªå‹•ç™¼ç¾æ–°çš„ API ä½å€ï¼Œè€Œä¸éœ€è¦æ‰‹å‹•è¨­å®š URLï¼
						Client B åœ¨ Eureka è¨»å†Š
							spring:
							  application:
								name: client-b
							  cloud:
								discovery:
								  enabled: true
								eureka:
								  client:
									service-url:
									  defaultZone: http://localhost:8761/eureka/
						Client A ä½¿ç”¨ Eureka è¨»å†Šçš„åç¨±ä¾†èª¿ç”¨ Feign
							@FeignClient(name = "client-b")
							public interface ClientBFeignClient extends OrderApi {
							}
							é€™æ¨£ Spring Cloud æœƒè‡ªå‹•æ‰¾åˆ° client-b çš„æœ€æ–° URLï¼Œç„¡éœ€æ‰‹å‹•é…ç½®ï¼
				æ–¹æ³• 3ï¼šä½¿ç”¨ OpenAPI + Code Generation
					... ç•¥
		æœ€ä½³æ–¹å¼æ˜¯ï¼š
			ä½¿ç”¨ æ–¹æ³• 1ï¼ˆå…±ç”¨ API ä»‹é¢ï¼‰ ä¾†ç¢ºä¿ API ç°½åä¸€è‡´ï¼ˆç·¨è­¯æœŸæª¢æŸ¥ï¼‰
			æ­é… æ–¹æ³• 2ï¼ˆEurekaï¼‰ ä¾†é¿å… Client A éœ€è¦æ‰‹å‹•ä¿®æ”¹ URLï¼ˆåŸ·è¡ŒæœŸç™¼ç¾ï¼‰


client B
	1.client B è¨­å®š è®“ Spring Security çŸ¥é“ Auth Serverï¼ˆJWT ç™¼è¡Œè€…ï¼‰ (application.yml)
		spring:
		  security:
			oauth2:
			  resourceserver:
				jwt:
				  issuer-uri: http://localhost:8080/realms/myrealm
		é€™æ¨£ Spring Security æœƒè‡ªå‹•é©—è­‰ JWTï¼Œç¢ºä¿ Token ä¾†è‡ªåˆæ³•çš„ Auth Serverï¼
	2.ä¸¦åœ¨ client B api åƒæ•¸æœ‰ @AuthenticationPrincipal Jwt jwtï¼Œå‰‡ client B æ”¶åˆ°æœƒè‡ªè¡Œè‡ªå‹•é©—è­‰ jwt
		@RestController
		@RequestMapping("/api")
		public class ClientBController {

			@GetMapping("/orders")
			public String getOrders(@AuthenticationPrincipal Jwt jwt) {
				String username = jwt.getClaim("sub");  // å–å¾— JWT å…§çš„ä½¿ç”¨è€…åç¨±
				return "Orders for: " + username;
			}
		}

		ğŸ“Œ ç•¶ Client A ç™¼è«‹æ±‚åˆ° /api/ordersï¼ŒSpring Security æœƒè‡ªå‹•é©—è­‰ JWT
		ğŸ“Œ å¦‚æœ JWT ç„¡æ•ˆï¼ŒSpring Security ç›´æ¥å›å‚³ 401 Unauthorizedï¼Œä¸æœƒåŸ·è¡Œ Controller
		ğŸ“Œ å¦‚æœ JWT æœ‰æ•ˆï¼Œ@AuthenticationPrincipal Jwt jwt æœƒè‡ªå‹•è§£æ JWTï¼Œè®“ API å–å¾—ç”¨æˆ¶è³‡è¨Šï¼