ref ChatGPT

æƒ…å¢ƒ4:å‰å¾Œç«¯ä¸²æµè½‰é€ä¸Šå‚³ï¼ˆstreaming proxyï¼‰ç¯„ä¾‹
	[ä½¿ç”¨è€… â†’ å‰ç«¯æœå‹™] â†’ Streaming Proxyï¼ˆä¸è½åœ°ï¼‰â†’ Resource Server æ¥æ”¶ä¸¦å„²å­˜

ğŸ“ 1. å‰ç«¯æœå‹™ Controllerï¼ˆå®Œå…¨ä¸²æµè½‰é€ï¼‰
	@RestController
	public class StreamingProxyController {

		private final WebClient webClient;

		public StreamingProxyController(WebClient webClient) {
			this.webClient = webClient;
		}

		@PostMapping("/upload")
		public ResponseEntity<String> proxyUpload(HttpServletRequest request) {
			String contentType = request.getContentType();

			return webClient.post()
				.uri("http://localhost:8081/api/files/upload")
				.header(HttpHeaders.CONTENT_TYPE, contentType)
				.body(BodyInserters.fromDataBuffers(DataBufferUtils.readInputStream(
					() -> request.getInputStream(),
					new DefaultDataBufferFactory(),
					8192)))
				.retrieve()
				.bodyToMono(String.class)
				.map(body -> ResponseEntity.ok("å¾Œç«¯å›æ‡‰ï¼š" + body))
				.block();
		}
	}
	ğŸ”¸ readInputStream() æœƒå°‡ ServletInputStream ç›´æ¥ä¸²æµè½‰æˆ WebClient å¯è®€çš„å…§å®¹
	ğŸ”¸ ä¿ç•™åŸæœ¬çš„ multipart/form-data çµæ§‹èˆ‡é‚Šç•Œï¼ˆboundaryï¼‰

ğŸ“ 2. Resource Server æ¥æ”¶æª”æ¡ˆï¼ˆæ¨™æº– Multipart æ¥æ”¶ï¼‰
	@PostMapping("/api/files/upload")
	public ResponseEntity<String> backendUpload(@RequestPart("file") MultipartFile file,
												@AuthenticationPrincipal Jwt jwt) throws IOException {
		String fileName = file.getOriginalFilename();
		System.out.println("âœ… æ”¶åˆ°æª”æ¡ˆ: " + fileName + "ï¼Œä¾†è‡ª client: " + jwt.getSubject());

		Path dest = Paths.get("/tmp/uploads/", fileName);
		file.transferTo(dest);

		return ResponseEntity.ok("æª”æ¡ˆå·²å„²å­˜ï¼š" + fileName);
	}


âœ… ç‰¹é»èˆ‡æ³¨æ„äº‹é …
	| å„ªé»         | èªªæ˜                                     |
	| ------------ | ---------------------------------------- |
	| âš¡ é«˜æ•ˆ      | ä¸ä½”è¨˜æ†¶é«”ã€ä¸å¯«è‡¨æ™‚æª”ï¼Œä½å»¶é²           |
	| â™»ï¸ ç„¡æš«å­˜    | ç„¡éœ€ GC æ¸…ç†ã€ç„¡æš«å­˜å¤¾çˆ†æ»¿é¢¨éšª           |
	| ğŸ” å®‰å…¨      | å¯æ’å…¥ JWT é©—è­‰ï¼Œå¼·åŒ–å‚³è¼¸éç¨‹å¯ä¿¡æ€§      |
	| ğŸ” é€æ˜è½‰ç™¼  | å‰ç«¯ä¸éœ€è¦çŸ¥é“æª”æ¡ˆå…§å®¹ï¼Œåªåš passthrough |


âš ï¸ æ³¨æ„äº‹é …
	| é …ç›®           | å»ºè­°                                                                    |
	| -------------- | ----------------------------------------------------------------------- |
	| Content-Type   | ä¸€å®šè¦è½‰é€åŸå§‹çš„ multipart/form-data + boundary                         |
	| HTTP Header    | `Content-Length` å¯çœç•¥ï¼ŒWebClient æœƒè™•ç†                               |
	| éŒ¯èª¤è™•ç†       | è«‹åŠ  `.onStatus(...)` èˆ‡ `.doOnError(...)` åšè™•ç†ï¼ˆé¿å… swallow errorï¼‰ |
	| æš´éœ² API       | æ­¤ Proxy API **åªé–‹æ”¾å¯ä¿¡ä¾†æºï¼ˆå¦‚å…§éƒ¨å‰ç«¯ï¼‰å‘¼å«**ï¼Œä¸æ‡‰ç›´æ¥çµ¦ä¸€èˆ¬ä½¿ç”¨è€… |


-------------------------------------------------------------------------
éŒ¯èª¤è™•ç†æ”¹è‰¯
-------------------------------------------------------------------------

åœ¨ä½ ç”¨ WebClient åšä¸²æµ proxyï¼ˆæˆ–ä»»ä½• HTTP å‘¼å«ï¼‰æ™‚ï¼Œå¦‚æœä¸è™•ç†éŒ¯èª¤ç‹€æ³ï¼ŒWebClient æœƒæŠŠéŒ¯èª¤ã€Œåƒæ‰ï¼ˆswallowï¼‰ã€ï¼Œè¡¨é¢ä¸Šç¨‹å¼è·‘å®Œäº†ï¼Œä½†ï¼š
	âŒ çœŸæ­£çš„ HTTP éŒ¯èª¤æ²’è¢«ä½ æ•æ‰ï¼ˆå¦‚ 401ã€500ã€404ï¼‰
	âŒ ä½¿ç”¨è€…åªçœ‹åˆ°ç©ºå›æ‡‰æˆ–æ³›ç”¨éŒ¯èª¤è¨Šæ¯
	âŒ ç„¡æ³• log è©³ç´°å¤±æ•—è³‡è¨Šï¼Œdebug å›°é›£

âœ… .onStatus(...) æ˜¯ç”¨ä¾†è™•ç†ã€Œå¾Œç«¯å›å‚³çš„ HTTP ç‹€æ…‹ç¢¼ç•°å¸¸ã€
	webClient.post()
		.uri("http://localhost:8081/api/files/upload")
		.header(HttpHeaders.CONTENT_TYPE, contentType)
		.body(BodyInserters.fromDataBuffers(
			DataBufferUtils.readInputStream(() -> request.getInputStream(), new DefaultDataBufferFactory(), 8192)))
		.retrieve()
		.onStatus(HttpStatusCode::isError, clientResponse -> {
			// å¾Œç«¯å› 4xx/5xx æ™‚è™•ç†
			return clientResponse.bodyToMono(String.class)
				.flatMap(errorBody -> {
					System.err.println("â— ä¸Šå‚³å¤±æ•—ï¼š" + errorBody);
					return Mono.error(new RuntimeException("å¾Œç«¯å›éŒ¯èª¤: " + errorBody));
				});
		})
		.bodyToMono(String.class)
		.doOnError(ex -> {
			// åŒ…å« onStatus ä¸­çš„éŒ¯èª¤ä¹Ÿæœƒé€²ä¾†
			System.err.println("ğŸ’¥ ç™¼ç”Ÿä¾‹å¤–ï¼š" + ex.getMessage());
		})
		.map(body -> ResponseEntity.ok("å¾Œç«¯å›æ‡‰ï¼š" + body))
		.block();

	1. .onStatus(...)
		ç”¨ä¾†æ””æˆª HTTP 4xxã€5xx çš„ responseï¼ˆå³ä¾¿ä¼ºæœå™¨å›æ‡‰äº†ï¼Œä½†ç‹€æ…‹ç¢¼ä¸æˆåŠŸï¼‰
		ä½ å¯ä»¥è®€å–éŒ¯èª¤ body ä¸¦åŒ…è£æˆ exception æ‹‹å‡ºï¼ˆè®“ä¸Šå±¤ doOnError æ¥æ‰‹ï¼‰

	2. .doOnError(...)
		æ•æ‰æ•´é«” WebClient pipeline ä¸­ç™¼ç”Ÿçš„æ‰€æœ‰éŒ¯èª¤ï¼ˆå«é€£ç·šéŒ¯èª¤ã€timeoutã€onStatus çš„éŒ¯èª¤ï¼‰
		å¯è¨˜ logã€é€šçŸ¥ã€æˆ–è£œå……éŒ¯èª¤è³‡è¨Š

	ğŸ§ª å°è£œå……ï¼šå¸¸è¦‹éŒ¯èª¤ä¾†æº
		| éŒ¯èª¤æƒ…å¢ƒ                              | æœƒè§¸ç™¼ `.onStatus` å—            | æœƒé€² `.doOnError` å— |
		| ------------------------------------- | -------------------------------- | -------------------- |
		| Resource Server å› 401 / 403 / 500    | âœ… æ˜¯                            | âœ… æ˜¯                |
		| URI éŒ¯èª¤ / é€£ä¸ä¸Šä¸»æ©Ÿ                 | âŒ å¦ï¼ˆå› ç‚º request æ ¹æœ¬æ²’ç™¼å‡ºï¼‰ | âœ… æ˜¯                |
		| å‚³æª”éç¨‹ IOException                  | âŒ å¦                            | âœ… æ˜¯                |

ä¸åŠ  .onStatus å’Œ .doOnErrorï¼š
	WebClient å¯èƒ½æœƒè®“ä½ ã€Œä»¥ç‚ºã€è«‹æ±‚æˆåŠŸï¼Œå…¶å¯¦å·²ç¶“æ˜¯ HTTP 500
	ä¾‹å¤–ä¸æ˜ç¢ºï¼Œé™¤éŒ¯èˆ‡ä½¿ç”¨è€…å›é¥‹éƒ½æœƒå›°é›£

âœ… å»ºè­°å¯¦å‹™ç¯„ä¾‹ï¼šçµ±ä¸€è™•ç†æ‰€æœ‰éŒ¯èª¤
	String result = webClient.post()
		...
		.retrieve()
		.onStatus(HttpStatusCode::isError, res -> res.bodyToMono(String.class)
			.flatMap(body -> Mono.error(new IllegalStateException("å¾Œç«¯éŒ¯èª¤ï¼š" + body))))
		.bodyToMono(String.class)
		.doOnError(e -> log.error("WebClient å‘¼å«å¤±æ•—: {}", e.getMessage(), e))
		.onErrorReturn("å¾Œç«¯ç„¡å›æ‡‰æˆ–éŒ¯èª¤")
		.block();
