ref ChatGPT


æƒ…å¢ƒ3:çœŸæ­£çš„ã€Œå…©æ®µå¼æª”æ¡ˆä¸Šå‚³ã€æµç¨‹ï¼š
	 [ä½¿ç”¨è€…] â†’ å‰ç«¯æœå‹™ï¼ˆæ¥æ”¶ MultipartFileï¼‰ â†’ è½åœ°æš«å­˜ç›®éŒ„
			â†’ åšä¸€äº›è™•ç†ï¼ˆå£“ç¸® / æƒæ¯’ / è½‰æ ¼å¼ / åŠ  metadataï¼‰
			â†’ ç”¨ WebClient å‚³é€è‡³å¾Œç«¯ Resource Server

æ­£è¦ä¸”ç©©å®šçš„è¨­è¨ˆæ¨¡å¼ï¼Œç‰¹åˆ¥é©ç”¨æ–¼ï¼š
	â± å»¶å¾Œä¸Šå‚³ï¼ˆasyncï¼‰
	ğŸ”’ é€²è¡Œå®‰å…¨æƒæ¯’ã€å£“ç¸®è™•ç†
	ğŸ“ åŠ å…¥æª”æ¡ˆç®¡ç† metadataï¼ˆå¦‚ç§Ÿæˆ¶ã€ä¾†æºç­‰ï¼‰

å‰ç«¯
	â˜• Controllerï¼šæ¥æ”¶ä½¿ç”¨è€…ä¸Šå‚³
		@RestController
		@RequestMapping("/upload")
		public class UploadController {

			private final FileRelayService fileRelayService;

			public UploadController(FileRelayService fileRelayService) {
				this.fileRelayService = fileRelayService;
			}

			@PostMapping
			public ResponseEntity<String> handleUpload(@RequestParam("file") MultipartFile file) throws IOException {
				// 1. è½åœ°è‡³æš«å­˜ç›®éŒ„
				Path tempPath = fileRelayService.saveToLocalTemp(file);

				// 2. åšé¡å¤–è™•ç†ï¼ˆç¯„ä¾‹ç‚ºå£“ç¸®ï¼‰
				Path processedPath = fileRelayService.processFile(tempPath);

				// 3. ä¸Šå‚³è‡³ Resource Server
				String result = fileRelayService.uploadToBackend(processedPath);

				return ResponseEntity.ok("æª”æ¡ˆè™•ç†ä¸¦ä¸Šå‚³æˆåŠŸ: " + result);
			}
		}

	â˜• Serviceï¼šè™•ç†æª”æ¡ˆä¸¦ä¸Šå‚³
		@Service
		public class FileRelayService {

			private final WebClient webClient;

			public FileRelayService(WebClient webClient) {
				this.webClient = webClient;
			}

			// 1 è½åœ°æª”æ¡ˆ
			public Path saveToLocalTemp(MultipartFile file) throws IOException {
				String filename = UUID.randomUUID() + "-" + file.getOriginalFilename();
				Path tempFile = Files.createTempFile("upload-", "-" + filename);
				file.transferTo(tempFile);
				return tempFile;
			}

			// 2 åšè™•ç†ï¼ˆç¯„ä¾‹ï¼šGzip å£“ç¸®ï¼‰
			public Path processFile(Path inputFile) throws IOException {
				Path outputFile = Files.createTempFile("processed-", ".gz");
				try (InputStream in = Files.newInputStream(inputFile);
					 GZIPOutputStream out = new GZIPOutputStream(Files.newOutputStream(outputFile))) {
					in.transferTo(out);
				}
				return outputFile;
			}

			// 3 ç”¨ WebClient ä¸Šå‚³
			public String uploadToBackend(Path processedFile) {
				Resource resource = new FileSystemResource(processedFile.toFile());

				return webClient.post()
					.uri("http://localhost:8081/api/files/upload")
					.contentType(MediaType.MULTIPART_FORM_DATA)
					.body(BodyInserters.fromMultipartData("file", resource))
					.retrieve()
					.bodyToMono(String.class)
					.block();
			}
		}

å¾Œç«¯ Resource Server
	@PostMapping("/api/files/upload")
	public ResponseEntity<String> handleBackendUpload(@RequestPart("file") MultipartFile file) throws IOException {
		// å­˜æª”æˆ–å¾ŒçºŒè™•ç†
		Path savePath = Paths.get("/data/uploaded/", file.getOriginalFilename());
		file.transferTo(savePath);

		return ResponseEntity.ok("å·²æ”¶åˆ°æª”æ¡ˆï¼š" + file.getOriginalFilename());
	}


âœ… åŠ å¼·é»ï¼ˆå¯é¸ï¼‰ï¼š
	| åŠŸèƒ½               | å¯¦ä½œæ–¹å¼                                                                |
	| ------------------ | ----------------------------------------------------------------------- |
	| ğŸ§¼ æƒæ¯’            | å‘¼å«ç¬¬ä¸‰æ–¹æƒæ¯’å¼•æ“ï¼ˆå¦‚ ClamAVï¼‰é©—è­‰å¾Œå†ä¸Šå‚³                             |
	| ğŸ“‚ å¤šç§Ÿæˆ¶è·¯å¾‘      | ç”¨ `clientId` or JWT ä¸­ `tenant` claim å»ºç«‹ `/tmp/{tenantId}/xxx.tmp`   |
	| ğŸ—‘ï¸ ä¸Šå‚³å¾Œæ¸…é™¤æš«å­˜  | å‘¼å« `Files.delete(tempPath)`                                           |
	| ğŸ“‹ åŠ ä¸Š metadata   | å¤šå‚³ä¸€å€‹æ¬„ä½ `description`ã€`tag`ï¼Œå¾Œç«¯ä¸€ä½µæ¥æ”¶è™•ç†                     |

| å„ªé»                                           | ç¼ºé»                                   |
| ---------------------------------------------- | -------------------------------------- |
| å¯é©—è­‰æª”æ¡ˆå®Œæ•´æ€§ã€åŸ·è¡Œæƒæ¯’ã€å£“ç¸®ã€åŠ ç°½åç­‰è™•ç† | æª”æ¡ˆ I/O æˆæœ¬è¼ƒé«˜ï¼Œéœ€è¦æ¸…ç†            |
| æ›´é©åˆä¼æ¥­ç³»çµ±ã€è³‡æ–™ä¿å…¨è¦æ±‚                   | è¼ƒé©åˆéåŒæ­¥æ‰¹æ¬¡ï¼Œä¸é©ç”¨å³æ™‚è¶…å¤§é‡ä¸Šå‚³ |


-------------------------------------------------------------------------------------------------------------
åŠ ä¸Š metadata  æ”¹è‰¯
-------------------------------------------------------------------------------------------------------------
ğŸ§¾ ç¯„ä¾‹ï¼šå‰ç«¯ä¸Šå‚³æ™‚åŒ…å« metadata
	MultipartBodyBuilder builder = new MultipartBodyBuilder();
	builder.part("file", new FileSystemResource(file));
	builder.part("description", "2025 Q1 æ¥­å‹™å ±è¡¨");
	builder.part("tag", "report");

	webClient.post()
		.uri("http://localhost:8081/api/files/upload")
		.contentType(MediaType.MULTIPART_FORM_DATA)
		.body(BodyInserters.fromMultipartData(builder.build()))
		.retrieve()
		.bodyToMono(String.class)
		.block();

	â˜• å¾Œç«¯ Controller æ¥æ”¶æ–¹å¼ï¼š
		@PostMapping("/api/files/upload")
		public ResponseEntity<String> handleUpload(
				@RequestPart("file") MultipartFile file,
				@RequestPart("description") String description,
				@RequestPart("tag") String tag,
				@AuthenticationPrincipal Jwt jwt) throws IOException {

			System.out.printf("ğŸ“„ æª”æ¡ˆ: %s, æè¿°: %s, æ¨™ç±¤: %s, ä¸Šå‚³è€…: %s%n",
				file.getOriginalFilename(), description, tag, jwt.getSubject());

			// å„²å­˜æª”æ¡ˆã€å¯«å…¥ metadata è³‡æ–™è¡¨ã€ç™¼é€é€šçŸ¥...

			return ResponseEntity.ok("æª”æ¡ˆèˆ‡ metadata ä¸Šå‚³æˆåŠŸ");
		}

	| æ¬„ä½                      | å¯¦å‹™ç”¨é€”                                       |
	| ------------------------- | ---------------------------------------------- |
	| `description`             | UI ä¸Šè®“ä½¿ç”¨è€…è¼¸å…¥ï¼Œæ–¹ä¾¿ç‡Ÿé‹äººå“¡è¾¨è­˜            |
	| `tag` / `type`            | æ±ºå®šè½‰æª”æ ¼å¼ï¼ˆå¦‚ `.doc` â†’ `.pdf`ï¼‰æˆ–æƒæ¯’æ”¿ç­–   |
	| `tenantId` / `systemId`   | å¤šç³»çµ±æ•´åˆï¼Œå„²å­˜å€åˆ†ä¸åŒæ¥­ä¸»è³‡æ–™               |
	| `referenceId`             | æª”æ¡ˆç¶å®šç‰¹å®šæ¥­å‹™æµç¨‹ï¼ˆå¦‚ç”³è«‹å–®ã€å ±è¡¨ã€è¡¨å–® IDï¼‰|
	| `notifyEmail`             | å¾Œç«¯ä¸Šå‚³å®Œæˆå¾Œè¦é€šçŸ¥çš„ email åœ°å€              |

æª”æ¡ˆåªæ˜¯ã€Œè³‡æ–™çš„ä¸»é«”ã€ï¼Œè€Œ metadata æ˜¯æª”æ¡ˆçš„ä¸Šä¸‹æ–‡ã€èªæ„ã€æŒ‡ä»¤ã€æ§åˆ¶è³‡è¨Šã€‚
	ç‰¹åˆ¥åœ¨ M2M æˆ–ä¼æ¥­ç³»çµ±ä¸­ï¼ŒåŠ ä¸Š metadata èƒ½è®“å¾Œç«¯ï¼š
	åšå°æ‡‰è³‡æ–™çš„ç¶å®šèˆ‡é‚è¼¯åˆ¤æ–·
	æ§åˆ¶å„²å­˜èˆ‡å¾Œè™•ç†ç­–ç•¥
	å¢å¼·å®‰å…¨æ€§èˆ‡ç¨½æ ¸èƒ½åŠ›

ğŸ¯ æ”¹è‰¯æ–¹æ¡ˆï¼šMultipart è«‹æ±‚ä¸­å‚³ã€Œæª”æ¡ˆ + JSON DTOã€
	ğŸ”§ å‰ç«¯ï¼šä½¿ç”¨ WebClient å‚³ Multipartï¼ˆåŒ…å«æª”æ¡ˆ + JSON metadataï¼‰
		MultipartBodyBuilder builder = new MultipartBodyBuilder();
		builder.part("file", new FileSystemResource(file));
		builder.part("meta", new ByteArrayResource(objectMapper.writeValueAsBytes(new FileMetadata())) {
			@Override
			public String getFilename() {
				return "metadata.json"; // ä¸åŠ ä¹Ÿè¡Œï¼Œé¿å… content-disposition å•é¡Œ
			}
		}).header("Content-Type", "application/json");

		webClient.post()
			.uri("http://localhost:8081/api/files/upload")
			.contentType(MediaType.MULTIPART_FORM_DATA)
			.body(BodyInserters.fromMultipartData(builder.build()))
			.retrieve()
			.bodyToMono(String.class)
			.block();

	â˜• DTO ç¯„ä¾‹ï¼š
		@Data
		public class FileMetadata {
			private String description;
			private String tag;
			private String referenceId;
		}
	â˜• å¾Œç«¯ï¼šä½¿ç”¨ @RequestPart("meta") FileMetadata meta
		@PostMapping("/api/files/upload")
		public ResponseEntity<String> handleUpload(
				@RequestPart("file") MultipartFile file,
				@RequestPart("meta") FileMetadata metadata,
				@AuthenticationPrincipal Jwt jwt) throws IOException {

			System.out.printf("ğŸ“¦ æª”æ¡ˆ: %s\nğŸ“‹ æè¿°: %s\nğŸ”– æ¨™ç±¤: %s\nğŸ” clientId: %s%n",
				file.getOriginalFilename(),
				metadata.getDescription(),
				metadata.getTag(),
				jwt.getSubject());

			return ResponseEntity.ok("æª”æ¡ˆèˆ‡ metadata DTO ä¸Šå‚³æˆåŠŸ");
		}

âœ… å„ªé»å°æ¯”
	| å‚³ä¸€å †æ¬„ä½ï¼ˆåŸå§‹æ–¹å¼ï¼‰  | ä½¿ç”¨ DTO + JSON                       |
	| ----------------------- | ------------------------------------- |
	| ç°¡å–®ã€ä¸éœ€é¡å¤–åºåˆ—åŒ–    | æ›´çµæ§‹åŒ–ã€æ˜“æ“´å……                      |
	| æ˜“é€ æˆ controller çˆ†é•·  | âœ… å¯å°è£ metadataã€å¯é©—è­‰ DTO çµæ§‹   |
	| é©åˆæ¬„ä½å°‘æƒ…å¢ƒ          | âœ… é©åˆæ¬„ä½å¤šã€éœ€ç‰ˆæœ¬æ§ç®¡ã€è¤‡é›œé‚è¼¯   |


-------------------------------------------------------------------------------------------------------------
éŒ¯èª¤è™•ç†æ”¹è‰¯  æ”¹è‰¯
-------------------------------------------------------------------------------------------------------------
âŒ ä¸è™•ç†éŒ¯èª¤æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ
	| å•é¡Œ                                          | èªªæ˜                                                       |
	| --------------------------------------------- | ---------------------------------------------------------- |
	| â›” WebClient å‘¼å«å¾Œç«¯ 500ï¼Œå‰ç«¯é‚„ä»¥ç‚ºä¸Šå‚³æˆåŠŸ | æœƒè®“ä½¿ç”¨è€…æˆ–ä¸Šæ¸¸æœå‹™ä»¥ç‚ºã€Œæ•´å€‹æµç¨‹æˆåŠŸã€ï¼Œå…¶å¯¦æª”æ¡ˆæ²’é€²å¾Œç«¯ |
	| ğŸ§¼ æª”æ¡ˆå·²è½åœ°ï¼Œä½†å› å¾Œç«¯å¤±æ•—æœªè¢«åˆªé™¤           | æœƒå°è‡´ temp folder é•·æœŸå †ç©åƒåœ¾æª”æ¡ˆ                        |
	| ğŸ”‡ æ²’ logã€æ²’éŒ¯èª¤è¨Šæ¯                         | éŒ¯èª¤è¢« swallowï¼Œdebug éå¸¸å›°é›£                             |

âœ… æ”¹é€²ç‰ˆï¼šåŠ ä¸Š .onStatus()ã€.doOnError()ã€æ¸…ç†æª”æ¡ˆ
	public String uploadToBackend(Path processedFile) {
		Resource resource = new FileSystemResource(processedFile.toFile());

		try {
			return webClient.post()
				.uri("http://localhost:8081/api/files/upload")
				.contentType(MediaType.MULTIPART_FORM_DATA)
				.body(BodyInserters.fromMultipartData("file", resource))
				.retrieve()
				.onStatus(HttpStatusCode::isError, res -> res.bodyToMono(String.class)
					.flatMap(body -> Mono.error(new IllegalStateException("å¾Œç«¯éŒ¯èª¤ï¼š" + body))))
				.bodyToMono(String.class)
				.doOnError(ex -> log.error("â— ä¸Šå‚³å¤±æ•—: {}", ex.getMessage(), ex))
				.block();
		} finally {
			try {
				Files.deleteIfExists(processedFile);
			} catch (IOException io) {
				log.warn("âš ï¸ ç„¡æ³•åˆªé™¤æš«å­˜æª”æ¡ˆ: {}", processedFile, io);
			}
		}
	}

ğŸ” å¯¦å‹™ä¸Šå»ºè­°åŠ å¼·é»ï¼š
	| é …ç›®                        | å»ºè­°                                    |
	| --------------------------- | --------------------------------------- |
	| âœ”ï¸ `.onStatus()`            | è™•ç† 4xx / 5xx å›æ‡‰éŒ¯èª¤ï¼ŒåŒ…æˆ exception |
	| âœ”ï¸ `.doOnError()`           | çµ±ä¸€ log æ‰€æœ‰éŒ¯èª¤è¨Šæ¯                   |
	| âœ”ï¸ `finally` å€å¡Šæ¸…é™¤æš«å­˜æª” | ä¸è«–æˆåŠŸæˆ–å¤±æ•—éƒ½è¦æ¸…ç†æª”æ¡ˆ              |
	| âœ”ï¸ å›å‚³æœ‰æ„ç¾©çš„éŒ¯èª¤è¨Šæ¯     | åŒ…å«å¾Œç«¯éŒ¯èª¤åŸå› ã€fileNameã€traceId ç­‰  |



-------------------------------------------------------------------------------------------------------------
ç©©å¥å‹ä¸Šå‚³ç³»çµ±è¨­è¨ˆ æ”¹è‰¯
-------------------------------------------------------------------------------------------------------------
* retry ç­–ç•¥ï¼ˆé‡è©¦ï¼‰
* Backoffï¼ˆå›é€€ï¼‰+ Timeoutï¼ˆé€¾æ™‚æ§åˆ¶ï¼‰
* æš«å­˜æ¸…ç†
* fallback æ©Ÿåˆ¶
å¿…é ˆè€ƒæ…®ï¼Œå¦å‰‡ç³»çµ±æœƒæœ‰æ½›åœ¨çš„ï¼š
	âŒ è³‡æ–™ä¸Ÿå¤±
	âŒ è¨˜æ†¶é«”æˆ–ç£ç¢Ÿçˆ†æ»¿
	âŒ èª¤åˆ¤æˆåŠŸ / å‡å¤±æ•—
	âŒ ç„¡æ³•æ¢å¾©

ğŸ” 1. Retry ç­–ç•¥ï¼ˆé‡è©¦ï¼‰
	âœ… ç”¨æ„ï¼š
		åœ¨èˆ‡å¾Œç«¯æˆ–é ç«¯æœå‹™é€šè¨Šæ™‚ï¼Œå¦‚æœé‡åˆ°æš«æ™‚æ€§å¤±æ•—ï¼ˆå¦‚ 500ã€è¶…æ™‚ã€ç¶²è·¯æ–·ç·šï¼‰ï¼Œç³»çµ±èƒ½è‡ªå‹•é‡è©¦è«‹æ±‚ï¼Œé¿å…ã€Œä¸€æ¬¡å¤±æ•—å°±æ•´å€‹æµç¨‹ä¸­æ–·ã€ã€‚
	ğŸ§± ç¯„ä¾‹æƒ…å¢ƒï¼š
		ä½ ä¸Šå‚³æª”æ¡ˆæ™‚å¾Œç«¯å‰›å¥½æ­£åœ¨é‡å•Ÿï¼Œç¬¬ä¸€æ¬¡å‘¼å«å¤±æ•—ï¼Œä½† 2 ç§’å¾Œå…¶å¯¦å¯ä»¥æˆåŠŸã€‚
	ğŸ›  å¯¦ä½œæ–¹å¼ï¼ˆWebClient æ­é… Reactor Retryï¼‰ï¼š
		.retryWhen(Retry.backoff(3, Duration.ofSeconds(2)))
			ä»£è¡¨ï¼šæœ€å¤šé‡è©¦ 3 æ¬¡ï¼Œæ¯æ¬¡é–“éš” 2 ç§’ï¼ŒæŒ‡æ•¸å›é€€

â±ï¸ 2. Backoffï¼ˆå›é€€ï¼‰+ Timeoutï¼ˆé€¾æ™‚æ§åˆ¶ï¼‰
	âœ… ç”¨æ„ï¼š
		é˜²æ­¢ä½ ä¸€ç›´ç«‹å³ç˜‹ç‹‚é‡è©¦ã€ç™±ç˜“å°æ–¹æœå‹™ï¼ˆDoS-likeï¼‰ï¼Œä¸¦ç¢ºä¿ä½ è‡ªå·±çš„å‘¼å«ä¹Ÿä¸æœƒå¡æ­»ã€‚
	ğŸ§± ç¯„ä¾‹æƒ…å¢ƒï¼š
		å¦‚æœå¾Œç«¯ timeout æ˜¯ 10 ç§’ï¼Œä½ å‰ç«¯æ²’æœ‰è¨­ timeoutï¼Œæ•´å€‹ servlet thread å°±æœƒå¡ä½ 10 ç§’ï¼Œé€ æˆå£“åŠ›ã€‚
	ğŸ›  å»ºè­°åšæ³•ï¼š
		.timeout(Duration.ofSeconds(10))
		.retryWhen(Retry.backoff(2, Duration.ofSeconds(3)))
			ä»£è¡¨ï¼šæœ€å¤šç­‰ 10 ç§’ï¼Œé‡è©¦ 2 æ¬¡ï¼Œæ¯æ¬¡ 3 ç§’é–“éš”

ğŸ§¼ 3. æš«å­˜æ¸…ç†
	âœ… ç”¨æ„ï¼š
		ä½ å…©æ®µå¼ä¸Šå‚³æ™‚ï¼Œå‰ç«¯æœƒæŠŠæª”æ¡ˆå…ˆ transferTo(tempFile) è½åœ°ã€‚è‹¥å¾Œç«¯ä¸Šå‚³å¤±æ•—æˆ–ä¾‹å¤–ç™¼ç”Ÿï¼Œé€™äº›æª”æ¡ˆå¦‚æœæ²’è¢«æ¸…é™¤ï¼Œæœƒä¸€ç›´æ®˜ç•™åœ¨ /tmp æˆ– /var/tmp ä¸‹ï¼Œæœ€çµ‚å°è‡´ç£ç¢Ÿçˆ†æ»¿ã€‚
	ğŸ›  å»ºè­°åšæ³•ï¼š
		finally {
			Files.deleteIfExists(tempFile);
		}

ğŸ›¡ 4. Fallback æ©Ÿåˆ¶
	âœ… ç”¨æ„ï¼š
		åœ¨æ‰€æœ‰å˜—è©¦ï¼ˆretry + timeoutï¼‰éƒ½å¤±æ•—æ™‚ï¼Œç³»çµ±ä»èƒ½æä¾›ã€Œæ¬¡ä½³çš„æ›¿ä»£è™•ç†ã€ï¼Œè€Œä¸æ˜¯æ•´å€‹ç‚¸æ‰ã€‚
	ğŸ§± å¯¦éš›åšæ³•ï¼š
		ğŸ‘‰ å„²å­˜å¤±æ•—æ™‚å¯«å…¥ fallback queue / DB / S3ï¼ˆéåŒæ­¥å¾Œè£œè™•ç†ï¼‰
		ğŸ‘‰ å‘ˆç¾æ›¿ä»£å›æ‡‰ï¼šã€Œæˆ‘å€‘å·²æ”¶åˆ°ä¸Šå‚³ï¼Œç¨å¾Œè£œä¸Šã€
	ğŸ›  ç¨‹å¼ç¯„ä¾‹ï¼ˆç°¡åŒ–ï¼‰ï¼š
		.doOnError(ex -> {
			saveToRetryQueue(tempFile);
			log.error("ä¸Šå‚³å¤±æ•—ï¼Œå·²é€²å…¥è£œå„Ÿè™•ç†", ex);
		})

| æ©Ÿåˆ¶                | ç”¨é€”                           | æ²’åšçš„å¾Œæœ             |
| ------------------- | ------------------------------ | ---------------------- |
| Retry               | é¿å…çŸ­æš«æ€§éŒ¯èª¤å°è‡´è«‹æ±‚å¤±æ•—     | å°æ•…éšœé€ æˆå¤§å•é¡Œ       |
| Backoff / Timeout   | æ§åˆ¶è³‡æºä½¿ç”¨ã€é¿å…é›ªå´©         | è«‹æ±‚å †ç©ã€ä¸»æ©Ÿè¢«æ‹–å®   |
| æš«å­˜æ¸…ç†            | é˜²æ­¢ç£ç¢Ÿç©ºé–“è€—ç›¡               | `/tmp` é•·æœŸçˆ†æ»¿        |
| Fallback            | ä¿ä½é—œéµè³‡æ–™ã€ä¸è®“éŒ¯èª¤ä¸­æ–·æµç¨‹ | ä½¿ç”¨è€…é«”é©—å·®ã€è³‡æ–™éºå¤± |

ç°¡æ˜“ç¯„ä¾‹
	import lombok.extern.slf4j.Slf4j;
	import org.springframework.core.io.FileSystemResource;
	import org.springframework.core.io.Resource;
	import org.springframework.http.MediaType;
	import org.springframework.http.client.reactive.ReactorClientHttpConnector;
	import org.springframework.stereotype.Service;
	import org.springframework.util.FileSystemUtils;
	import org.springframework.web.reactive.function.BodyInserters;
	import org.springframework.web.reactive.function.client.WebClient;
	import reactor.core.publisher.Mono;
	import reactor.util.retry.Retry;

	import java.io.IOException;
	import java.nio.file.Files;
	import java.nio.file.Path;
	import java.time.Duration;
	import java.util.UUID;

	@Slf4j
	@Service
	public class RobustFileUploader {

		private final WebClient webClient;

		public RobustFileUploader(WebClient webClient) {
			this.webClient = webClient;
		}

		public void uploadWithRetry(Path filePath) {
			Resource resource = new FileSystemResource(filePath.toFile());

			webClient.post()
					.uri("http://localhost:8081/api/files/upload")
					.contentType(MediaType.MULTIPART_FORM_DATA)
					.body(BodyInserters.fromMultipartData("file", resource))
					.retrieve()
					.onStatus(status -> status.is4xxClientError() || status.is5xxServerError(),
							res -> res.bodyToMono(String.class).flatMap(err -> {
								log.error("\u274C å¾Œç«¯å›æ‡‰éŒ¯èª¤: {}", err);
								return Mono.error(new RuntimeException("å¾Œç«¯éŒ¯èª¤: " + err));
							}))
					.bodyToMono(String.class)
					.timeout(Duration.ofSeconds(10))
					.retryWhen(Retry.backoff(2, Duration.ofSeconds(3)))
					.doOnSuccess(body -> {
						log.info("\u2705 ä¸Šå‚³æˆåŠŸ: {}", body);
						try {
							Files.deleteIfExists(filePath);
							log.info("\u2702 å·²åˆªé™¤æš«å­˜æª”æ¡ˆ: {}", filePath);
						} catch (IOException e) {
							log.warn("\u26A0\uFE0F ç„¡æ³•åˆªé™¤æš«å­˜æª”æ¡ˆ: {}", filePath, e);
						}
					})
					.doOnError(ex -> {
						log.error("\uD83D\uDEA8 ä¸Šå‚³å¤±æ•—ï¼Œé€²å…¥è£œå„Ÿè™•ç†: {}", ex.getMessage(), ex);
						saveToRetryQueue(filePath);
					})
					.subscribe();
		}

		private void saveToRetryQueue(Path failedFile) {
			try {
				Path fallbackDir = Path.of("/tmp/fallback-uploads/");
				Files.createDirectories(fallbackDir);
				Path fallbackFile = fallbackDir.resolve(UUID.randomUUID() + "-" + failedFile.getFileName());
				Files.copy(failedFile, fallbackFile);
				Files.deleteIfExists(failedFile);
				log.info("\uD83D\uDEAB æª”æ¡ˆå·²é€²å…¥è£œå„Ÿç›®éŒ„: {}", fallbackFile);
			} catch (IOException e) {
				log.error("\uD83D\uDD25 è£œå„Ÿå„²å­˜å¤±æ•—ï¼Œè«‹äººå·¥è™•ç†: {}", failedFile, e);
			}
		}
	}
