ref ChatGPT

æ¨™æº–éˆè·¯è¿½è¹¤æ ¼å¼ 
	W3C Trace Context
		Spring Boot 3 + Micrometer Tracing é è¨­æœƒä¾ç…§ W3C Trace Context æ¨™æº–ï¼Œ
		åœ¨ HTTP Header ä¸Šè‡ªå‹•åŠ ä¸Šä»¥ä¸‹æ¨™é ­ä¾†å‚³é traceId å’Œ spanIdï¼š

åœ¨ Spring Boot 3 ä¸­ï¼Œä½¿ç”¨ Micrometer Tracing ä¾†å¯¦ç¾åˆ†æ•£å¼è¿½è¹¤ï¼ˆDistributed Tracingï¼‰æ˜¯ä¸€å€‹æ¨™æº–åšæ³•ï¼Œ
	Micrometer Tracing æ•´åˆäº†å¦‚ OpenTelemetryã€Braveï¼ˆZipkinï¼‰ã€Wavefront ç­‰å¾Œç«¯ï¼Œä¸¦çµ±ä¸€æä¾›è§€å¯Ÿæ€§æ”¯æŒã€‚

ğŸ”§ åŸºæœ¬æ¶æ§‹èˆ‡å…ƒä»¶
	| åŠŸèƒ½           | å¸¸ç”¨å¯¦ä½œ                            |
	| -------------- | ----------------------------------- |
	| Tracer å¯¦ä½œ    | Braveï¼ˆZipkinï¼‰æˆ– OpenTelemetry     |
	| Span å‚³éå”å®š  | W3C Trace Context (é è¨­)ï¼Œä¹Ÿæ”¯æ´ B3 |
	| å‚³é€è³‡æ–™å¾Œç«¯   | Zipkinã€Jaegerã€OTel Collector ç­‰   |


ä¾è³´
	<dependency>
	  <groupId>org.springframework.boot</groupId>
	  <artifactId>spring-boot-starter-actuator</artifactId>
	</dependency>

	<dependency>
	  <groupId>io.micrometer</groupId>
	  <artifactId>micrometer-tracing-bridge-brave</artifactId>
	</dependency>

è‡ªå‹•æ•´åˆï¼š
	Micrometer Tracing API
	Brave ä½œç‚º backend å¯¦ä½œï¼ˆé è¨­ï¼‰
	è‡ªå‹•æ’å…¥ HTTP traceId / spanId åˆ° MDCï¼ˆlogback/log4j2ï¼‰
	è‡ªå‹•è™•ç† Web / WebClient / RestTemplate çš„ tracing propagation

å¦‚æœä½ æƒ³å‚³é€ trace è³‡æ–™ï¼ˆå¦‚åˆ° Zipkinã€OTLPï¼‰å¤šä¾è³´
	å‚³é€åˆ° Zipkin
		<dependency>
		  <groupId>io.zipkin.reporter2</groupId>
		  <artifactId>zipkin-reporter-brave</artifactId>
		</dependency>

		application.yml è¨­å®šç¯„ä¾‹
			management:
			  tracing:
				sampling:
				  probability: 1.0  # å…¨éƒ¨æ”¶é›†ï¼Œå»ºè­°æ­£å¼ç’°å¢ƒè¨­ç‚º 0.1 å·¦å³
			  zipkin:
				tracing:
				  endpoint: http://localhost:9411/api/v2/spans  # Zipkin ä¼ºæœå™¨


	å‚³é€åˆ° OTLP (OpenTelemetry):
		<dependency>
		  <groupId>io.micrometer</groupId>
		  <artifactId>micrometer-tracing-bridge-otel</artifactId>
		</dependency>
	
		application.yml è¨­å®šç¯„ä¾‹
			management:
			  tracing:
				sampling:
				  probability: 1.0
			otel:
			  exporter:
				otlp:
				  endpoint: http://localhost:4317

	æ­é… exporter
		<dependency>
		  <groupId>io.opentelemetry</groupId>
		  <artifactId>opentelemetry-exporter-otlp</artifactId>
		</dependency>

å°è£œå……ï¼šç‚ºä½•æ²’æœ‰æ‰€è¬‚çš„ spring-boot-starter-micrometer-tracingï¼Ÿ
	Spring Boot åœ˜éšŠå°šæœªæä¾›ä¸€å€‹é€šç”¨çš„ micrometer-tracing starterï¼Œ
	å› ç‚º tracing backend å¤šæ¨£ï¼ˆå¦‚ Braveã€OTelã€Wavefrontã€Datadogï¼‰ï¼Œ
	éœ€è¦é–‹ç™¼è€…é¸æ“‡ä¸€å€‹å¯¦ä½œæ©‹æ¥ä¾è³´ï¼ˆbridgeï¼‰ï¼Œæ‰€ä»¥é€šå¸¸æ˜¯é€é actuator + bridge çš„æ–¹å¼çµ„åˆï¼Œ
	è€Œä¸æ˜¯ä¸€å€‹çµ±ä¸€ starterã€‚
	



âœ… Micrometer Tracing çš„è‡ªå‹•è¿½è¹¤æ©Ÿåˆ¶
	| å…ƒä»¶                        | æ˜¯å¦è‡ªå‹•å»ºç«‹ spanï¼Ÿ                 | èªªæ˜                                    |
	| --------------------------- | ----------------------------------- | --------------------------------------- |
	| Spring MVC Controller       | âœ…                                  | è‡ªå‹•å»ºç«‹ `http.server.requests` span    |
	| WebClient                   | âœ…                                  | è‡ªå‹•å»ºç«‹ `http.client.requests` span    |
	| RestTemplateï¼ˆè‹¥è¨»å†Šï¼‰      | âœ…                                  | è‡ªå‹•å»ºç«‹ client span                    |
	| RabbitMQ / Kafka / DB é€£ç·š  | ğŸ”„ï¼ˆéœ€ micrometer instrumentationï¼‰ | å¯é¸ç”¨é¡å¤–ä¾è³´å¥—ä»¶                      |
	| æ–¹æ³•å‘¼å«ï¼ˆService å±¤ï¼‰      | âŒ                                  | é è¨­ä¸è¿½è¹¤ï¼Œè¦ç”¨ `@Observed` æˆ–è‡ªè¨‚ AOP |


ğŸ” å°çµå»ºè­°
	| æƒ…å¢ƒ                          | å»ºè­°ä½œæ³•                           |
	| ----------------------------- | ---------------------------------- |
	| REST API æˆ– WebClient å‘¼å«    | Micrometer è‡ªå‹•è™•ç†ï¼Œä¸ç”¨å¯«        |
	| ç‰¹å®š Service æ–¹æ³•è¦å»ºç«‹ span  | `@Observed`                        |
	| è‡ªè¨‚ traceId æ ¼å¼æˆ–ä¸Šä¸‹æ–‡æ•´åˆ | å¯åŠ  AOP æˆ–è‡ªå®š ObservationHandler |


ğŸ§  å¦‚æœä½ ä¸å»ºæ§‹å¾Œç«¯(Zipkinã€OpenTelemetry )æœƒæ€æ¨£ï¼Ÿ
	Micrometer Tracing åœ¨ Spring Boot 3 ä¸­çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ã€Œå»ºç«‹èˆ‡å‚³é Trace/Spanã€ï¼Œ
	å³ä½¿ä½ ä¸è¨­å®š Zipkin / OTLP ç­‰å¾Œç«¯ï¼Œå®ƒä»ç„¶æœƒï¼š
	
	âœ… åœ¨æ‡‰ç”¨å…§éƒ¨æ­£å¸¸å·¥ä½œ
		1.è‡ªå‹•å»ºç«‹ HTTP request spanï¼ˆä¾‹å¦‚ controller å‘¼å«ï¼‰

		2.è‡ªå‹•å»ºç«‹ WebClient spanï¼ˆå‘¼å«å…¶ä»–æœå‹™ï¼‰

		3.å°‡ traceId / spanId å‚³éåˆ°ä¸‹æ¸¸æœå‹™ï¼ˆé€é HTTP headerï¼‰

		4.å°‡ traceId / spanId æ”¾é€² MDCï¼Œå¯å°åœ¨ log ä¸­
	
	âŒ ä½†ä¸æœƒå°‡ trace è³‡æ–™é€å‡ºå»æˆ–é›†ä¸­å±•ç¤º
		é€™è¡¨ç¤ºä½ ç„¡æ³•ï¼š
			1.åœ¨ Zipkin / Jaeger UI ä¸­çœ‹åˆ° span timeline

			2.æŸ¥çœ‹æœå‹™é–“çš„éˆç‹€è¦–è¦ºåŒ–è¿½è¹¤

Micrometer Tracing åªæœƒè‡ªå‹•å¹«ä½ æ”¾ traceId å’Œ spanId åˆ° MDCï¼ˆMapped Diagnostic Contextï¼‰ï¼Œ
	å¦‚æœä½ æœ‰å…¶ä»–è‡ªè¨‚æ¬„ä½ï¼ˆä¾‹å¦‚ userIdã€requestIdã€tenantId ç­‰ï¼‰ï¼Œä½ å¿…é ˆè‡ªè¡Œè£œä¸Šèˆ‡æ¸…é™¤ã€‚
	
	âœ… Micrometer Tracing é è¨­åªæ”¾é€™äº›é€² MDCï¼š
		| Key       | å€¼ä¾†æº           |
		| --------- | ---------------- |
		| `traceId` | ç•¶å‰ Trace çš„ ID |
		| `spanId`  | ç•¶å‰ Span çš„ ID  |


	ğŸ§  è‹¥ä½ æœ‰é¡å¤–çš„ MDC æ¬„ä½ï¼Œè¦æ€éº¼è£œï¼Ÿ
		æ–¹æ³•ä¸€ï¼šä½¿ç”¨ HandlerInterceptor æˆ– OncePerRequestFilter (ä½†æ¯”è¼ƒå»ºè­° OncePerRequestFilter)
			@Component
			public class CustomMdcInterceptor extends HandlerInterceptorAdapter {

				@Override
				public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
					// å¾ Header æˆ– SecurityContext æŠ“ä½ è¦çš„æ¬„ä½
					String userId = request.getHeader("X-User-Id");
					if (userId != null) {
						MDC.put("userId", userId);
					}
					return true;
				}

				@Override
				public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
					MDC.remove("userId");
				}
			}

	ğŸ“Œ å»ºè­°ç­–ç•¥
		| ç›®çš„                                      | æ–¹æ³•                                     |
		| ----------------------------------------- | ---------------------------------------- |
		| è¦çµ±ä¸€è£œä¸Šè‡ªå®šæ¬„ä½å¦‚ `userId`ã€`reqId`    | ç”¨ `HandlerInterceptor` æˆ– `Filter`      |
		| è¦æ­é… Micrometer çš„è§€å¯Ÿäº‹ä»¶é€²è¡Œ MDC ç®¡ç† | è‡ªå®š `ObservationHandler`                |
		| è¦è‡ªå®š span name ä¸¦æ§åˆ¶å…§å®¹               | ç”¨ `Tracer.nextSpan()` + MDC è™•ç†        |
		| è¦è®“ä¸‹æ¸¸æœå‹™ä¹Ÿçœ‹åˆ°é€™äº›æ¬„ä½                | æ‰‹å‹•å¯«å…¥ HTTP headerï¼ˆé trace contextï¼‰ |


ğŸ¯ Micrometer Tracing çµ¦ä½ çš„æ ¸å¿ƒåƒ¹å€¼æ˜¯ï¼š
	âœ… å¹«ä½ è‡ªå‹•è™•ç† traceId / spanId çš„ç”Ÿæˆã€å‚³éèˆ‡ä¸Šä¸‹æ¸¸ä¸²æ¥
	âœ… è‡ªå‹•åŠ åˆ° MDCï¼ˆä½ å¯ä»¥ç›´æ¥å° logï¼‰
	âœ… è‡ªå‹•å»ºç«‹ spanï¼ˆä¾‹å¦‚ HTTP å‘¼å« / WebClientï¼‰
	âœ… æ”¯æ´è‡ªè¨‚è§€å¯Ÿ / æ‰‹å‹•å»ºç«‹ spanï¼ˆé€²éšæ§åˆ¶ï¼‰
	
	ğŸ§  ä½† Micrometer Tracingã€Œä¸æœƒå¹«ä½ è™•ç†ã€ï¼š
		| åŠŸèƒ½                                            | æ˜¯å¦ Micrometer Tracing è™•ç†ï¼Ÿ | è™•ç†æ–¹å¼                                          |
		| ----------------------------------------------- | ------------------------------ | ------------------------------------------------- |
		| è‡ªå®š `userId`, `tenantId`, `requestId` ç­‰æ¬„ä½   | âŒ ä¸æœƒ                        | ä½ éœ€è¦ç”¨ Filter / Interceptor / è‡ªå®š Handler è£œä¸Š |
		| ç‰¹å®šæ¥­å‹™æµç¨‹è‡ªå®š spanï¼ˆä¾‹å¦‚æŸ¥è³‡æ–™åº«ã€åŒ¯å‡ºå ±è¡¨ï¼‰ | âŒ é è¨­ä¸æœƒ                    | å¯ç”¨ `@Observed` æˆ– `Tracer.nextSpan()` è™•ç†      |
		| å°‡ traceId å‚³çµ¦é HTTP çš„å…ƒä»¶ï¼ˆå¦‚ MQ, æ—¥èªŒåˆ†æï¼‰| âŒ éœ€ä½ è‡ªè¡Œè™•ç†                | è‡ªè¡Œå¾ `MDC.get("traceId")` æ‹¿ä¾†å‚³é              |

âœ… Micrometer Tracing çš„è§’è‰²å®šä½ç¸½çµå¦‚ä¸‹ï¼š
	| é¡å‹                        | å‚³çµ±åšæ³•ï¼ˆè‡ªå·±å¯«ï¼‰    | Micrometer Tracing     |
	| --------------------------- | --------------------- | ---------------------- |
	| traceId / spanId ç”¢ç”Ÿèˆ‡ç¹¼æ‰¿ | è‡ªå·±å¯« AOP or UUID    | è‡ªå‹•è™•ç†ï¼ˆéµå®ˆæ¨™æº–ï¼‰   |
	| HTTP Header å‚³é            | è‡ªå·±æ‰‹å‹•åŠ             | è‡ªå‹•è™•ç†               |
	| WebClient ä¸‹æ¸¸ä¸²æ¥ Trace    | è‡ªå·±åŠ  Filter         | è‡ªå‹•è™•ç†               |
	| Log MDCï¼ˆæ”¾ traceIdï¼‰       | è‡ªå·±å¡ `MDC.put()`    | è‡ªå‹•å¡å¥½               |
	| è‡ªå®šæ¬„ä½ MDCï¼ˆå¦‚ userIdï¼‰   | è‡ªå·±åŠ                 | é‚„æ˜¯è¦è‡ªå·±åŠ            |
	| Trace å¯è¦–åŒ–å¹³å°æ•´åˆ        | è‡ªå·±ä¸² Zipkin         | å¯é¸é…åˆ exporter      |


ğŸŒ é è¨­ä½¿ç”¨çš„ HTTP Header åç¨±ï¼ˆW3Cï¼‰
	| Header åç¨±     | å…§å®¹                                                                        |
	| --------------- | --------------------------------------------------------------------------- |
	| `traceparent`   | åŒ…å« traceIdã€spanIdã€sampled ç­‰è³‡è¨Š                                        |
	| `tracestate`    | å¯é¸ï¼Œæ”œå¸¶é¡å¤–ä¾›åˆ†æå¹³å°ä½¿ç”¨çš„ vendor-specific è³‡è¨Šï¼ˆå¦‚ datadogã€azure ç­‰ï¼‰ |

	ğŸ§ª traceparent ç¯„ä¾‹å…§å®¹ï¼š
		traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01
					 version-traceId-spanId-sampled
			æ ¼å¼æ‹†è§£ï¼š
				00        -> version
				4bf9...36 -> traceId
				00f0...b7 -> spanId
				01        -> sampled (1 è¡¨ç¤ºæœƒé€åˆ° backend)
	
	â“å¦‚æœä½ æƒ³æ”¹ç”¨ Zipkin çš„ B3 header æ ¼å¼ï¼Ÿ
		application.ymlï¼š
			management:
			  tracing:
				propagation:
				  type: b3  # æˆ– b3_multi
		B3 å–®ä¸€ headerï¼ˆb3ï¼‰ç¯„ä¾‹ï¼š
			b3: 4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-1
		B3 å¤š headerï¼ˆb3_multiï¼‰ç¯„ä¾‹ï¼š
			X-B3-TraceId: 4bf92f3577b34da6a3ce929d0e0e4736
			X-B3-SpanId: 00f067aa0ba902b7
			X-B3-Sampled: 1


logback mdc è™•ç†æ³¨æ„é …ç›®
	| logback key             | å°æ‡‰å…§å®¹                                           |
	| ----------------------- | -------------------------------------------------- |
	| `%X{traceId}`           | MDC ä¸­çš„ `traceId`ï¼Œç”± Micrometer Tracing è‡ªå‹•æ”¾å…¥ |
	| `%X{spanId}`            | MDC ä¸­çš„ `spanId`ï¼ŒåŒä¸Š                            |
	| `%X{userId}` ç­‰è‡ªå®šæ¬„ä½ | ä½ è¦è‡ªå·±æ”¾ï¼ˆç”¨ Filterã€Interceptorï¼‰               |
