ref ChatGPT

===============================================================================================================
ğŸ’¬ æƒ…å¢ƒï¼š
	é›²ç«¯æœå‹™ï¼ˆæˆ–å‰ç«¯ï¼‰æ‰“ API åˆ°é›²ç«¯ Gatewayï¼ŒGateway å¹«å¿™æŠŠåŸ token æ›æ‰ï¼Œå†é€é Gateway-to-Gateway æ¨¡å¼å®‰å…¨è½‰é€åˆ°åœ°ç«¯æœå‹™ã€‚

	ğŸ§­ æ­¥é©Ÿè©³è§£ï¼šé›²æœå‹™ â†’ é›² Gateway â†’ é›² Auth Server â†’ åœ°ç«¯ Gateway â†’ åœ°ç«¯æœå‹™

	âœ… æ­¥é©Ÿ 1ï¼šé›²ç«¯æœå‹™ï¼ˆæˆ–å‰ç«¯ï¼‰ç™¼èµ·è«‹æ±‚
		GET /cloud-gateway/onprem/data
		Authorization: Bearer eyJhbGciOi... ï¼ˆåŸ access tokenï¼‰

	âœ… æ­¥é©Ÿ 2ï¼šé›²ç«¯ Gateway (WebMvc Gateway) æ¥æ”¶è«‹æ±‚
		ä½ é€™é‚Šæœƒåœ¨é›²ç«¯ Gateway ä¸­åŠ ä¸€å€‹ Filterï¼Œæ””æˆª Authorization Header

			1.Filter æŠ“åˆ°åŸå§‹ token subject_token

			2.å‘¼å«é›²ç«¯ Auth Server /oauth2/token endpoint é€²è¡Œ Token Exchangeï¼ˆRFC 8693ï¼‰

	âœ… æ­¥é©Ÿ 3ï¼šé›²ç«¯ Gateway â†’ é›²ç«¯ Auth Server è«‹æ±‚ token exchange
		POST /oauth2/token
		Authorization: Basic client-a:secret
		Content-Type: application/x-www-form-urlencoded

		grant_type=urn:ietf:params:oauth:grant-type:token-exchange
		subject_token=eyJhbGciOi...
		subject_token_type=urn:ietf:params:oauth:token-type:access_token
		audience=onprem-api

	âœ… æ­¥é©Ÿ 4ï¼šAuth Server å›å‚³ exchanged token
		{
		  "access_token": "exchanged-token-for-onprem",
		  "token_type": "Bearer",
		  "expires_in": 600
		}

	âœ… æ­¥é©Ÿ 5ï¼šé›²ç«¯ Gateway æ”¹å¯« headerï¼Œå‘¼å«åœ°ç«¯ Gateway
		GET http://onprem-gateway.local/api/data
		Authorization: Bearer exchanged-token-for-onprem
		ä½ æœƒç”¨ RestTemplate æˆ– WebClient åœ¨ Gateway å…§è½‰é€é€™å€‹è«‹æ±‚ï¼ˆæˆ–ä½¿ç”¨ Forward/Redirect æ©Ÿåˆ¶ï¼‰

	âœ… æ­¥é©Ÿ 6ï¼šåœ°ç«¯ Gateway æ”¶åˆ°è«‹æ±‚ï¼Œé©—è­‰ token
		åœ°ç«¯ Gateway æ˜¯ Resource Serverï¼š

			* æœƒå»æª¢æŸ¥é€™å€‹ exchanged token çš„ issuer æ˜¯å¦å¯ä¿¡ï¼ˆæ‡‰ç‚ºé›²ç«¯ Auth Serverï¼‰

			* é©—è­‰ JWT ç°½ç« ã€audienceã€scope æ˜¯å¦ç¬¦åˆè¦æ±‚

	âœ… æ­¥é©Ÿ 7ï¼šåœ°ç«¯ Gateway å†è½‰ç™¼çµ¦åœ°ç«¯å¯¦éš›æœå‹™
		GET http://onprem-internal-service/api/data
		Authorization: Bearer exchanged-token-for-onprem
		å¯åœ¨ Gateway ä¸Šé…ç½® route/forward logicï¼Œä¹Ÿå¯ç¶“ç”± Controller å¯¦ä½œ proxyã€‚

	âœ… æ­¥é©Ÿ 8ï¼šåœ°ç«¯æœå‹™è™•ç†é‚è¼¯ + å›å‚³ Response
		ä¸€åˆ‡é€šéå¾Œï¼Œåœ°ç«¯æœå‹™æˆåŠŸè™•ç†è«‹æ±‚ï¼Œå›æ‡‰è³‡æ–™ï¼š
			{
			  "data": "this is from on-prem system"
			}

	ğŸ” å®‰å…¨è¨­è¨ˆç¸½çµ
		| é‚Šç•Œ             | æªæ–½                                                       |
		| --------------- | ---------------------------------------------------------- |
		| é›²ç«¯ Gateway     | é©—è­‰åŸå§‹ token ä¸¦æ§åˆ¶èª°å¯ä»¥ç™¼èµ·äº¤æ›                             |
		| é›²ç«¯ Auth Server | é©—è­‰ subject\_token ä¸¦æ ¹æ“š client/role ç™¼å‡ºæ–°çš„æ¬Šé™è¼ƒå°çš„ token |
		| åœ°ç«¯ Gateway     | é©—è­‰ exchanged tokenï¼Œç¢ºèªæ˜¯ä¾†è‡ªé›²ç«¯ä¸¦ç¬¦åˆåœ°ç«¯è³‡æºè¦æ±‚            |
		| åœ°ç«¯ Service     | ç›¸ä¿¡ Gateway å‚³é€²ä¾†çš„ requestï¼Œç„¡éœ€å†åšèªè­‰                     |


	âœ… æ¯å€‹æ­¥é©Ÿå¯¦ä½œæ¨™è¨»ï¼ˆå…± 8 æ­¥ï¼‰
		| æ­¥é©Ÿ   | æè¿°                                                      | æ˜¯å¦éœ€è‡ªè¡Œå¯¦ä½œï¼Ÿ            | å‚™è¨»                                                                          |
		| ----- | -------------------------------------------------------- | ------------------------ | ---------------------------------------------------------------------------- |
		| **1** | é›²ç«¯æœå‹™æˆ–å‰ç«¯æ‰“ APIï¼Œæ”œå¸¶åŸ token                            | âŒ ä¸ç”¨å¯¦ä½œ               | å‘¼å«è€…è‡ªè¡Œå¸¶å…¥åŸ JWT token                                                       |
		| **2** | é›²ç«¯ Gateway æ¥æ”¶è«‹æ±‚ï¼Œæ“·å–åŸ token                          | âœ… è¦å¯¦ä½œ                 | éœ€è‡ªå·±å¯¦ä½œä¸€å€‹ Filter æŠ“å‡º Authorization Header                                  |
		| **3** | é›²ç«¯ Gateway å‘¼å« Auth Server `/token` æ› token            | âœ… è¦å¯¦ä½œ                 | ç”¨ `RestTemplate` æˆ– `WebClient` ç™¼ HTTP è«‹æ±‚                                   |
		| **4** | é›²ç«¯ Gateway æ”¶åˆ° exchanged token                          | âœ… è¦å¯¦ä½œ                 | Parse å›æ‡‰ä¸¦å–å‡º access\_token                                                  |
		| **5** | é›²ç«¯ Gateway æ”¹å¯« Authorization header ä¸¦è½‰ç™¼è‡³åœ°ç«¯ Gateway  | âœ… è¦å¯¦ä½œ                 | å°‡æ›åˆ°çš„ token æ”¾é€² header ä¸¦ forward è«‹æ±‚                                        |
		| **6** | åœ°ç«¯ Gateway é©—è­‰ exchanged token                         | âŒ ä¸ç”¨å¯¦ä½œé‚è¼¯ï¼Œä½†è¦è¨­å®š     | ä½¿ç”¨ Spring Security Resource Server æ¨¡çµ„ï¼Œè‡ªå‹•é©— JWTï¼Œåªè¦è¨­å®šå¥½ issuer/public key |
		| **7** | åœ°ç«¯ Gateway è½‰é€è‡³å…§éƒ¨åœ°ç«¯æœå‹™                              | âœ… å¯å¯¦ä½œæˆ–ä½¿ç”¨ Forward æ©Ÿåˆ¶ | å¯ç”¨ Controller + RestTemplate æˆ– Mvc Route Mapping                            |
		| **8** | åœ°ç«¯æœå‹™è™•ç†è«‹æ±‚ä¸¦å›æ‡‰                                       | âŒ ä¸ç”¨å¯¦ä½œç‰¹åˆ¥é‚è¼¯          | è‹¥ä¿è­·å¾—ç•¶ï¼Œå¯ç›´æ¥å›æ‡‰è³‡æ–™                                                         |

	âœ… è‡ªå·±è¦åšçš„æ ¸å¿ƒå¯¦ä½œï¼ˆæ¿ƒç¸®ï¼‰
		| å€å¡Š                                          | è¦åšä»€éº¼                                                                      |
		| -------------------------------------------- | --------------------------------------------------------------------------- |
		| âœ… é›²ç«¯ Gateway çš„ Filter                     | è§£æåŸ JWTï¼Œå‘¼å« `/token`ï¼Œè½‰ç™¼æ™‚é™„ä¸Š exchanged token                            |
		| âœ… cloud-auth-server çš„ TokenExchange Grant  | è‹¥ç”¨ Spring Authorization Serverï¼Œè¦å¯¦ä½œä¸€å€‹è‡ªå®šç¾©çš„ Grantï¼ˆconverter + providerï¼‰ |
		| âœ… åœ°ç«¯ Gateway Resource Server è¨­å®š           | è¨­å®šå¥½ JWT é©—è­‰åƒæ•¸ï¼ˆissuer URI + JWK URIï¼‰                                     |

	ğŸ’¡ æé†’äº‹é …
		| ä¸»é¡Œ                                         | èªªæ˜                                                                      |
		| ------------------------------------------- | ------------------------------------------------------------------------- |
		| ğŸ” Auth Server æ˜¯å¦ä¿¡ä»»ä¾†è‡ªçš„ subject\_tokenï¼Ÿ | ä½ è¦åœ¨ provider ä¸­è™•ç† token çš„è§£æèˆ‡é©—è­‰ï¼ˆå»ºè­°é©—ç°½æˆ– lookupï¼‰                    |
		| ğŸ” Token äº¤æ›æ˜¯å¦æœ‰é™ scopeï¼Ÿ                  | å¯ä»¥è¨­å®š audience / scope è½‰æ›ï¼Œé¿å…æ¬Šé™æ“´å¼µ                                   |
		| ğŸ“¦ JWK å…¬é‘°åŒæ­¥                              | åœ°ç«¯ Gateway è‹¥é©— JWTï¼Œéœ€èƒ½è®€å–é›²ç«¯ Auth Server çš„ `/oauth2/jwks` endpoint     |

==============================================================================================================================================================

ğŸ§© æ¶æ§‹çµ„ä»¶ï¼ˆæœ€å°å¯¦ä½œç‰ˆæœ¬ï¼‰
	| æ¨¡çµ„                          | æè¿°                                                       |
	| ---------------------------- | ---------------------------------------------------------- |
	| `cloud-auth-server`          | é›²ç«¯ Auth Serverï¼Œå¯¦ä½œ `/token` endpointï¼Œæ”¯æ´ token exchange |
	| `cloud-gateway`              | é›²ç«¯ Gatewayï¼Œé©—è­‰ JWTã€ç™¼å‡º tokenã€è½‰ç™¼è‡³åœ°ç«¯                   |
	| `onprem-gateway`             | åœ°ç«¯ Gatewayï¼Œé©—è­‰ exchange éå¾Œçš„ tokenï¼Œä¿è­·åœ°ç«¯è³‡æº           |
	| *(é¸é…)* `onprem-auth-server` | è‹¥åœ°ç«¯éœ€å†ç°½ç™¼å…§éƒ¨ tokenï¼Œå¯åŠ å…¥ï¼ˆå¯å»¶å¾Œé–‹ç™¼ï¼‰                     |

âœ… ä½¿ç”¨æŠ€è¡“æ£§
	Spring Boot 3.x

	Spring Authorization Server 1.2+ï¼ˆæ”¯æ´è‡ªå®šç¾© grantï¼‰

	Spring Security + Resource Server

	å¯åŠ ä¸Š Spring Cloud Gateway 4.xï¼ˆå¯é¸ï¼‰


1. cloud-auth-server â€” æ”¯æ´ Token Exchange
	1.1 åŠ å…¥ä¾è³´
		<dependency>
		  <groupId>org.springframework.boot</groupId>
		  <artifactId>spring-boot-starter-oauth2-authorization-server</artifactId>
		</dependency>

	1.2 è‡ªå®šç¾© TokenExchange Grant
		Spring Authorization Server å°šæœªå…§å»º RFC 8693ï¼Œä½ éœ€è¦å¯¦ä½œä¸€å€‹ custom AuthenticationConverter + AuthenticationProviderï¼š
			public class TokenExchangeAuthenticationConverter implements AuthenticationConverter {
				@Override
				public Authentication convert(HttpServletRequest request) {
					String grantType = request.getParameter(OAuth2ParameterNames.GRANT_TYPE);
					if (!"urn:ietf:params:oauth:grant-type:token-exchange".equals(grantType)) {
						return null;
					}
					String subjectToken = request.getParameter("subject_token");
					String audience = request.getParameter("audience");
					return new TokenExchangeAuthentication(subjectToken, audience);
				}
			}

		å†æ­é… provider é©—è­‰åŸå§‹ token ä¸¦é‡æ–°ç°½ç™¼æ–° access token

2. cloud-gateway â€” ç™¼ token ä¸¦å‘¼å«åœ°ç«¯ gateway
	ä½ å¯ç”¨ Spring Cloud Gateway + OAuth2 Client æ¨¡å¼ä¾†è«‹æ±‚ exchange token ä¸¦ forwardï¼š
	spring:
	  cloud:
		gateway:
		  routes:
			- id: call-onprem
			  uri: http://onprem-gateway.local
			  predicates:
				- Path=/onprem/**
			  filters:
				- RewritePath=/onprem/(?<segment>.*), /$\{segment}
				- TokenRelay
	ä½ å¯ä»¥é¸æ“‡æ‰‹å‹•å‘¼å« token exchange endpointï¼Œå°‡æ›åˆ°çš„ token æ”¾åœ¨ Authorization header è½‰é€éå»ã€‚


3. onprem-gateway â€” é©—è­‰ exchanged token
	1.1 åŠ å…¥ä¾è³´
		<dependency>
		  <groupId>org.springframework.boot</groupId>
		  <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
		</dependency>
	1.2 è¨­å®šï¼š
		spring:
		  security:
			oauth2:
			  resourceserver:
				jwt:
				  issuer-uri: https://cloud-auth-server.local
		æ³¨æ„ï¼šonprem éœ€è¦ä¿¡ä»» cloud-auth-server çš„ issuer å’Œ public keyã€‚





==============================================================================================================================================================
Q: ç¬¬ä¸ƒæ­¥é©Ÿåœ°ç«¯å¦‚ä½•åˆ†è¾¨ä¸€èˆ¬åœ°ç«¯gateway æ‰“è‡ªå·±åœ°å¾Œæ®µé‚„æ˜¯é›²ç©¿éä¾†çš„æ‰“åœ°å¾Œæ®µï¼Ÿ
	å…©ç¨®æƒ…å¢ƒï¼š
		| è«‹æ±‚ä¾†æº                                      | è¡Œç‚º            | éœ€è¦è¾¨è­˜ï¼Ÿ      |
		| ------------------------------------------- | --------------- | ------------ |
		| âœ… **åœ°ç«¯å…§éƒ¨ç³»çµ±ç›´æ¥æ‰“åœ°ç«¯ Gatewayï¼ˆå…§éƒ¨æœå‹™ï¼‰**  | æ­£å¸¸å…§éƒ¨èª¿ç”¨      | âœ”ï¸ æ˜¯åœ°ç«¯è‡ªå·±äºº |
		| âœ… **é›²ç«¯é€é VPN + Gateway-to-Gateway è·¨ä¾†** | é›²æœå‹™å‘¼å«åœ°ç«¯ API | âœ”ï¸ æ˜¯å¤–ä¾†äºº    |

	ğŸ§  åœ°ç«¯ Gateway å¦‚ä½•å€åˆ†ï¼Ÿ
		âœ… æ–¹æ³• 1ï¼šJWT token çš„ issuer / audience / scope åˆ¤æ–·ï¼ˆæœ€å¸¸ç”¨ï¼‰
			ä½ é€éã€Œtoken æœ¬èº«çš„å…§å®¹ã€ä¾†è­˜åˆ¥ä¾†æºï¼š
				Authorization: Bearer xxx
			é€éè§£ JWTï¼Œå¯åˆ¤æ–·ï¼š
				| Claim æ¬„ä½      | ä¾‹å­                         | èªªæ˜                      |
				| -------------- | --------------------------- | ------------------------- |
				| `iss`          | `https://cloud-auth-server` | æ˜¯å¾é›²ç«¯ä¾†çš„                |
				| `aud`          | `onprem-api`                | è¡¨ç¤ºè¦æ‰“çš„æ˜¯åœ°ç«¯è³‡æº          |
				| `scope`        | `read onprem`               | è¡¨ç¤ºæ˜¯ exchange éå¾Œæˆæ¬Šç¯„åœ |
				| `act` / `azp`  | `client-a`                  | èª°ç™¼èµ·çš„äº¤æ›ï¼Œå¯ä»¥è¿½è¹¤ä¾†æº     |

			ğŸ‘‰ åœ°ç«¯ Gateway æ˜¯ Spring Resource Serverï¼Œå¯ä»¥åœ¨ filter ä¸­è§£ JWT + åŠ æ¢ä»¶é‚è¼¯ï¼š
				Jwt jwt = jwtDecoder.decode(token);
				if (!"https://cloud-auth-server".equals(jwt.getIssuer().toString())) {
				   throw new AccessDeniedException("Invalid token issuer");
				}

		âœ… æ–¹æ³• 2ï¼šHTTP Header è‡ªå®šæ¨™ç¤ºï¼ˆè‹¥ token ä¸å¤ ç”¨ï¼‰
			ç”±é›²ç«¯ Gateway åœ¨è½‰ç™¼æ™‚åŠ ä¸Šè‡ªå®šç¾© Headerï¼Œä¾‹å¦‚ï¼š
				X-Source-Gateway: cloud
			åœ°ç«¯ Gateway æˆ–å¾Œç«¯å¯ä»¥è®€åˆ°æ­¤æ¨™é ­ï¼Œä»¥æ­¤æ±ºå®šï¼š

				æ˜¯å…§éƒ¨æœå‹™é‚„æ˜¯å¤–éƒ¨ç©¿è¶Šè€Œä¾†

				å¯¦ä½œåœ¨ Filterã€Interceptorã€Controller éƒ½å¯

			ğŸ‘‰ ä¸å»ºè­°åªé é€™ç¨®æ–¹å¼ï¼Œå› ç‚ºå®¹æ˜“è¢« forgedï¼Œä½†å¯ç•¶é™„åŠ ä¿¡è™Ÿã€‚

		âœ… æ–¹æ³• 3ï¼šIP/ç¶²æ®µè¾¨è­˜ï¼ˆç‰©ç†é‚Šç•Œï¼‰
			å‡è¨­ä½ åœ°ç«¯ Gateway æœ‰å…©å¼µç¶²å¡ï¼ˆå…§éƒ¨ç¶²æ®µã€VPN å°ˆç·šï¼‰ï¼š

				* å…§éƒ¨è«‹æ±‚ä¾†è‡ª 192.168.*.*

				* VPN é›²ç«¯ä¾†è‡ª 10.20.*.*

			åœ°ç«¯ Gateway å¯ä¾æ“š X-Forwarded-For / request.getRemoteAddr() åˆ†è¾¨ä¾†æºã€‚

			ğŸ‘‰ å»ºè­°æ­é… token æª¢æŸ¥ä¸€èµ·ç”¨ï¼Œä¸å–®é  IP åˆ¤æ–·ã€‚

		âœ… æ–¹æ³• 4ï¼šSpring Security æ›ä¸Šå¤šå±¤ AccessDecisionVoter

		âœ… æœ€å»ºè­°çš„å¯¦ä½œæ–¹å¼
			ç”¨ JWT issuer + audience + scope åšç¬¬ä¸€å±¤è¾¨è­˜ï¼Œå¿…è¦æ™‚å†åŠ  Header ä½œç¬¬äºŒå±¤ traceã€‚
				ä½ å¯ä»¥åœ¨åœ°ç«¯ gateway æˆ– controller åšé€™æ¨£çš„é‚è¼¯ï¼š
					Jwt jwt = (Jwt) SecurityContextHolder.getContext().getAuthentication().getPrincipal();
					String issuer = jwt.getIssuer().toString();
					String audience = jwt.getAudience().stream().findFirst().orElse("");
					if ("https://cloud-auth-server".equals(issuer) && "onprem-api".equals(audience)) {
						// æ˜¯å¾é›²ä¾†çš„
					} else {
						// æ˜¯åœ°ç«¯å…§éƒ¨ä¾†çš„
					}
			// åœ°ç«¯ Gateway JWT é©—è­‰éå¾Œï¼Œè¾¨è­˜ä¾†æºæ˜¯å…§éƒ¨é‚„æ˜¯é›²ç«¯äº¤æ›è€Œä¾†çš„è«‹æ±‚

			@Component
			public class SourceAwareRequestFilter extends OncePerRequestFilter {

				private final JwtDecoder jwtDecoder;

				public SourceAwareRequestFilter(JwtDecoder jwtDecoder) {
					this.jwtDecoder = jwtDecoder;
				}

				@Override
				protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
						throws ServletException, IOException {

					String authHeader = request.getHeader("Authorization");
					if (authHeader != null && authHeader.startsWith("Bearer ")) {
						String token = authHeader.substring(7);

						try {
							Jwt jwt = jwtDecoder.decode(token);

							String issuer = jwt.getIssuer().toString();
							String audience = jwt.getAudience().stream().findFirst().orElse("n/a");
							String scope = jwt.getClaimAsString("scope");

							boolean isFromCloud = "https://cloud-auth-server".equals(issuer) &&
												  "onprem-api".equals(audience) &&
												  scope != null && scope.contains("onprem");

							if (isFromCloud) {
								request.setAttribute("source", "CLOUD_EXCHANGE");
							} else {
								request.setAttribute("source", "INTERNAL_ONPREM");
							}

						} catch (JwtException e) {
							response.sendError(HttpStatus.UNAUTHORIZED.value(), "Invalid JWT token");
							return;
						}
					} else {
						request.setAttribute("source", "ANONYMOUS_OR_NON_JWT");
					}

					filterChain.doFilter(request, response);
				}
			}

			// åœ¨ Controller æˆ–ä¸‹æ¸¸æœå‹™ä¸­é€™æ¨£ä½¿ç”¨
			@RestController
			public class OnpremApiController {

				@GetMapping("/api/data")
				public ResponseEntity<String> getData(HttpServletRequest request) {
					String source = (String) request.getAttribute("source");

					if ("CLOUD_EXCHANGE".equals(source)) {
						return ResponseEntity.ok("[ä¾†è‡ªé›²ç«¯] Hello from on-prem system.");
					} else if ("INTERNAL_ONPREM".equals(source)) {
						return ResponseEntity.ok("[å…§éƒ¨åœ°ç«¯] Hello from local system.");
					} else {
						return ResponseEntity.status(HttpStatus.FORBIDDEN).body("Unauthorized source.");
					}
				}
			}

			âœ… æ ¸å¿ƒåŠŸèƒ½èªªæ˜ï¼š
				1.æ“·å– Authorization Header ä¸­çš„ JWT

				2.ä½¿ç”¨ JwtDecoder é©—è­‰ä¸¦è§£æ token

				3.æ ¹æ“š JWT çš„ issuerã€audienceã€scope åˆ¤æ–·ä¾†æº

					* å¦‚æœä¾†è‡ªé›²ç«¯äº¤æ›ï¼ˆissuer = é›²ç«¯ Auth Serverï¼‰ï¼Œå‰‡è¨­å®šç‚º CLOUD_EXCHANGE

					* å¦å‰‡è¦–ç‚ºå…§éƒ¨åœ°ç«¯ä¾†æº INTERNAL_ONPREM

				4.è¨­å®šæˆ request attributeï¼Œå¯è®“ä¸‹æ¸¸ Controller æˆ– Service ä½¿ç”¨


				ğŸ§ª Controller ç¯„ä¾‹å›æ‡‰é‚è¼¯
					@GetMapping("/api/data")
					public ResponseEntity<String> getData(HttpServletRequest request) {
						String source = (String) request.getAttribute("source");
						...
					}
					ä½ å¯ä»¥æ ¹æ“šä¾†æºè¨­è¨ˆä¸åŒçš„è¡Œç‚ºï¼Œä¾‹å¦‚ï¼š

						* ä¾†è‡ªå…§éƒ¨å¯èª¿ç”¨æŸäº›è³‡æº

						* ä¾†è‡ªé›²ç«¯åƒ…é™åªè®€

						* é›²ç«¯ request å¤šåŠ å¯©è¨ˆè¨˜éŒ„ç­‰

==============================================================================================================================================================
Q:åœ°ç«¯ Gateway å¦‚ä½•åœ¨ã€Œè·¯ç”±å±¤ç´šã€ä¸Šå€åˆ¥ä¾†æº â€”â€” æ˜¯ã€Œé›²/åœ°ç©¿é€é€²ä¾†çš„ã€é‚„æ˜¯ã€Œé›²/åœ°ç«¯è‡ªå·±äººæ‰“çš„ã€
	ğŸ¯ å•é¡Œé‡é»ç°¡åŒ–ï¼š
		åœ°ç«¯ Gateway åœ¨è¨­å®š route æ™‚ï¼Œè¦æ€éº¼æ ¹æ“šè«‹æ±‚ã€Œä¾†æºã€ä¸åŒï¼ˆé›² vs. åœ°ï¼‰èµ°ä¸åŒé‚è¼¯æˆ–ä¸‹æ¸¸è·¯å¾‘ï¼Ÿ

	âœ… è§£æ³•ï¼šçµåˆã€Œä¾†æºè¾¨è­˜ã€+ã€Œæ¢ä»¶è·¯ç”±ã€
		æ ¹æ“šä½ ä½¿ç”¨çš„æ˜¯ spring-cloud-starter-gateway-server-webmvcï¼ˆMVC Gatewayï¼‰ï¼Œæˆ‘å€‘ç„¡æ³•ä½¿ç”¨ WebFlux çš„ RouteLocator DSLï¼Œè€Œæ˜¯å¿…é ˆç”¨ï¼š

			* HandlerMapping é€²è¡Œè·¯ç”±è¦å‰‡è¨­å®šï¼ˆä¾‹å¦‚ @RequestMappingï¼‰

			* æˆ–å¯«è‡ªå®šç¾© HandlerInterceptor / Filter ä¾†æ ¹æ“šä¾†æºè½‰é€ä¸åŒä¸‹æ¸¸

	âœ… è§£æ³•æ–¹æ¡ˆ Aï¼šç”¨ Filter åˆ¤æ–·ä¾†æº â†’ ä¿®æ”¹è½‰é€ç›®æ¨™ï¼ˆforward URIï¼‰
		æ­¥é©Ÿï¼š
			1.ä½¿ç”¨å‰›å‰›çš„ SourceAwareRequestFilter åˆ¤æ–·ä¾†æºï¼ˆé›² or åœ°ï¼‰

			2.æ ¹æ“šä¾†æºè¨­ç½® request attribute

			3.åœ¨ controller æˆ– filter ä¸­å‹•æ…‹æ±ºå®šè¦ forward åˆ°å“ªä¸€å€‹ä¸‹æ¸¸


				@Component
				public class RoutingDecisionFilter extends OncePerRequestFilter {
					@Override
					protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)
							throws ServletException, IOException {

						String source = (String) request.getAttribute("source");

						if ("CLOUD_EXCHANGE".equals(source)) {
							request.setAttribute("targetUri", "/internal/proxy/cloud-to-backend");
						} else {
							request.setAttribute("targetUri", "/internal/proxy/local-to-backend");
						}

						chain.doFilter(request, response);
					}
				}

			Controller é€™æ¨£åšï¼š
				@Controller
				public class GatewayRouterController {

					@RequestMapping("/onprem/**")
					public void route(HttpServletRequest request, HttpServletResponse response) throws IOException {
						String targetUri = (String) request.getAttribute("targetUri");

						// ç”¨ RestTemplate æˆ– forward
						if ("/internal/proxy/cloud-to-backend".equals(targetUri)) {
							response.sendRedirect("http://localhost:8082/api/cloud-version");
						} else {
							response.sendRedirect("http://localhost:8082/api/local-version");
						}
					}
				}

	âœ… è§£æ³•æ–¹æ¡ˆ Bï¼šå¦‚æœä½ ä½¿ç”¨ DispatcherServlet çš„ Forward æ©Ÿåˆ¶
		request.getRequestDispatcher("/forward/cloud").forward(request, response);

		åœ¨ä¸åŒè·¯ç”±çš„ Controller ä¸­æ±ºå®šè¦ forward åˆ°å“ªä¸€å€‹ serviceã€‚

	ğŸš« ç„¡æ³•ä½¿ç”¨çš„åšæ³•ï¼ˆçµ¦ä½ é¿é›·ï¼‰
		åœ¨ MVC Gateway è£¡ä½ ç„¡æ³•ç”¨ï¼š
			spring.cloud.gateway.routes:
			  - id: route1
				predicates:
				  - Header=X-Source,cloud
			å› ç‚ºé€™äº›å±¬æ–¼ WebFlux Gateway çš„ DSL é…ç½®ï¼Œä½ ä½¿ç”¨çš„æ˜¯ Servlet/MVC æ¶æ§‹ï¼Œä¸é©ç”¨ã€‚

	âœ… å°çµï¼šå»ºè­°åšæ³•
		| å…ƒä»¶                        | åŠŸèƒ½                    | å¿…è¦æ€§   |
		| -------------------------- | ---------------------- | ------- |
		| `SourceAwareRequestFilter` | åˆ¤æ–·ä¾†æºæ˜¯ã€Œé›²ã€æˆ–ã€Œåœ°ã€    | âœ”ï¸ å¿…è¦  |
		| `RoutingDecisionFilter`    | æ±ºå®šè½‰é€ç›®æ¨™æˆ–æ¨™è¨˜ request | âœ”ï¸ å»ºè­°  |
		| Controller / RestTemplate  | æ ¹æ“šæ¨™è¨˜è½‰é€å¯¦éš›æµé‡       | âœ”ï¸ å¯¦ä½œ  |
