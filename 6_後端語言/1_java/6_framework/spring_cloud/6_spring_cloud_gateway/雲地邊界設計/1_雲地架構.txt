ref ChatGPT


âœ… æ¶æ§‹å»ºè­°ï¼šé›²ã€åœ°ç«¯å„è‡ªä¸€å¥— Gateway + Auth Server
	1.é›²ç«¯ï¼š
		é›²ç«¯ API Gatewayï¼šçµ±ä¸€å…¥å£ï¼Œè² è²¬å‰ç«¯æµé‡é€²å…¥ã€è·¯ç”±è½‰ç™¼ã€é™æµã€JWT é©—è­‰ç­‰ã€‚

		é›²ç«¯ Auth Serverï¼šæä¾› OAuth2 ç™¼ token åŠŸèƒ½ï¼ˆé€šå¸¸æ”¯æ´ client_credentialsã€authorization_code ç­‰ grantï¼‰ã€‚

	2.åœ°ç«¯ï¼š
		åœ°ç«¯ Gatewayï¼šåœ°ç«¯æ‰€æœ‰æœå‹™çš„çµ±ä¸€å…¥å£ï¼Œå¯¦ä½œçµ±ä¸€çš„å®‰å…¨é˜²è­·èˆ‡æˆæ¬Šé‚è¼¯ã€‚

		åœ°ç«¯ Auth Serverï¼šæœ‰æ™‚æ˜¯ç¨ç«‹ä¸€å¥—ï¼Œæœ‰æ™‚æ˜¯é›²ç«¯ Auth Server çš„ä¸€éƒ¨åˆ†å»¶ä¼¸ï¼Œæˆ– federation æ©Ÿåˆ¶å¯¦ä½œçš„æœ¬åœ°ä¿¡ä»»ç¯€é»ã€‚


	ğŸ” Token Exchange æ¨¡å¼ï¼ˆFederation / Trustï¼‰
		ç•¶é›²ç«¯æœå‹™éœ€è·¨ VPN å­˜å–åœ°ç«¯æœå‹™ï¼ˆæˆ–åä¹‹ï¼‰ï¼Œä¸å»ºè­°ç›´æ¥å°‡ JWT å‚³å…¥å…§éƒ¨æœå‹™ï¼Œå¯¦å‹™ä¸Šæœƒé€é é‚Šç•Œäº¤æ› token çš„æ–¹å¼è™•ç†ã€‚

		â–¶ï¸ é‹ä½œæµç¨‹ç¯„ä¾‹ï¼š
			1.é›²ç«¯å‰ç«¯ â†’ ç¶“é é›²ç«¯ Gateway + é›²ç«¯ Auth Server â†’ ç™¼å‡º access tokenã€‚

			2.é›²ç«¯å¾Œç«¯æœå‹™ A éœ€è¦å­˜å– åœ°ç«¯æœå‹™ Bï¼š

				å°å…§å‘¼å«ä¸€å€‹é›²ç«¯çš„ token exchange API æˆ–ç¶“é›²ç«¯ Gateway proxy åˆ°åœ°ç«¯ Gatewayã€‚

				é›²ç«¯ Gateway å°‡ JWT å¸¶åˆ°åœ°ç«¯ Gatewayï¼ˆé€šå¸¸ via Authorization: Bearerï¼‰ã€‚

			3.åœ°ç«¯ Gatewayï¼š

				é©—è­‰ JWTï¼ˆå¦‚æœä¿¡ä»»é›²ç«¯ç°½ç™¼è€…ï¼‰ï¼Œæˆ–

				é€²è¡Œ token exchangeï¼Œå‘åœ°ç«¯ Auth Server é‡æ–°ç°½ç™¼æ–°çš„ access tokenï¼ˆé‡å°åœ°ç«¯è³‡æºï¼‰ã€‚

				å†è½‰ç™¼è«‹æ±‚åˆ°åœ°ç«¯æœå‹™ Bã€‚
		âœ… å¥½è™•ï¼š
			å„è‡ªè‡ªæ²»ï¼šåœ°ç«¯å¯ä»¥ç¶­æŒå°é–‰ã€ä¸æš´éœ²å…§éƒ¨è³‡æºç´°ç¯€ã€‚

			å®‰å…¨éš”é›¢ï¼šé›²ç«¯ token ä¸ç›´æ¥è®“å…§éƒ¨æœå‹™é©—è­‰ã€‚

			å½ˆæ€§æˆæ¬Šï¼šåœ°ç«¯å¯é‡æ–°æ±ºå®šæ¬Šé™ç¯„åœã€éæœŸæ™‚é–“ç­‰ã€‚


		ğŸ” Token Exchange å¯¦ä½œæ–¹å¼
			å¯ä¾æƒ…å¢ƒé¸æ“‡ï¼š
				| æ¨¡å¼                                | æè¿°                                                                                  |
				| ---------------------------------- | ------------------------------------------------------------------------------------- |
				| **OAuth 2.1 Token Exchange Draft** | RFC 8693ï¼Œæ¨™æº–æ–¹å¼ï¼Œä½¿ç”¨ grant\_type = `urn:ietf:params:oauth:grant-type:token-exchange` |
				| **è‡ªå®šç¾© proxy + JWT é©—è­‰**          | åœ°ç«¯ gateway ä¿¡ä»»é›²ç«¯ç°½ç« çš„ JWTï¼ˆéœ€åŒæ­¥ public keyï¼‰ï¼Œç›´æ¥é©—è­‰                                |
				| **åœ°ç«¯é‡æ–°ç°½ç™¼ token**               | åœ°ç«¯ gateway æ¥å— JWTï¼Œè½‰æ›æˆ local tokenï¼ˆå¦ä¸€çµ„ scope/clientï¼‰                            |


		ğŸ“Œ ç¶œåˆå»ºè­°
			| é¸é …                                              | é©åˆæƒ…å¢ƒ                      | ç¶­è­·å»ºè­°                       |
			| ------------------------------------------------ | ---------------------------- | ---------------------------- |
			| âœ… RFC 8693 Token Exchange                       | é•·æœŸã€å¤šæ–¹æ•´åˆã€éœ€æˆæ¬Šæ¸…æ™°æ§ç®¡     | âœ…æ¨è–¦ä½œç‚ºä¸»è¦å¯¦ä½œæ–¹å¼           |
			| âš ï¸ JWT ç›´æ¥é©—ç°½ + è‡ªå®šç¾© Gateway é©—è­‰                | åˆæœŸç°¡æ˜“æ•´åˆã€çŸ­æœŸ PoC          | åƒ…é©åˆä½œç‚ºéæ¸¡æœŸæ©Ÿåˆ¶ï¼Œä¸å»ºè­°é•·ä¹…ä½¿ç”¨ |
			| âœ… Local Auth Re-signï¼ˆGateway è½‰ç™¼ + å…§éƒ¨é‡æ–°ç°½ç™¼ï¼‰ | å®‰å…¨åš´æ ¼éš”é›¢ã€åœ°ç«¯ä¸å¯è¦‹é›²ç«¯ token | å¯èˆ‡ RFC 8693 çµåˆä½œç‚ºå…§éƒ¨æ”¿ç­–   |


		âœ… æ¨è–¦ï¼šOAuth 2.1 Token Exchangeï¼ˆRFC 8693ï¼‰
			ğŸ”¹ ç‚ºä»€éº¼æ¨è–¦å®ƒï¼Ÿ
				| å„ªé»                                        | èªªæ˜                                                                      |
				| ------------------------------------------ | ------------------------------------------------------------------------ |
				| âœ… æ¨™æº–å”è­°                                  | æ¥­ç•Œèªå¯çš„è‰æ¡ˆæ¨™æº–ï¼Œè¨±å¤š Auth Serverï¼ˆå¦‚ Keycloakã€Auth0ã€PingFederateï¼‰å·²æ”¯æ´ã€‚ |
				| âœ… è·¨ç”¢å“å…¼å®¹                                | è‹¥å°‡ä¾†ä½ æ··ç”¨ä¸åŒ IAMï¼ˆå¦‚ Azure AD + æœ¬åœ° Keycloakï¼‰ï¼ŒRFC8693 æ˜¯å…±é€šèªè¨€ã€‚        |
				| âœ… æˆæ¬Šç¯„åœæ¸…æ¥š                              | å¯é™åˆ¶ exchanged token çš„ scopeã€audienceï¼Œç¢ºä¿ least privilegeã€‚            |
				| âœ… å¥½ç¶­é‹                                   | ä½¿ç”¨æ¨™æº– endpoint (`/token`) å’Œ Grant Typeï¼Œå¯å…±ç”¨ token é©—è­‰èˆ‡ç™¼è¡Œé‚è¼¯ã€‚       |
				| âœ… æ—¥å¾Œæ”¯æ´ Delegation / Impersonation æ›´å½ˆæ€§ | å¯è¨­å®š act-as / on-behalf-of æ¨¡å¼ï¼Œåˆ©æ–¼å¾®æœå‹™ç›¸äº’å‘¼å«ã€‚                        |


			âš™ï¸ RFC 8693 åŸºæœ¬æµç¨‹ï¼š
				1.A ç³»çµ±å–å¾— access tokenï¼ˆaccess_token_Aï¼‰ï¼›

				2.å‘¼å« token exchange endpointï¼ˆé€šå¸¸åœ¨ Auth Serverï¼‰ï¼š
					POST /oauth/token
					Content-Type: application/x-www-form-urlencoded

					grant_type=urn:ietf:params:oauth:grant-type:token-exchange
					&subject_token=access_token_A
					&subject_token_type=urn:ietf:params:oauth:token-type:access_token
					&audience=åœ°ç«¯APIæˆ–client-id
					&requested_token_type=urn:ietf:params:oauth:token-type:access_token
					&scope=åœ°ç«¯è³‡æºéœ€è¦çš„scope
				3.å›å‚³ä¸€å€‹æ–°çš„ access_token_Bï¼Œç”¨æ–¼å‘¼å«åœ°ç«¯æœå‹™ã€‚


é›²åœ°äº’ä¸²èˆ‡ auth server token exchange é‡é»
	1.è§£æä¾†æºåˆ°ç›®çš„ url è½‰ç™¼
	2.è‹¥å…¶ä¸­æœ‰è·¨é‚Šç•Œè¦è™•ç† token exchange å¾Œå¡å›åŸæœ¬çš„ header