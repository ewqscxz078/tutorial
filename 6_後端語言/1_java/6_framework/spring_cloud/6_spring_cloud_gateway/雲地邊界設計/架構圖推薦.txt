
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚         Client Browser       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                 (HTTPS)
                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ FONTEND-NGINX  â”‚  â† æä¾› JSP èˆ‡éœæ…‹è³‡æº
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  JSP WebApp    â”‚  â† é€é client_credentials å‘ Auth Server æ‹¿ JWT
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                                       --------------------â”‚
              API Call with Bearer										ç‰¹å®š API Call with Bearer
                              â–¼														     â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”								â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚-------------- â”‚ AP BACKEND NGINX LB  â”‚ â† åå‘ä»£ç†å¤šå€‹å¾Œç«¯æœå‹™      â”‚ VPN BACKEND NGINX LB â”‚ â† åå‘ä»£ç†å¤šå€‹å¾Œç«¯æœå‹™
       POST /token         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚														â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 	 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”								â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Auth Server	 â”‚	 â”‚ AP API Gateway       â”‚  â† é©—è­‰ JWTï¼Œè½‰ç™¼ API		    â”‚ VPN API Gateway       â”‚  â† é©—è­‰ JWTï¼Œè½‰ç™¼ API
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜								â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
							   â”‚														â”‚
						 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”							-------------------------
						 â”‚ AP Backend Microservice â”‚  â† ä¸éœ€è™•ç† JWT			-------------------------
						 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      						-------------------------
																						â”‚
																				â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
																				â”‚ åœ°ç«¯ VPN BACKEND NGINX LB â”‚  â† åå‘ä»£ç†å¤šå€‹å¾Œç«¯æœå‹™
																				â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
																						â”‚
																				â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
																				â”‚ åœ°ç«¯ VPN Backend Microserviceâ”‚  â† ä¸éœ€è™•ç† JWT ?
																				â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


	| å…ƒä»¶                            | å»ºè­°ä½ç½®                   | æ˜¯å¦ç¶“é Gateway        |
	| ------------------------------ | ------------------------ | ---------------------- |
	| JSP WebAppï¼ˆSpring Boot + JSPï¼‰ | ç¶“ NGINX æä¾›             | âŒ ä¸è¦èµ° Gateway       |
	| Auth Serverï¼ˆOAuth2ï¼‰           | ç¨ç«‹å°å¤–æš´éœ²ï¼ˆæˆ– NGINX è·¯ç”±ï¼‰ | âŒ ä¸æ‡‰ç¶“é Gateway     |
	| API Gateway                    | å°å¤–æš´éœ² APIï¼Œé©—è­‰ JWT      | âœ… æ˜¯ Resource Server  |
	| Backend Services               | å…§éƒ¨æœå‹™                   | âœ… è¢« Gateway è·¯ç”±      |

å¾Œç«¯æœå‹™æ‡‰è©²ç›´æ¥å‘¼å« Auth Serverï¼Œä¸ç¹ Gateway

ngnix å…è¨±å­˜å– auth server çš„ä¿è­·æªæ–½
	| ç›®æ¨™                          | å»ºè­°åšæ³•                                        |
	| ---------------------------- | ---------------------------------------------- |
	| ä¿è­· `/oauth2/token` endpoint | âœ… é™åˆ¶ IPã€âœ… mTLSã€âœ… å¼·å¯†ç¢¼ã€âœ… rate limit    |
	| ä¸è®“ä¸€èˆ¬äººéš¨æ„æ‰“                | âœ… é˜²æ­¢å¾ public internet å­˜å–                   |
	| ç¢ºä¿å…§éƒ¨æœå‹™æ‰å¯ç”¨               | âœ… ç”¨ private DNS æˆ– Nginx IP allowlist        |


	| å…ƒä»¶                      | è·è²¬                                                      | æ˜¯å¦é©—è­‰ JWT                        | å®‰å…¨é—œéµ                                   |
	| ------------------------ | -------------------------------------------------------- | ---------------------------------- | ---------------------------------------- |
	| **NGINXï¼ˆå‰ç«¯ï¼‰**          | æä¾› JSP é é¢èˆ‡éœæ…‹è³‡æº                                      | âŒ ä¸é©—è­‰ JWT                      | å¯åŠ é˜²ç«ç‰† / ä¾†æºé™åˆ¶                        |
	| **JSP WebApp**           | ä½¿ç”¨ client\_credentials å‘ Auth Server æ‹¿ tokenï¼Œå‘¼å« API  | âŒ ä¸é©—è­‰                           | client\_id / secret è¦ä¿è­·å¥½               |
	| **Auth Server**          | ç™¼ tokenã€è™•ç† client é©—è­‰                                  | âœ… é©— client èªè­‰èˆ‡ scope           | ç¦æ­¢æš´éœ²æ•æ„Ÿ metadata                       |
	| **API Gateway**          | Resource Serverï¼Œé©—è­‰ JWTï¼Œè½‰ç™¼åˆæ³•è«‹æ±‚                       | âœ… é©—è­‰ JWTã€issuerã€audã€expã€scope | ä¸å¯è®“ JWT é€šéæœªé©—è­‰                       |
	| **NGINX LBï¼ˆå…§éƒ¨ï¼‰**       | è² è²¬è² è¼‰å¹³è¡¡å¾Œç«¯æœå‹™                                         | âŒ ä¸é©—è­‰ JWT                       | åƒ…å…è¨± API Gateway å­˜å–                    |
	| **Backend Microservice** | å°ˆæ³¨è™•ç† API æ¥­å‹™é‚è¼¯ï¼Œä¸ç®¡ JWT                               | âŒ ä¸é©—è­‰ JWTï¼ˆä¿¡ä»» gatewayï¼‰         | ä¸ä¿¡ä»»å¤–éƒ¨ headerï¼ˆå¦‚ `X-User-*`ï¼‰é™¤éå°è£å¥½  |



é›²ç«¯ä¸€èˆ¬æ¥­å‹™æµç¨‹
	Cloud Front NGINX
		 â†“
	é›²ç«¯ä¸€èˆ¬ JSP å‰ç«¯æœå‹™
		 â†“
	é›²ç«¯ ap-api-gateway (é©— JWT)
		 â†“
	é›²ç«¯ ap-BACKEND NGINX LB
		 â†“
	é›²ç«¯ ap-Backend Microservice

	âœ”ï¸ å¯è¡Œè€Œä¸”æ˜¯å…¸å‹çš„å¾®æœå‹™æ¶æ§‹
		* å»ºè­°æ‰€æœ‰ API éƒ½å…ˆç¶“é ap-api-gateway åš JWT é©—è­‰èˆ‡è·¯ç”±

		* ap-BACKEND NGINX åªæ¥å—ä¾†è‡ª ap-api-gateway

		* å¾Œç«¯ç„¡éœ€é©—è­‰ JWTï¼Œåªä¿¡ä»» header

é›²ç«¯ã€Œç‰¹å®šã€JSP å‰ç«¯ â†’ é›²ç«¯ VPN æœå‹™æµç¨‹
	Cloud Front NGINX
		 â†“
	é›²ç«¯ã€Œç‰¹å®šã€JSP å‰ç«¯
		 â†“
	é›²ç«¯ vpn-api-gateway (é©— JWT)
		 â†“
	é›²ç«¯ vpn-BACKEND NGINX LB
		 â†“
	é›²ç«¯ vpn-Backend Microservice

	âœ”ï¸ å®Œå…¨å¯è¡Œï¼Œé€™ä»£è¡¨æŸäº›æœå‹™é‚è¼¯è¢«åŠƒåˆ†åˆ° VPN å°ˆå€ï¼ˆå¦‚ HR, è²¡å‹™ï¼‰
		* vpn-api-gateway è² è²¬é©—è­‰ JWT

		* vpn-BACKEND NGINX åƒ…å…è¨± gateway IP

		* ç‰¹å®š JSP App å¯ä»¥æœ‰è‡ªå·±çš„å°ˆç”¨ client_id èˆ‡ scope


ç‰¹å®š JSP å‰ç«¯ â†’ é›²ç«¯ vpn-api-gateway â†’ è½‰å°åˆ°åœ°ç«¯æœå‹™ï¼ˆè·¨ VPNï¼‰
	Cloud Front NGINX
		 â†“
	é›²ç«¯ç‰¹å®š JSP å‰ç«¯
		 â†“
	é›²ç«¯ vpn-api-gateway
		 â†“
	[è½‰å°åˆ°] åœ°ç«¯ vpn-api-gateway
		 â†“
	åœ°ç«¯ vpn-BACKEND NGINX LB
		 â†“
	åœ°ç«¯å¾Œç«¯æœå‹™

	âœ… åœ°ç«¯è½‰å°æ¶æ§‹çš„é—œéµè¨­è¨ˆå»ºè­°
		| é¢å‘                             | å»ºè­° / èªªæ˜                                                                                         |
		| ------------------------------- | -------------------------------------------------------------------------------------------------- |
		| âœ… é›²ç«¯ vpn-api-gateway å¦‚ä½•è½‰å°ï¼Ÿ | å¯ä½¿ç”¨ Spring Cloud Gateway route å°‡ç‰¹å®šè·¯å¾‘è½‰åˆ°åœ°ç«¯ï¼Œä¾‹å¦‚ `http://onprem-vpn-api.company.local`         |
		| âœ… JWT é©—è­‰è¦åšå“ªè£¡ï¼Ÿ              | å»ºè­°é›²ç«¯ vpn-api-gateway å…ˆé©—è­‰ï¼Œåœ°ç«¯åªæ¥æ”¶ä¿¡ä»» header<br>ï¼ˆè‹¥è³‡å®‰è¦æ±‚é«˜ï¼Œä¹Ÿå¯åœ¨åœ°ç«¯å†é©—ä¸€æ¬¡ï¼‰                  |
		| âœ… å®‰å…¨é€šé“å»ºè­°ï¼Ÿ                  | å»ºè­°èµ°å°ˆç·š / site-to-site VPNï¼Œä¸¦é…åˆ mTLS æˆ– IP ç™½åå–®é™åˆ¶                                              |
		| âœ… ç¶²è·¯æ•ˆèƒ½è€ƒé‡ï¼Ÿ                  | è·¨ VPN latency å¢é«˜ï¼Œè¦èª¿æ•´ gateway timeout / retry ç­–ç•¥                                               |
		| âœ… å¦‚ä½•è¾¨è­˜å“ªäº› API è¦è½‰å°ï¼Ÿ        | å¯ç”¨ path predicate `/api/onprem/**` æˆ– client scope ä¾†åˆ¤æ–·                                           |
		| âœ… Header å‚³éèˆ‡é˜²å½ï¼Ÿ            | é›²ç«¯ gateway æ‡‰å°‡ JWT claims è½‰ç‚ºå®‰å…¨ headerï¼ˆå¦‚ `X-Auth-User`ï¼‰ï¼Œåœ°ç«¯ä¸å¯ä¿¡ä»»å¤–éƒ¨å‚³ä¾†çš„ header é™¤éä¾†æºå¯ä¿¡   |


âœ… å°çµï¼šä¸‰ç¨®æƒ…å¢ƒå¯è¡Œæ€§èˆ‡å»ºè­°
	| è·¯ç”±æƒ…å¢ƒ                                      | å¯è¡Œæ€§             | å»ºè­°                                     |
	| ------------------------------------------- | ----------------- | --------------------------------------- |
	| ä¸€èˆ¬ JSP â†’ ap-api-gateway â†’ é›²ç«¯ backend      | âœ… ç©©å®šåŸºæœ¬æ¨¡å¼     | ç„¡é ˆç‰¹åˆ¥ä¿®æ”¹                               |
	| ç‰¹å®š JSP â†’ vpn-api-gateway â†’ é›²ç«¯ vpn backend | âœ… åˆ†å€ç®¡æ§æ˜ç¢º     | å»ºè­°åŠ  IP æ§åˆ¶èˆ‡ scope é©—è­‰                 |
	| ç‰¹å®š JSP â†’ vpn-api-gateway â†’ åœ°ç«¯ vpn gateway | âœ… é«˜éšæ¶æ§‹ï¼ˆæ··åˆé›²ï¼‰| å¿…é ˆæ§åˆ¶ timeoutã€å®‰å…¨æ€§ã€ä¾†æº IPã€è·¨ VPN èªè­‰ |



ğŸŒ é›²æ‰“åœ°æµç¨‹ï¼ˆå« Token Exchangeï¼‰
	1.Browser â†’ Cloud Frontend

		ä½¿ç”¨è€…ç™»å…¥æˆ–æ”œå¸¶ JWTï¼Œæ‰“åˆ°é›²ç«¯å‰ç«¯æœå‹™ã€‚

	2.Cloud Frontend â†’ Cloud Auth Server

		å‰ç«¯æœå‹™ç”¨è‡ªå·±çš„ clientId/secretï¼Œå¾ Cloud Auth Server æ‹¿ä¸€å¼µ cloud access token (cloud-jwt)ã€‚

		é€™å¼µ token çš„ audience = cloud-vpn-gatewayã€‚

	3.Cloud Frontend â†’ Cloud VPN Gateway

		å‰ç«¯æœå‹™å¸¶è‘— cloud-jwtï¼Œæ‰“åˆ° Cloud VPN Gatewayã€‚

		Cloud VPN Gateway é©—è­‰ cloud-jwtï¼ˆç”± Cloud Auth Server ç°½ç™¼ï¼‰ã€‚

	4.Cloud VPN Gateway â†’ Token Exchange (Cloud AS â†” On-prem AS)

		Cloud VPN Gateway ç”¨ cloud-jwt å» Cloud Auth Server /token/exchangeã€‚

		Cloud Auth Server å’Œ On-prem Auth Server å»ºç«‹ federationï¼Œäº¤æ›å¾—åˆ°ä¸€å¼µ onprem-jwtï¼ˆaudience = onprem-gateway / onprem-serviceï¼‰ã€‚

	5.Cloud VPN Gateway â†’ On-prem Gateway (via VPN tunnel)

		Cloud VPN Gateway å¸¶è‘— onprem-jwtï¼Œé€é VPN tunnel æ‰“ On-prem Gatewayã€‚

	6.On-prem Gateway â†’ On-prem Backend Service

		On-prem Gateway é©— onprem-jwtï¼ˆç”± On-prem Auth Server ç°½ç™¼ï¼‰ã€‚

		é©—è­‰é€šéå¾Œï¼Œè½‰ç™¼è«‹æ±‚åˆ°åœ°ç«¯å¾Œç«¯æœå‹™ã€‚