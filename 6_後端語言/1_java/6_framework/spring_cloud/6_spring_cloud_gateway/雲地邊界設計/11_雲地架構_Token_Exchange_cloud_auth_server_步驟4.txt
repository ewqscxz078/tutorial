// Cloud Auth Server: è‡ªå®šç¾© Token Exchange Grant (RFC 8693 å¯¦ä½œ)
	âœ… çµ„ä»¶ç°¡ä»‹

		1.TokenExchangeAuthenticationToken
			* å°è£ client æä¾›çš„ subject_token å’Œ audience

			* æ˜¯ä½ è‡ªå®šç¾©çš„ã€ŒToken Exchange è«‹æ±‚ç‰©ä»¶ã€

		2.TokenExchangeAuthenticationConverter
			* è§£æ /token è«‹æ±‚ä¸­çš„ grant_type=urn:ietf:params:oauth:grant-type:token-exchange èˆ‡åƒæ•¸

			* çµ„æˆ TokenExchangeAuthenticationToken ä½œç‚º Authentication

		3ï¸.TokenExchangeAuthenticationProvider
			* è™•ç†æ› token çš„å¯¦éš›é‚è¼¯

			* å¯é©—è­‰åŸå§‹ subject_tokenï¼ˆé€™é‚Šç‚ºç°¡åŒ–ï¼Œç›´æ¥å‡è¨­æˆåŠŸï¼‰

			* ç°½ç™¼æ–° access tokenï¼ˆç”¨ OAuth2AccessTokenAuthenticationTokenï¼‰

		ğŸ“æ³¨æ„äº‹é …ï¼š
			JwtDecoders.fromIssuerLocation("http://localhost:9000") å‡è¨­ä½ æœ‰å•Ÿç”¨ JWK ç™¼ä½ˆï¼ˆ/.well-known/openid-configuration + /oauth2/jwksï¼‰

			å¦‚æœ issuer URI æ”¹è®Šï¼Œè¨˜å¾—åŒæ­¥èª¿æ•´

	// 1. TokenExchangeAuthenticationTokenï¼šå°è£ subject_token èˆ‡ audience
		public class TokenExchangeAuthenticationToken extends AbstractAuthenticationToken {
			private final String subjectToken;
			private final String audience;

			public TokenExchangeAuthenticationToken(String subjectToken, String audience) {
				super(null);
				this.subjectToken = subjectToken;
				this.audience = audience;
				setAuthenticated(false);
			}

			@Override
			public Object getCredentials() {
				return subjectToken;
			}

			@Override
			public Object getPrincipal() {
				return audience;
			}

			public String getSubjectToken() {
				return subjectToken;
			}

			public String getAudience() {
				return audience;
			}
		}

	// 2. TokenExchangeAuthenticationConverterï¼šå¾ HTTP è«‹æ±‚è§£ææˆ TokenExchangeAuthenticationToken
		public class TokenExchangeAuthenticationConverter implements AuthenticationConverter {
			@Override
			public Authentication convert(HttpServletRequest request) {
				String grantType = request.getParameter(OAuth2ParameterNames.GRANT_TYPE);
				if (!"urn:ietf:params:oauth:grant-type:token-exchange".equals(grantType)) {
					return null;
				}

				String subjectToken = request.getParameter("subject_token");
				String audience = request.getParameter("audience");

				if (StringUtils.hasText(subjectToken) && StringUtils.hasText(audience)) {
					return new TokenExchangeAuthenticationToken(subjectToken, audience);
				}

				return null;
			}
		}

	// 3. TokenExchangeAuthenticationProviderï¼šè™•ç†æ› token çš„é‚è¼¯ (é™ç¸®æ¬Šé™)
		public class TokenExchangeAuthenticationProvider implements AuthenticationProvider {

			private final JwtDecoder jwtDecoder;

			public TokenExchangeAuthenticationProvider() {
				this.jwtDecoder = JwtDecoders.fromIssuerLocation("http://localhost:9000");
			}

			@Override
			public Authentication authenticate(Authentication authentication) throws AuthenticationException {
				TokenExchangeAuthenticationToken request = (TokenExchangeAuthenticationToken) authentication;

				String subject;
				try {
					Jwt jwt = jwtDecoder.decode(request.getSubjectToken());
					subject = jwt.getSubject(); // å–å¾— sub æ¬„ä½
				} catch (JwtException e) {
					throw new OAuth2AuthenticationException(new OAuth2Error("invalid_token", "JWT é©—ç°½å¤±æ•—", null));
				}

				OAuth2AccessToken accessToken = new OAuth2AccessToken(
					OAuth2AccessToken.TokenType.BEARER,
					UUID.randomUUID().toString(),
					Instant.now(),
					Instant.now().plus(600, ChronoUnit.SECONDS)
				);

				Map<String, Object> claims = Map.of(
					"sub", subject,
					"aud", request.getAudience(),
					"scope", "read onprem"
				);

				return new OAuth2AccessTokenAuthenticationToken(
					new OAuth2ClientAuthenticationToken("client-a", null, null),
					accessToken,
					new OAuth2TokenClaimsSet(claims)
				);
			}

			@Override
			public boolean supports(Class<?> authentication) {
				return TokenExchangeAuthenticationToken.class.isAssignableFrom(authentication);
			}
		}

	// 4. åœ¨ Authorization Server ä¸­è¨»å†Š converter èˆ‡ provider
		@Configuration
		public class AuthorizationServerConfig {

			@Bean
			public SecurityFilterChain authServerSecurityFilterChain(HttpSecurity http) throws Exception {
				OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http);

				http.getConfigurer(OAuth2AuthorizationServerConfigurer.class)
					.tokenEndpoint(tokenEndpoint -> tokenEndpoint
						.accessTokenRequestConverter(new TokenExchangeAuthenticationConverter())
						.authenticationProvider(new TokenExchangeAuthenticationProvider()));

				return http.build();
			}
		}



å‚™è¨»èªªæ˜
	ç•¶ä½ ä½¿ç”¨ JwtDecoder.decode(...) æ™‚ï¼Œå®ƒæœƒè‡ªå‹•åšä»¥ä¸‹äº‹æƒ…ï¼š
		| é©—è­‰å…§å®¹                          | èªªæ˜                                                                        |
		| -------------------------------- | -------------------------------------------------------------------------  |
		| âœ… **ç°½ç« é©—è­‰**                   | æ ¹æ“š `JwtDecoder` åˆå§‹åŒ–æ™‚æ‰€è¨­å®šçš„ JWK æˆ– public key å° JWT ç°½ååšé©—è­‰ã€‚å¯é˜²æ­¢å½é€ ã€‚ |
		| âœ… **éæœŸæ™‚é–“é©—è­‰**                | è‹¥ JWT æœ‰ `exp` æ¬„ä½ï¼Œæœƒè‡ªå‹•æª¢æŸ¥æ˜¯å¦éæœŸã€‚                                       |
		| âœ… **not-before (`nbf`) é©—è­‰**   | è‹¥æœ‰ `nbf` æ¬„ä½ï¼Œæœƒæª¢æŸ¥æ˜¯å¦å°šæœªç”Ÿæ•ˆã€‚                                             |
		| âœ… **issued-at (`iat`) åˆæ³•æ€§**   | å¯é¸é©—è­‰ç°½ç™¼æ™‚é–“æ˜¯å¦åˆæ³•ï¼ˆéå¿…è¦ï¼‰ã€‚                                              |
		| âŒ **audience / scope ç­‰æ¬„ä½é‚è¼¯** | é è¨­ä¸æœƒé©—é€™äº›ï¼Œä½ è¦è‡ªè¡ŒåŠ é‚è¼¯æª¢æŸ¥ã€‚                                              |


	Q:ç‚ºä»€éº¼æˆ‘å€‘é‚„è¦æŠŠé›²ç«¯ tokenã€Œè½‰ä¹˜ã€ä¸€å€‹ exchanged tokenï¼Ÿå’Œç›´æ¥æ‹¿é›²ç«¯ token å»æ‰“åœ°ç«¯ API æœ‰ä»€éº¼å·®åˆ¥ï¼Ÿ
		é€™å…¶å¯¦æ˜¯ OAuth 2.1 Token Exchangeï¼ˆRFC 8693ï¼‰çš„æ ¸å¿ƒåƒ¹å€¼æ‰€åœ¨ã€‚
		ğŸ¯ ç°¡å–®æ¯”å–»ï¼šç‚ºä»€éº¼ä¸æ˜¯ç›´æ¥ç”¨é›²ç«¯ tokenï¼Ÿ
			æƒ³åƒä½ æœ‰ä¸€å¼µé–€ç¦å¡å¯ä»¥é€²å…¥ã€Œé›²ç«¯å¤§æ¨“ã€ï¼Œç¾åœ¨ä½ è¦å¾é›²ç«¯è·¨ VPN é€²å…¥ã€Œåœ°ç«¯å¤§æ¨“ã€ï¼Œä½ èƒ½ä¸èƒ½ç›´æ¥æ‹¿åŒä¸€å¼µå¡é€²å»ï¼Ÿ
				âŒ é€šå¸¸ä¸è¡Œï¼Œå› ç‚ºåœ°ç«¯æœ‰è‡ªå·±çš„è¦å‰‡ã€ä¿¡ä»»é‚Šç•Œèˆ‡æˆæ¬Šæ¨¡å‹
		âœ… ç‚ºä»€éº¼è¦ exchange tokenï¼Ÿç›®çš„å¦‚ä¸‹ï¼š
			1ï¸.é‚Šç•Œæ§åˆ¶ï¼ˆSecurity Boundaryï¼‰
				* é›²ç«¯ token ç”±é›²ç«¯ Auth Server ç°½ç™¼ï¼Œåœ°ç«¯æœå‹™ä¸ä¸€å®šé¡˜æ„ä¿¡ä»»ã€‚

				* å³ä½¿ç°½ç« ä¿¡å¾—éï¼Œåœ°ç«¯ä¹Ÿå¯èƒ½åªæ¥å—ã€Œæœ‰é™ scopeã€çš„ tokenã€‚

				â†’ é€éäº¤æ›ï¼Œåœ¨ Gateway-to-Gateway é‚Šç•Œé‡ç°½ï¼Œæ‰èƒ½æ§åˆ¶æ¬Šé™ã€‚

			2.æœ€å°æ¬Šé™ï¼ˆLeast Privilegeï¼‰
				* åŸæœ¬çš„é›²ç«¯ token å¯èƒ½æœ‰å¾ˆå»£çš„æ¬Šé™ï¼ˆread/write/scope:allï¼‰ã€‚

				* ç¶“ç”± Token Exchangeï¼Œå¯æ›æˆä¸€å€‹åªæˆæ¬Šå­˜å–åœ°ç«¯è³‡æºã€åªæœ‰ read æ¬Šé™çš„ tokenã€‚

				â†’ é€™æ¨£å³ä½¿ leakedï¼Œå‚·å®³ç¯„åœä¹Ÿå°ã€‚

			3.Token å†å°è£ï¼ˆaudience / client æ”¹è®Šï¼‰
				* åŸ token æ˜¯ç™¼çµ¦é›²ç«¯ API ç”¨çš„ï¼ˆaudience ç‚º cloud-serviceï¼‰

				* åœ°ç«¯ API éœ€è¦ audience ç‚º onprem-api

				â†’ Token Exchange å¯æŠŠ token audience æ”¹æˆåœ°ç«¯æ¥å—çš„æ ¼å¼ã€‚

			4.Delegation / Impersonation èƒ½åŠ›
				* ä½ å¯æŒ‡å®šï¼šã€Œç”¨ä½¿ç”¨è€… Alice çš„åç¾©ã€è«‹æ±‚åœ°ç«¯è³‡æºã€‚

				* Exchange token å¯åŠ ä¸Š act_as æˆ– on_behalf_of è³‡è¨Šï¼ˆRFC æ”¯æ´ï¼‰

			ğŸš« å¦‚æœä½ ä¸ exchangeï¼Œæœƒæœ‰ä»€éº¼å•é¡Œï¼Ÿ
				| å•é¡Œ                    | èªªæ˜                                                        |
				| ---------------------- | ---------------------------------------------------------- |
				| âŒ ç„¡æ³•æ§ç®¡åœ°ç«¯ scope    | é›²ç«¯ç™¼çš„ token å¯èƒ½æ¬Šé™å¤ªå»£ï¼Œåœ°ç«¯é›£ä»¥æˆæ¬Šã€‚                        |
				| âŒ åœ°ç«¯é›£ä»¥é©—è­‰          | è‹¥ä¸ä¿¡ä»» issuerã€ç„¡æ³•åŒæ­¥ JWKã€æˆ–ç„¡æ³•ç†è§£ JWT æ ¼å¼ï¼Œåœ°ç«¯å°±æ²’è¾¦æ³•è™•ç†ã€‚ |
				| âŒ audit trail ä¸æ¸…æ¥š   | èª°ç”¨èª°çš„èº«åˆ†ï¼Ÿç¼ºä¹ act-as / delegation è³‡è¨Šã€‚                   |
				| âŒ å®‰å…¨æ¨¡å‹è¢«æ‰“ç ´         | token è·‘å‡ºåŸæœ¬æˆæ¬Šé‚Šç•Œï¼Œå®¹æ˜“é€ æˆä¿¡ä»»éˆå¤±æ§ã€‚                       |


			âœ… å°çµä¸€å¥è©±ï¼š
				ã€ŒToken Exchange æ˜¯ä¸€ç¨® æ¬Šé™ç¸®æ¸› + é‚Šç•Œè½‰æ› çš„æ©Ÿåˆ¶ï¼Œç¢ºä¿ token åœ¨è·¨ç³»çµ±ã€è·¨ç¶²åŸŸã€è·¨ä¿¡ä»»å€æ™‚ä»ç„¶ç¬¦åˆ æœ€å°æ¬Šé™ã€å®‰å…¨éš”é›¢ åŸå‰‡ã€‚ã€

==================================================================================================================================================
==================================================================================================================================================
==================================================================================================================================================
âœ… æ”¯æ´åŠŸèƒ½ï¼ˆé›™å‘é€šç”¨ï¼‰
	| åŠŸèƒ½                        | èªªæ˜                                                     |
	| -------------------------- | -------------------------------------------------------  |
	| ğŸ” `subject_token` é©—è­‰     | é©—è­‰ JWT æ˜¯å¦æœ‰æ•ˆã€æ˜¯å¦åˆæ³•                                  |
	| ğŸ¯ `audience` è™•ç†          | å¯æ ¹æ“šäº¤æ›ç›®æ¨™å‹•æ…‹è¨­å®š audience                              |
	| ğŸ§¾ `scope` é™ç¸®             | è¢«äº¤æ›å¾Œçš„ token å¯æ¸›å°‘æ¬Šé™                                 |
	| ğŸ§‘â€ğŸ’¼ `act` impersonation     | æ–° token å¯é™„åŠ ä»£è¡¨ä½¿ç”¨è€…çš„è³‡è¨Šï¼ˆå¦‚ `act.sub`ï¼‰                |
	| ğŸ” é›²è½‰åœ° / åœ°è½‰é›² å…±ç”¨       | å¯åœ¨é›² / åœ°ç«¯å„è‡ªéƒ¨ç½²ï¼Œäº¤æ›å°æ–¹ token å†é‡æ–°ç°½ç™¼æˆè‡ªå·±ä¿¡ä»»çš„ token |

ğŸ” æ‡‰ç”¨æ¡ˆä¾‹
	| æ¡ˆä¾‹            | æµç¨‹                                                                                |
	| -------------- | ---------------------------------------------------------------------------------- |
	| é›²ç«¯è¦å«åœ°ç«¯æœå‹™  | é›²ç«¯ Gateway ç™¼ token exchange è«‹æ±‚çµ¦åœ°ç«¯ Auth Serverï¼Œç”¨ cloud token æ›æˆåœ°ç«¯ token     |
	| åœ°ç«¯è¦å«é›²ç«¯ API | åœ°ç«¯ Gateway ç™¼ token exchange è«‹æ±‚çµ¦é›²ç«¯ Auth Serverï¼Œç”¨ onprem token æ›æˆ cloud token |

	å…©é‚Šéƒ½å¯ä»¥ç”¨é€™ä»½ Grant å¯¦ä½œï¼Œä¸é ˆåˆ†ç‰ˆæœ¬ã€‚


æ¨™æº–ç‰ˆå¯«æ³•
	// âœ… TokenExchangeAuthenticationToken.java - è¡¨ç¤º token exchange è«‹æ±‚
	public class TokenExchangeAuthenticationToken extends AbstractAuthenticationToken {

		private final String grantType;
		private final String subjectToken;
		private final String subjectTokenType;
		private final String audience;
		private final String requestedTokenType;
		private final Set<String> scopes;

		public TokenExchangeAuthenticationToken(String subjectToken, String subjectTokenType,
												String audience, String requestedTokenType,
												Set<String> scopes) {
			super(null);
			this.grantType = "urn:ietf:params:oauth:grant-type:token-exchange";
			this.subjectToken = subjectToken;
			this.subjectTokenType = subjectTokenType;
			this.audience = audience;
			this.requestedTokenType = requestedTokenType;
			this.scopes = scopes;
			setAuthenticated(false);
		}

		public String getSubjectToken() { return subjectToken; }
		public String getSubjectTokenType() { return subjectTokenType; }
		public String getAudience() { return audience; }
		public String getRequestedTokenType() { return requestedTokenType; }
		public Set<String> getScopes() { return scopes; }

		@Override
		public Object getCredentials() { return subjectToken; }
		@Override
		public Object getPrincipal() { return null; }
	}


	// âœ… TokenExchangeAuthenticationConverter.java - å°‡ HTTP request è½‰æˆèªè­‰è«‹æ±‚ç‰©ä»¶
	public class TokenExchangeAuthenticationConverter implements AuthenticationConverter {
		@Override
		public Authentication convert(HttpServletRequest request) {
			String grantType = request.getParameter("grant_type");
			if (!"urn:ietf:params:oauth:grant-type:token-exchange".equals(grantType)) {
				return null;
			}

			String subjectToken = request.getParameter("subject_token");
			String subjectTokenType = request.getParameter("subject_token_type");
			String audience = request.getParameter("audience");
			String requestedTokenType = request.getParameter("requested_token_type");
			String scopeParam = request.getParameter("scope");
			Set<String> scopes = (scopeParam != null) ? new HashSet<>(Arrays.asList(scopeParam.split(" "))) : Collections.emptySet();

			return new TokenExchangeAuthenticationToken(subjectToken, subjectTokenType, audience, requestedTokenType, scopes);
		}
	}


	// âœ… TokenExchangeAuthenticationProvider.java - é©—è­‰ subject token ä¸¦ç”¢å‡ºæ–° token
	public class TokenExchangeAuthenticationProvider implements AuthenticationProvider {

		private final JwtDecoder jwtDecoder;
		private final JwtEncoder jwtEncoder;

		public TokenExchangeAuthenticationProvider(JwtDecoder jwtDecoder, JwtEncoder jwtEncoder) {
			this.jwtDecoder = jwtDecoder;
			this.jwtEncoder = jwtEncoder;
		}

		@Override
		public Authentication authenticate(Authentication authentication) throws AuthenticationException {
			TokenExchangeAuthenticationToken token = (TokenExchangeAuthenticationToken) authentication;

			Jwt jwt;
			try {
				jwt = jwtDecoder.decode(token.getSubjectToken());
			} catch (JwtException e) {
				throw new OAuth2AuthenticationException(OAuth2ErrorCodes.INVALID_GRANT, "Invalid subject_token", e);
			}

			String subject = jwt.getSubject();
			String audience = token.getAudience();

			Map<String, Object> claims = new HashMap<>();
			claims.put("sub", subject);
			claims.put("aud", List.of(audience));
			claims.put("scope", String.join(" ", token.getScopes()));
			claims.put("act", Map.of("sub", subject)); // impersonation trace

			JwtClaimsSet claimsSet = JwtClaimsSet.builder()
					.subject(subject)
					.issuedAt(Instant.now())
					.expiresAt(Instant.now().plus(Duration.ofMinutes(5)))
					.claims(c -> c.putAll(claims))
					.build();

			JwsHeader header = JwsHeader.with(() -> "RS256").build();
			Jwt encoded = jwtEncoder.encode(JwtEncoderParameters.from(header, claimsSet));

			OAuth2AccessToken tokenValue = new OAuth2AccessToken(
					OAuth2AccessToken.TokenType.BEARER,
					encoded.getTokenValue(),
					encoded.getIssuedAt(),
					encoded.getExpiresAt(),
					token.getScopes());

			return new OAuth2AccessTokenAuthenticationToken(null, tokenValue, encoded.getClaims());
		}

		@Override
		public boolean supports(Class<?> authentication) {
			return TokenExchangeAuthenticationToken.class.isAssignableFrom(authentication);
		}
	}


	// âœ… åœ¨ AuthorizationServerConfig.java è¨»å†Šé€™å€‹è‡ªè¨‚ Grant
	@Bean
	public SecurityFilterChain authServerSecurityFilterChain(HttpSecurity http, JwtDecoder jwtDecoder, JwtEncoder jwtEncoder) throws Exception {
		OAuth2AuthorizationServerConfigurer<HttpSecurity> authorizationServerConfigurer =
				new OAuth2AuthorizationServerConfigurer<>();

		authorizationServerConfigurer
			.tokenEndpoint(tokenEndpoint -> tokenEndpoint
				.accessTokenRequestConverter(new DelegatingAuthenticationConverter(
					List.of(
						new TokenExchangeAuthenticationConverter(),
						new OAuth2AuthorizationCodeAuthenticationConverter(),
						new OAuth2RefreshTokenAuthenticationConverter()
					))
				.authenticationProvider(new TokenExchangeAuthenticationProvider(jwtDecoder, jwtEncoder)));

		http
			.securityMatcher(authorizationServerConfigurer.getEndpointsMatcher())
			.authorizeHttpRequests(authorize -> authorize.anyRequest().authenticated())
			.csrf(AbstractHttpConfigurer::disable)
			.apply(authorizationServerConfigurer);

		return http.build();
	}



=============================

âœ… é‚£å¯¦å‹™ä¸Šé€™äº›åƒæ•¸æ€éº¼ä¾†ï¼Ÿ
	é€šå¸¸ä½ æœƒé€™æ¨£è¨­è¨ˆç™¼èµ·æ–¹ï¼ˆä»¥ Spring Gateway ç‚ºä¾‹ï¼‰ï¼š
		| è³‡è¨Š                  | ä¾†æº                                       | ç¯„ä¾‹                                         |
		| -------------------- | ----------------------------------------- | ------------------------------------------- |
		| `subject_token`      | å¾åŸå§‹ request çš„ Authorization Header å–å‡º  | `"Bearer eyJ..."`                           |
		| `audience`           | æ ¹æ“šç›®æ¨™ API å°æ‡‰è¨­å®š                         | `"onprem-api"`                              |
		| `scope`              | æ ¹æ“šç›®æ¨™è³‡æºéœ€æ±‚ï¼Œå›ºå®šæˆ–è‡ªå‹•æ±ºå®š                 | `"read"`                                    |
		| `token_exchange_url` | è¨­å®šæ–¼ yml æˆ– env åƒæ•¸ä¸­                     | `"https://onprem-auth-server/oauth2/token"` |
