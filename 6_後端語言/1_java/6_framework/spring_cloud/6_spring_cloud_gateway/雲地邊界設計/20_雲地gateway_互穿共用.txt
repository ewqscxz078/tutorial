ref ChatGPT

âœ… å»ºè­°ï¼š
	ã€Œå…±ç”¨ä¸€ä»½ Java è·¯ç”±é‚è¼¯ç¨‹å¼ç¢¼ï¼Œæ­é…ä¸åŒçš„ application.yml è·¯ç”±è¨­å®šã€æ˜¯ âœ”ï¸ æ¨è–¦æ–¹å¼ï¼Œå°¤å…¶åœ¨ é›²ç«¯ Gateway èˆ‡åœ°ç«¯ Gateway æ¡ç”¨ç›¸åŒæ¡†æ¶ï¼ˆå¦‚ WebMvc Gatewayï¼‰æ™‚ã€‚

	é›²åœ°äº’ç©¿å…±ç”¨å¯«æ³•ï¼Œä¸ç”¨å¯« spring.cloud.gateway.routes

ğŸ¯ ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆæ˜¯å¥½ä¸»æ„ï¼Ÿ
	âœ… å„ªé»ï¼š
		| å„ªé»              | èªªæ˜                                                               |
		| ---------------- | ----------------------------------------------------------------- |
		| âœ… **ç¶­è­·ä¸€å¥—é‚è¼¯** | å…±ç”¨ filter/interceptor/controller ç­‰ Java ç¨‹å¼ç¢¼ï¼Œé‚è¼¯çµ±ä¸€ã€‚         |
		| âœ… **ç’°å¢ƒå½ˆæ€§é«˜**  | é€éä¸åŒ `application.yml` æŒ‡å®šã€Œè½‰ç™¼åˆ°èª°ã€ã€ã€Œå…è¨±å“ªäº› audienceã€ç­‰è¨­å®šã€‚ |
		| âœ… **ç›¸å®¹ä¸åŒæ‹“æ’²** | é›²èˆ‡åœ°å¯ä»¥äº’ç‚º gatewayï¼Œå½¼æ­¤ç‚ºè½‰ç™¼è·³æ¿ï¼Œä¸éœ€å¯«æ­»å°æ–¹ä½ç½®ã€‚                 |
		| âœ… **éƒ¨ç½²å‹å–„**    | åŒä¸€å¥—ç¨‹å¼ç¢¼ build å‡ºä¾†çš„ JAR/WARï¼Œæ›ä¸åŒè¨­å®šå³å¯éƒ¨ç½²åœ¨ä¸åŒç«¯ã€‚            |

ğŸ§± å¯¦ä½œçµæ§‹å»ºè­°
	ğŸ“ å°ˆæ¡ˆç¯„ä¾‹çµæ§‹ï¼š
		cloud-gateway/
		â”‚
		â”œâ”€â”€ src/main/java/com/example/gateway
		â”‚   â”œâ”€â”€ GatewayRoutingFilter.java  		<-- å…±ç”¨
		â”‚   â”œâ”€â”€ ForwardingService.java    	<-- å…±ç”¨
		â”‚   â”œâ”€â”€ GatewayController.java   	<-- å…±ç”¨
		â”‚
		â”œâ”€â”€ src/main/resources/
		â”‚   â”œâ”€â”€ application.yml                <-- é è¨­å€¼
		â”‚   â”œâ”€â”€ application-cloud.yml          <-- é›²ç«¯å°ˆç”¨è¨­å®š
		â”‚   â”œâ”€â”€ application-onprem.yml         <-- åœ°ç«¯å°ˆç”¨è¨­å®š

	âœ¨ application-cloud.yml èˆ‡ application-onprem.yml çš„å·®ç•°
		| è¨­å®š                      | é›²ç«¯                           | åœ°ç«¯                              |
		| ------------------------ | ----------------------------- | -------------------------------- |
		| `target.base-uri`        | `http://onprem-gateway.local` | `http://onprem-backend-service`  |
		| `auth.issuer`            | `https://cloud-auth-server`   | `https://cloud-auth-server`      |
		| `token.exchange.enabled` | true                          | falseï¼ˆæˆ–ä¸ç®¡ï¼‰                    |


	ğŸ›  DevOps éƒ¨ç½²å»ºè­°ï¼š
		| å±¤ç´š             | å¯¦å‹™ä½œæ³•                                                              |
		| --------------- | ------------------------------------------------------------------- |
		| profile-based   | ä½¿ç”¨ `--spring.profiles.active=cloud` æˆ– `onprem` å•Ÿå‹•ä¸åŒè¨­å®š          |
		| CI/CD åˆ†ç’°å¢ƒé…ç½®  | ç”¢ç”Ÿ `application-cloud.yml`, `application-onprem.yml` ä¸¦å„è‡ª deploy  |
		| è¨­å®šä¸­å¿ƒ          | è‹¥ç”¨ Spring Cloud Config / Consulï¼Œå¯å‹•æ…‹åˆ‡æ›åƒæ•¸                       |

	â— ä½†æ³¨æ„ï¼š
		â›” ä¸å»ºè­°ã€Œé‚è¼¯å¯«æ­»é›²æˆ–åœ°ç«¯è§’è‰²ã€ï¼š
			if (IS_CLOUD) { ... } else { ... }
			â†’ é€™æ¨£æœƒè®“ç¨‹å¼è·Ÿç’°å¢ƒç¶æ­»ï¼Œä¸å¥½æ“´å……æˆ–åš gateway-to-gateway æ¨¡å¼ï¼ˆé›²ç•¶ clientã€åœ°ä¹Ÿç•¶ clientï¼‰ã€‚

	âœ… ç¸½çµå»ºè­°
	âœ… å¼·çƒˆå»ºè­°é›²èˆ‡åœ°ç«¯ gateway å…±ç”¨ä¸€ä»½ Java ç¨‹å¼ç¢¼ï¼Œæ­é… ç’°å¢ƒè¨­å®šæª”åˆ†é›¢ï¼ˆyml profileï¼‰ å¯¦ä½œéˆæ´»è·¯ç”±èˆ‡é©—è­‰ç­–ç•¥

====================================================================================================================================
================ é›™å‘ gateway äº’ç©¿å…±ç”¨ ===============================================================================================
====================================================================================================================================

	// âœ… GatewayMode.java - ç’°å¢ƒè§’è‰²è¨­å®šï¼ˆcloud æˆ– onpremï¼‰
	public enum GatewayMode {
		CLOUD, ONPREM
	}


	// âœ… TokenContext.java - è¾¨è­˜ä¾†æºèˆ‡ç›®æ¨™
	public class TokenContext {
		public enum Source { FROM_CLOUD, FROM_ONPREM, UNKNOWN }
		public enum Target { TO_CLOUD, TO_ONPREM, UNKNOWN }

		private final Source source;
		private final Target target;

		public TokenContext(Source source, Target target) {
			this.source = source;
			this.target = target;
		}

		public Source getSource() { return source; }
		public Target getTarget() { return target; }
	}

	// âœ… TokenContextResolver.java - æ ¹æ“š JWT åˆ¤æ–·ä¾†æºèˆ‡ç›®æ¨™
	@Component
	public class TokenContextResolver {

		public TokenContext resolve(Jwt jwt) {
			String issuer = jwt.getIssuer().toString();
			String audience = jwt.getAudience().stream().findFirst().orElse("");

			TokenContext.Source source = issuer.contains("cloud") ? TokenContext.Source.FROM_CLOUD
					: issuer.contains("onprem") ? TokenContext.Source.FROM_ONPREM
					: TokenContext.Source.UNKNOWN;

			TokenContext.Target target = audience.contains("cloud") ? TokenContext.Target.TO_CLOUD
					: audience.contains("onprem") ? TokenContext.Target.TO_ONPREM
					: TokenContext.Target.UNKNOWN;

			return new TokenContext(source, target);
		}
	}

	1.Gateway JWT é©—è­‰éå¾Œï¼Œè¾¨è­˜ä¾†æºæ˜¯å…§éƒ¨é‚„æ˜¯é›²ç«¯äº¤æ›è€Œä¾†çš„è«‹æ±‚
		1.GatewayRoutingFilterï¼ˆæœ€å…ˆåŸ·è¡Œï¼‰
			* é¡å‹ï¼šOncePerRequestFilterï¼ˆServlet Filterï¼‰

			* åœ¨ Spring Security æˆæ¬Šé‚è¼¯ä¹‹å¾ŒåŸ·è¡Œï¼ˆé è¨­é †åºï¼‰

			* ç”¨ä¾†è§£ JWTã€è¾¨è­˜ä¾†æºï¼ˆCLOUD_EXCHANGE or INTERNAL_ONPREMï¼‰

			* æœƒå°‡çµæœå¯«å…¥ request.setAttribute("source", ...)ï¼Œä¾›å¾ŒçºŒä½¿ç”¨

			ğŸ‘‰ ç›®çš„ï¼šè¾¨è­˜ä¾†æº

		// âœ… GatewayRoutingFilterï¼šåˆ¤æ–·æ˜¯é›²/åœ°ç«¯ç©¿éä¾†é‚„æ˜¯é›²/åœ°ç«¯å…§éƒ¨æ‰“çš„ : æ±ºå®šè½‰é€é‚è¼¯çš„ Filter
		@Component
		@Order(Ordered.HIGHEST_PRECEDENCE)
		public class GatewayRoutingFilter extends OncePerRequestFilter {

			private final JwtDecoder jwtDecoder;
			private final TokenContextResolver contextResolver;

			public GatewayRoutingFilter(JwtDecoder jwtDecoder, TokenContextResolver contextResolver) {
				this.jwtDecoder = jwtDecoder;
				this.contextResolver = contextResolver;
			}

			@Value("${gateway.mode}")
			private GatewayMode mode;

			@Override
			protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)
					throws ServletException, IOException {

				String token = Optional.ofNullable(request.getHeader("Authorization"))
						.filter(h -> h.startsWith("Bearer "))
						.map(h -> h.substring(7))
						.orElse(null);

				if (token != null) {
					try {
						Jwt jwt = jwtDecoder.decode(token);
						TokenContext ctx = contextResolver.resolve(jwt);

						request.setAttribute("token.context", ctx);
					} catch (JwtException e) {
						response.sendError(HttpStatus.UNAUTHORIZED.value(), "Invalid token");
						return;
					}
				}

				chain.doFilter(request, response);
			}
		}



	2.ForwardingService
		* é¡å‹ï¼šSpring @Service é¡åˆ¥

		* åŒ…è£ WebClient / RestTemplate é‚è¼¯ï¼Œå¯¦éš›å»å‘¼å«åœ°ç«¯æœå‹™æˆ–å¤–éƒ¨æœå‹™

		* baseUri å¯ç”± application.yml æ±ºå®šï¼Œè®“é›²èˆ‡åœ°ç«¯è½‰ç™¼ç›®æ¨™ä¸åŒ

		ğŸ‘‰ ç›®çš„ï¼šå¾ Gateway ç™¼èµ·å°ã€ŒçœŸæ­£å¾Œç«¯ã€çš„å‘¼å«

		// âœ… ForwardingServiceï¼šæ ¹æ“š context è½‰é€
		// âœ… ForwardingService.java -
		@Service
		public class ForwardingService {

			@Value("${routing.to-cloud}")
			private String cloudUri;

			@Value("${routing.to-onprem}")
			private String onpremUri;

			private final WebClient webClient = WebClient.create();

			public String forward(String path, TokenContext context, String token) {
				String baseUri = switch (context.getTarget()) {
					case TO_CLOUD -> cloudUri;
					case TO_ONPREM -> onpremUri;
					default -> throw new IllegalStateException("Unknown target");
				};

				return webClient.get()	  // ç°¡åŒ–ç‰ˆæœ¬
						.uri(baseUri + path)
						.header("Authorization", "Bearer " + token)
						.retrieve()
						.bodyToMono(String.class)
						.block();
			}
		}

	3ï¸.GatewayController
		* é¡å‹ï¼š@RestController

		* æ¥æ”¶å¯¦éš›çš„ API è«‹æ±‚ï¼Œä¾‹å¦‚ /onprem/**ã€/api/data

		* æœƒè®€å– request attributeï¼ˆå¦‚ "source"ï¼‰æ±ºå®šè¡Œç‚º

		* å‘¼å« service class é€²è¡Œè½‰é€ã€è™•ç†æ¥­å‹™é‚è¼¯ç­‰

		ğŸ‘‰ ç›®çš„ï¼šä¾æ“šä¾†æºè½‰é€è«‹æ±‚ã€æ±ºå®šå›æ‡‰å…§å®¹

		// âœ… GatewayController.java - è«‹æ±‚é€²å…¥é»ï¼Œæ ¹æ“šä¾†æºç”± service è™•ç†
		@RestController
		@RequestMapping("/gateway")
		public class GatewayController {

			private final ForwardingService forwardingService;

			public GatewayController(ForwardingService forwardingService) {
				this.forwardingService = forwardingService;
			}

			@GetMapping("/**")
			public ResponseEntity<String> route(HttpServletRequest request) {
				String path = request.getRequestURI().replaceFirst("/gateway", "");
				TokenContext ctx = (TokenContext) request.getAttribute("token.context");

				String token = Optional.ofNullable(request.getHeader("Authorization"))
						.filter(h -> h.startsWith("Bearer "))
						.map(h -> h.substring(7))
						.orElse("");

				String result = forwardingService.forward(path, ctx, token);
				return ResponseEntity.ok(result);
			}
		}

	// âœ… application-cloud.yml / application-onprem.yml å¯é…ç½®å¦‚ä¸‹ï¼š
	# application-cloud.yml
	gateway:
	  mode: cloud
	routing:
	  to-onprem: http://onprem-gateway.local
	  to-cloud: http://localhost:9000

	# application-onprem.yml
	gateway:
	  mode: onprem
	routing:
	  to-cloud: http://cloud-gateway.local
	  to-onprem: http://localhost:8081


ğŸ” æ•´é«”åŸ·è¡Œé †åºæµç¨‹åœ–ï¼š
		  +---------------------+
		  | 1. HTTP Request     |
		  | Authorization: Bearer ... |
		  +---------------------+
					â†“
	+--------------------------------------------+
	| GatewayRoutingFilter                   |
	| è§£æ JWT â†’ åˆ¤æ–·ä¾†æº â†’ setAttribute("source")|
	+--------------------------------------------+
					â†“
	+--------------------------------------------+
	| GatewayController                    |
	| ä¾æ“š request.getAttribute(\"source\") åˆ†æ”¯è™•ç†  |
	| å‘¼å« ForwardToTargetService                |
	+--------------------------------------------+
					â†“
	+--------------------------------------------+
	| ForwardingService                     |
	| ä½¿ç”¨ WebClient/RestTemplate â†’ è½‰ç™¼è«‹æ±‚åˆ°ä¸‹æ¸¸     |
	+--------------------------------------------+
					â†“
			  çœŸæ­£çš„å¾Œç«¯æœå‹™

ğŸ“Œ å°æé†’ï¼šåŸ·è¡Œé †åºä¾è³´ Filter è¨»å†Šé †åº
	* SourceAwareRequestFilter æ˜¯ Filterï¼Œå› æ­¤æœƒæ¯” @Controller é‚„æ—©

	* è‹¥ä½ æœ‰å¤šå€‹ Filterï¼Œå»ºè­°è¨­è¨ˆ @Order(...) æ§åˆ¶é †åº

		@Component
		@Order(Ordered.HIGHEST_PRECEDENCE + 10)
		public class SourceAwareRequestFilter extends OncePerRequestFilter { ... }


âœ… æ¨¡æ¿é‡é»
	| æ¨¡çµ„                    | åŠŸèƒ½                                             |
	| ---------------------- | ----------------------------------------------- |
	| `GatewayMode`          | ç’°å¢ƒæ¨¡å¼ï¼ˆcloud / onpremï¼‰å¾ `application.yml` æ±ºå®š |
	| `TokenContextResolver` | æ ¹æ“š JWT è§£æä¾†æºèˆ‡ç›®æ¨™ï¼š`FROM_CLOUD â†’ TO_ONPREM` ç­‰ |
	| `GatewayRoutingFilter` | åˆ†æ JWT ä¸¦æ¨™è¨˜ä¾†æºèˆ‡ç›®æ¨™ï¼ˆè¨­ç‚º request attributeï¼‰   |
	| `ForwardingService`    | æ ¹æ“šç›®æ¨™è‡ªå‹•è½‰é€ï¼ˆbase URI å¾ `application.yml` ä¾†ï¼‰ |
	| `GatewayController`    | è·¯ç”±é€²å…¥é»ï¼Œå¯æ”¯æ´ `/gateway/**`                    |


