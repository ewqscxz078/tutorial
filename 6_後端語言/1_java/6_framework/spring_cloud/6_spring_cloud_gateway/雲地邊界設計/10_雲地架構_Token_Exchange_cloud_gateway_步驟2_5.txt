é›²ç«¯ WebMVC Gateway Filter

	âœ… åŠŸèƒ½èªªæ˜ï¼š
		0.åªå°ç‰¹å®šè·¯å¾‘ï¼ˆæˆ–æ¢ä»¶ï¼‰åŸ·è¡Œ token exchange
			ä»¥ä¸‹æ˜¯å¸¸è¦‹åšæ³•çš„é¸é …ï¼š
				| æ¢ä»¶é¡å‹           | ç¯„ä¾‹                                                |
				| ---------------- | -------------------------------------------------- |
				| âœ… è·¯å¾‘ç™½åå–®      | `/onprem/**` å¿…é ˆ exchangeï¼Œå…¶ä»–ä¸äº¤æ›                |
				| âœ… clientId é™åˆ¶  | åªæœ‰ç‰¹å®š JWT è£¡ `client_id` ç‚º `trusted-client` æ‰äº¤æ› |
				| âœ… Scope é™åˆ¶     | JWT è£¡çš„ scope åŒ…å« `exchange:onprem` æ‰äº¤æ›          |


		1.æ“·å– Authorization Header ä¸­çš„åŸå§‹ JWTï¼ˆsubject_tokenï¼‰

		2.ä½¿ç”¨ WebClientï¼ˆblockingï¼‰å‘¼å«é›²ç«¯ Auth Server çš„ /oauth2/token endpointï¼ŒåŸ·è¡Œ RFC 8693 çš„ token exchange

		3.ç”¨åŒ…è£çš„ HttpServletRequestWrapper æ›¿æ› header ä¸­çš„ Authorizationï¼Œå°‡æ›å¾—çš„æ–° token å‚³çµ¦å¾Œæ–¹ï¼ˆåœ°ç«¯ Gatewayï¼‰

	ğŸ“è«‹ç¢ºä¿ä»¥ä¸‹äº‹é …ï¼š
		1.ä½ æœ‰è¨»å†Šé€™å€‹ Filterï¼ˆSpring Boot @Component è‡ªå‹•ç”Ÿæ•ˆï¼‰

		2.client-a:secret æ˜¯ cloud-auth-server ä¸Šçš„å·²è¨»å†Š client

		3.http://localhost:9000/oauth2/token æ˜¯é›²ç«¯ auth server token ç™¼è¡Œç«¯é»

		4.audience è¨­å®šç‚ºåœ°ç«¯æœå‹™å¯æ¥å—çš„å€¼ï¼ˆå¦‚ onprem-apiï¼‰

	// é›²ç«¯ WebMVC Gateway Filterï¼šæ“·å–åŸ token -> æ› token -> æ”¹å¯« header ä¸¦è½‰é€åˆ°åœ°ç«¯

	@Component
	public class TokenExchangeGatewayFilter extends OncePerRequestFilter {

		private final WebClient webClient = WebClient.create();

		@Override
		protected void doFilterInternal(HttpServletRequest request,
										HttpServletResponse response,
										FilterChain filterChain) throws ServletException, IOException {

			String requestURI = request.getRequestURI();
			boolean requiresTokenExchange = requestURI.startsWith("/onprem/"); // åªé‡å°æ­¤ prefix çš„è·¯å¾‘äº¤æ› token

			String authHeader = request.getHeader("Authorization");

			if (requiresTokenExchange && authHeader != null && authHeader.startsWith("Bearer ")) {
				String subjectToken = authHeader.substring(7);

				// 1. å‘¼å«é›²ç«¯ Auth Server çš„ token exchange endpoint
				MultiValueMap<String, String> formData = new LinkedMultiValueMap<>();
				formData.add("grant_type", "urn:ietf:params:oauth:grant-type:token-exchange");
				formData.add("subject_token", subjectToken);
				formData.add("subject_token_type", "urn:ietf:params:oauth:token-type:access_token");
				formData.add("audience", "onprem-api");

				String exchangedToken;
				try {
					Map<String, Object> tokenResponse = webClient.post()
						.uri("http://localhost:9000/oauth2/token") // é›²ç«¯ auth server ä½å€
						.headers(headers -> headers.setBasicAuth("client-a", "secret"))
						.contentType(MediaType.APPLICATION_FORM_URLENCODED)
						.body(BodyInserters.fromFormData(formData))
						.retrieve()
						.bodyToMono(new ParameterizedTypeReference<Map<String, Object>>() {})
						.block(Duration.ofSeconds(5));

					exchangedToken = (String) tokenResponse.get("access_token");
				} catch (Exception ex) {
					response.sendError(HttpStatus.UNAUTHORIZED.value(), "Token Exchange Failed");
					return;
				}

				// 2. åŒ…è£ requestï¼ŒåŠ ä¸Šæ–°çš„ Authorization header
				HttpServletRequest wrapper = new HttpServletRequestWrapper(request) {
					@Override
					public String getHeader(String name) {
						if ("Authorization".equalsIgnoreCase(name)) {
							return "Bearer " + exchangedToken;
						}
						return super.getHeader(name);
					}
				};

				filterChain.doFilter(wrapper, response);
				return;
			}

			// æ²’æœ‰ Authorization header å°±ç…§å¸¸è™•ç† => å°±ç­‰æ–¼åŒé‚Šç•Œæ‰“ä½¿ç”¨åŸå§‹ token å³å¯
			filterChain.doFilter(request, response);
		}
	}
