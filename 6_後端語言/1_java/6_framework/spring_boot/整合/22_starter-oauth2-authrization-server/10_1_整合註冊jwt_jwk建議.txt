ref ChatGPT

è§£æ±º Auth Server ç«¯å¦‚ä½•å¤§é‡è¨»å†Š/ç®¡ç† JWTï¼ˆå…¶å¯¦æ˜¯ Registered Clients èˆ‡ Token è¨­å®šï¼‰â€èˆ‡â€œå‰ç«¯/å®¢æˆ¶ç«¯å¦‚ä½•é¸ç”¨å“ªä¸€ç¨® JWTâ€çš„å•é¡Œ
ç”¨èªä»¥ Spring Authorization Serverï¼ˆSASï¼‰/ Spring Security 6.xã€Spring Boot 3.x ç‚ºåŸºæº–ã€‚

	1) æ•´é«”æ€è·¯ï¼ˆé‡å¾ˆå¤šæ™‚çš„æ ¸å¿ƒè§€å¿µï¼‰
		* ç”¨å®£å‘Šå¼è¨»å†Šï¼‹è³‡æ–™åº«æŒä¹…åŒ–ï¼šæ‰€æœ‰ client éƒ½é€² DBï¼ˆSAS å…§å»º registered_client è¡¨ï¼‰ï¼Œä¾†æºå‰‡ä»¥ YAML/JSON ç¨®å­æª”ç‚ºä¸»(è©³è¦‹æœ€å¾Œé¢å‚™è¨»èªªæ˜)ï¼Œé€é CI/CD åŒ¯å…¥ï¼Œé¿å…æ‰‹å‹•é»é¸ã€‚

		* ç”¨**Token Profileï¼ˆä»¤ç‰Œæ¨£æ¿ï¼‰**æŠ½è±¡åŒ–(è©³è¦‹æœ€å¾Œé¢å‚™è¨»èªªæ˜)ï¼šæŠŠã€Œæˆæ¬Šå‹åˆ¥ã€å­˜æ´»æ™‚é–“ã€audienceã€å¿…å¸¶ claimsã€scope ç™½åå–®ã€ç­‰æŠ½æˆ Profileï¼›æ¯å€‹ client æŒ‡å‘ä¸€å€‹ Profileã€‚å¤§é‡ client å°±åªæ˜¯ã€ŒæŒ‡æ´¾ Profileï¼‹å°‘é‡å·®ç•°ã€ã€‚

		* ç”¨Scope èˆ‡ Audience æ²»ç†ï¼šscope å‘½åè¦ç¯„ï¼‹audienceï¼ˆè³‡æºä¼ºæœå™¨/APIï¼‰å°ç…§è¡¨ï¼Œè®“å‰ç«¯/å¾Œç«¯åªè¦æŒ‘é¸å°æ‡‰ clientRegistrationId å°±æ‹¿åˆ°æ­£ç¢ºçš„ JWTã€‚

		* è¨»å†Š ID ç©©å®šï¼šä¸åŒç’°å¢ƒç”¨ç›¸åŒçš„ registrationIdï¼Œclient-id/secretã€redirect-uriã€issuer å¯éš¨ç’°å¢ƒè®Šï¼ˆåœ¨å±¬æ€§æª”/DB ä¸­åˆ†ç’°å¢ƒï¼‰ï¼Œä½†åç¨±ä¸è¦è®Šï¼Œé¿å…å‰ç«¯æ”¹ç¨‹å¼ã€‚

	2) Auth Server ç«¯ï¼šè³‡æ–™æ¨¡å‹èˆ‡è¡¨
		æœ€å°‘éœ€è¦ï¼ˆSAS å…§å»ºï¼‹å»ºè­°æ“´å……ï¼‰ï¼š
		å…§å»ºè¡¨
			* registered_clientï¼šclient-idã€grant typesã€redirect-urisã€scopesã€token è¨­å®šç­‰ã€‚

			* oauth2_authorizationã€oauth2_authorization_consentï¼šæ ¸ç™¼èˆ‡åŒæ„ç´€éŒ„ï¼ˆæœ‰äº’å‹•å¼æµç¨‹æ‰æœƒç”¨åˆ°ï¼‰ã€‚

		å»ºè­°æ“´å……ï¼ˆè‡ªå»ºè¡¨ï¼‰

			* token_profile (token è¦æ ¼)ï¼šidã€nameã€grantsã€access_token_ttlã€refresh_token_ttlã€id_token_claims_templateã€allowed_scopesã€audiencesâ€¦
				registered_client çš„æ˜ç´° : é—œè¯ä½¿ç”¨çš„ token ç´°ç¯€
				
			* client_extraï¼šclient_id å¤–éµï¼‹æ¨™ç±¤ï¼ˆteam/owner/systemï¼‰ã€ç’°å¢ƒ(env)ã€ç”¨é€”ï¼ˆm2m/webapp/nativeï¼‰ã€æ˜¯å¦å•Ÿç”¨ã€æ—‹è½‰ç­–ç•¥ç­‰ã€‚

			* jwk_keyï¼šKIDã€æ¼”ç®—æ³•ã€PEM/JWKã€ç‹€æ…‹ï¼ˆACTIVE/INACTIVEï¼‰ã€å»ºç«‹/å•Ÿç”¨/åœç”¨æ™‚é–“ï¼ˆæ–¹ä¾¿ key æ—‹è½‰èˆ‡ç¨½æ ¸ï¼‰ã€‚

			å¯¦å‹™ä¸Šï¼šregistered_client åŠ ä¸Šä¸€å€‹è‡ªè¨‚æ¬„ä½ï¼ˆæˆ– side table client_profile_mapï¼‰æŒ‡å‘ token_profileï¼Œä½ å°±èƒ½æŠŠå¤§é‡ client çš„å…±é€šä»¤ç‰Œç­–ç•¥é›†ä¸­ç®¡ç†ã€‚\
		
	3) è¨»å†Šæµç¨‹ï¼ˆå®£å‘Šå¼èˆ‡è‡ªå‹•åŒ–ï¼‰
		* ç¨®å­æª”ï¼ˆYAML/JSONï¼‰â†’ Importerï¼šåœ¨ CI/CD å»ºç½®éšæ®µè·‘ä¸€æ¬¡ importerï¼ŒæŠŠå·®ç•°å¥—ç”¨åˆ° DBï¼ˆæ–°å¢/æ›´æ–°/åœç”¨ï¼‰ã€‚

		* ç®¡ç† APIï¼ˆé¸é…ï¼‰ï¼šæä¾›å°‘æ•¸éœ€è¦å‹•æ…‹è¨»å†Š/æ—‹è½‰çš„åœ˜éšŠä½¿ç”¨ã€‚

		* ä¸€è‡´æ€§æª¢æŸ¥ï¼šCI å…§åš diffï¼ˆç¨®å­æª” vs DBï¼‰èˆ‡ linterï¼ˆå‘½åè¦ç¯„ã€scope æ˜¯å¦å­˜åœ¨ã€redirect URI æ˜¯å¦ç¬¦åˆï¼‰ã€‚

		ç°¡åŒ–ç¯„ä¾‹ï¼ˆYAMLï¼‰ï¼š
			tokenProfiles:
			  - name: webapp-default
				grants: [authorization_code, refresh_token]
				accessTokenTtl: 900s
				refreshTokenTtl: 7d
				audiences: [api.user, api.billing]
				allowedScopes: [openid, profile, email, user.read, billing.read]

			  - name: m2m-default
				grants: [client_credentials]
				accessTokenTtl: 600s
				audiences: [api.billing]
				allowedScopes: [billing.read, billing.write]

			clients:
			  - registrationId: acme-web-portal        # å…¨ç’°å¢ƒå›ºå®š
				clientId: ${WEB_PORTAL_CLIENT_ID}      # ç”±ç’°å¢ƒæ³¨å…¥
				clientSecret: ${WEB_PORTAL_SECRET}
				profile: webapp-default
				redirectUris:
				  - https://portal.example.com/login/oauth2/code/acme
				  - https://staging.portal.example.com/login/oauth2/code/acme
				postLogoutRedirectUris:
				  - https://portal.example.com/logout/success

			  - registrationId: billing-job-writer
				clientId: ${BILLING_JOB_WRITER_ID}
				clientSecret: ${BILLING_JOB_WRITER_SECRET}
				profile: m2m-default
	
	4) JWK èˆ‡ç°½ç« ï¼ˆå«æ—‹è½‰ï¼‰
		* ä½¿ç”¨ RS256 æˆ– ES256ï¼ˆå»ºè­° RS/EC çš†å¯ï¼Œä½† RS256æœ€æ™®éï¼‰ï¼Œæ¯æŠŠ key æœ‰ KIDï¼ŒJWKS endpoint æä¾›å¤š keyï¼›active æ——æ¨™æ§åˆ¶ç•¶å‰ç°½ç« ç”¨å“ªæŠŠã€‚

		* æ—‹è½‰ç­–ç•¥ï¼šå®šæœŸç”¢æ–°â†’æ¨™è¨˜æ–°ç‚º ACTIVEã€ä¿ç•™èˆŠç‚º INACTIVE ä¸€æ®µæ™‚é–“â†’ç­‰è³‡æºç«¯éƒ½å·²æŠ“åˆ°æ–° JWKS å†ä¸‹æ¶èˆŠ keyã€‚

		* è³‡æºä¼ºæœå™¨ JWK å¿«å–ï¼šè¨­å®šåˆç† TTL èˆ‡å¤±æ•—å›é€€ï¼ˆä¸€èˆ¬ frameworks æœƒè‡ªå¸¶ï¼Œç¢ºä¿ KID åˆ‡æ›ä¸æœƒæ‰“æ–·ï¼‰ã€‚
	
		SAS JWKSourceï¼ˆç¯„ä¾‹éª¨æ¶ï¼‰ï¼š
			@Bean
			JWKSource<SecurityContext> jwkSource(JwkRepository repo) {
				// repo å¾ DB è¼‰å…¥æ‰€æœ‰æœ‰æ•ˆ keyï¼Œçµ„æˆ JWKSet
				JWKSet jwkSet = new JWKSet(repo.loadAllActiveOrPublishedKeys());
				return (jwkSelector, ctx) -> jwkSelector.select(jwkSet);
			}

	5) Token å…§å®¹èˆ‡è‡ªè¨‚ Claims
		* æœ€åŸºæœ¬ï¼šissï¼ˆä½ çš„ issuerï¼‰ã€audï¼ˆç›®æ¨™è³‡æºï¼‰ã€subã€expã€nbfã€iatã€client_idã€scopeï¼ˆæˆ– scpï¼‰ã€‚

		* å¸¸è¦‹é€²éšï¼šazpï¼ˆAuthorized partyï¼‰ã€tenantã€rolesã€permissionsã€æ¥­å‹™ IDs ç­‰ã€‚

		* å»ºè­°ç”¨ OAuth2TokenCustomizer<JwtEncodingContext> é›†ä¸­è™•ç†ï¼Œä¾ profile / client / scope æ±ºå®šæ³¨å…¥å“ªäº› claimsã€‚
	
		ç¯„ä¾‹ï¼š
			@Bean
			OAuth2TokenCustomizer<JwtEncodingContext> tokenCustomizer(TokenProfileService profiles) {
			  return context -> {
				var clientId = context.getRegisteredClient().getClientId();
				var profile = profiles.resolveForClient(clientId);

				// audience
				if (context.getTokenType().equals(OAuth2TokenType.ACCESS_TOKEN)) {
				  context.getClaims().claim("aud", profile.audiences());
				}

				// roles/permissionsï¼ˆè¦–æƒ…æ³å¾ä½¿ç”¨è€…æˆ– client ç¶å®šï¼‰
				var roles = profiles.resolveRoles(context);
				if (!roles.isEmpty()) {
				  context.getClaims().claim("roles", roles);
				}

				// å…¶ä»–æ¨™æº–/è‡ªè¨‚
				context.getClaims().issuer(profile.issuer());
			  };
			}

	6) å‰ç«¯/å®¢æˆ¶ç«¯ï¼šæ€éº¼â€œé¸ç”¨å“ªä¸€ç¨® JWTâ€
		A. Browser å‰ç«¯ï¼ˆAuthorization Code + PKCEï¼‰

			* åœ¨å‰ç«¯ï¼ˆæˆ–ä½ çš„ JSP/Spring MVC æ‡‰ç”¨ï¼‰é…ç½® å›ºå®šçš„ registrationIdï¼ˆä¾‹å¦‚ acme-web-portalï¼‰ã€‚

			* å„ç’°å¢ƒé€éå±¬æ€§æª”æ³¨å…¥ client-id/secretï¼ˆæˆ–åƒ… public client + PKCEï¼‰ã€issuer-uriã€redirect-uriã€‚

			* åªè¦ä½¿ç”¨è©² registrationIdï¼Œå°±æœƒä¾æ“š Auth Server çš„ token_profile ç”¢ç”Ÿå°æ‡‰çš„ JWTï¼ˆaudã€scopeã€TTL ä¸€è‡´ï¼‰
		
			application-*.ymlï¼ˆå®¢æˆ¶ç«¯ï¼‰ï¼š
				spring:
				  security:
					oauth2:
					  client:
						provider:
						  acme:
							issuer-uri: https://idp.example.com
						registration:
						  acme-web-portal:
							provider: acme
							client-id: ${WEB_PORTAL_CLIENT_ID}
							client-secret: ${WEB_PORTAL_SECRET}
							authorization-grant-type: authorization_code
							redirect-uri: "{baseUrl}/login/oauth2/code/acme"
							scope: openid, profile, email, user.read
		B. æ©Ÿå™¨å°æ©Ÿå™¨ï¼ˆClient Credentialsï¼‰

			ä¸€å€‹ç›®æ¨™è³‡æº/æ¬Šé™é›†åˆ = ä¸€å€‹ registrationIdã€‚æƒ³è¦ billing å¯å¯«å…¥ï¼Œå°±ä½¿ç”¨ billing-job-writerï¼›æƒ³çœ‹å ±è¡¨ï¼Œå°±ç”¨ billing-report-readerã€‚

			WebClient ä½¿ç”¨å°æ‡‰ registrationIdï¼Œå¾Œé¢é€é OAuth2AuthorizedClientManager è‡ªå‹•æ‹¿å–/é‡ç”¨ Access Tokenã€‚
			
			application-*.ymlï¼ˆå®¢æˆ¶ç«¯ï¼‰ï¼š
				spring:
				  security:
					oauth2:
					  client:
						provider:
						  acme:
							issuer-uri: https://idp.example.com
						registration:
						  billing-job-writer:
							provider: acme
							client-id: ${BILLING_JOB_WRITER_ID}
							client-secret: ${BILLING_JOB_WRITER_SECRET}
							authorization-grant-type: client_credentials
							scope: billing.write

			WebClient å–ç”¨ï¼ˆç¤ºæ„ï¼‰ï¼š
				@Bean
				WebClient billingWriterWebClient(WebClient.Builder builder,
												 OAuth2AuthorizedClientManager mgr) {
				  var oauth = new ServletOAuth2AuthorizedClientExchangeFilterFunction(mgr);
				  oauth.setDefaultClientRegistrationId("billing-job-writer");
				  return builder
					  .baseUrl("https://api.example.com/billing")
					  .apply(oauth.oauth2Configuration())
					  .build();
				}
				
				é‡é»ï¼šå‰ç«¯/å¾Œç«¯åªéœ€è¦æŒ‘å°çš„ registrationIdï¼Œå…¶é¤˜ï¼ˆaudienceã€scopeã€TTLã€claimsï¼‰ç”± Auth Server çš„ Token Profile æ±ºå®šã€‚é€™æ˜¯å¤§é‡ç®¡ç†æ™‚æœ€ç©©çš„åˆ†å·¥ã€‚
	
	7) å‘½åè¦ç¯„èˆ‡å°ç…§çŸ©é™£ï¼ˆå¤§é‡å®¢æˆ¶ç«¯çš„ç®¡ç†é—œéµï¼‰
		* registrationIdï¼š<team>-<app>-<purpose>ï¼ˆä¾‹å¦‚ fin-billing-job-writerã€ui-portal-webï¼‰

		* scopeï¼š<domain>.<permission>ï¼ˆbilling.readã€billing.writeã€user.readï¼‰

		* audienceï¼šå°æ‡‰è³‡æºç³»çµ±æ¨™è­˜ï¼ˆapi.userã€api.billingï¼‰

		* å»ºç«‹â€œå°ç…§è¡¨â€ï¼ˆCSV/Sheet/DBï¼‰ï¼š

		* æ¬Šè²¬å–®ä½ / ç³»çµ± / registrationId / client-id / profile / scopes / audiences / ç’°å¢ƒ / æ—‹è½‰æ—¥æœŸ / è² è²¬äºº
	
	8) å¤šç’°å¢ƒç­–ç•¥ï¼ˆdev/sit/uat/prodï¼‰
		* å›ºå®š registrationIdï¼Œå…¶é¤˜ï¼ˆclient-idã€client-secretã€redirect-uriã€issuer-uriï¼‰å› ç’°å¢ƒä¸åŒè€Œç•°ã€‚

		* ç”±æ–¼ä½ â€œé‡å¾ˆå¤šâ€ï¼Œå»ºè­°ï¼š

			1.å…±ç”¨ä¸€ä»½å®£å‘Šæª”ï¼ˆåªå¯«é‚è¼¯ IDï¼‰ï¼›

			2.æ¯ç’°å¢ƒæ³¨å…¥è®Šæ•¸ï¼ˆclient-id/secretã€URIï¼‰ï¼›

			3.CI åŒ¯å…¥æ™‚å¡«å€¼ï¼Œæˆ–éƒ¨ç½²æ™‚ç”± Vault/è®Šæ•¸æ³¨å…¥ã€‚

		* è‹¥ client-id/secret ç›¸åŒï¼Œä½† redirect-uri / scope / grants ä¸åŒï¼Œæœƒå°è‡´æˆæ¬Š/é©—è­‰éŒ¯èª¤ï¼ˆæˆæ¬Šä¼ºæœå™¨æœƒä¾ DB ç«¯é…ç½®ç‚ºæº–ï¼Œå®¢æˆ¶ç«¯æä¾›ä¸ç¬¦å°±è¢«æ‹’ï¼‰ã€‚å»ºè­°ä¿æŒä¸€è‡´ï¼Œå·®ç•°é›†ä¸­åœ¨ç’°å¢ƒ URL èˆ‡ç§˜å¯†ã€‚
	
	9) ç›£æ§ã€è¼ªæ›¿èˆ‡ç¨½æ ¸
		* client-secret æ—‹è½‰ï¼šè¨­æ’ç¨‹æé†’èˆ‡è‡ªå‹•æ›¿æ›æµç¨‹ï¼ˆCI æ³¨å…¥æ–° secretï¼Œåˆ‡æ›/å›é€€æ©Ÿåˆ¶ï¼‰ã€‚

		* JWK æ—‹è½‰ï¼šå¦‚ä¸Šæ‰€è¿°ï¼Œé›™ key ç·©è¡ä¸€æ®µæ™‚é–“ã€‚

		* å¯©è¨ˆï¼šè¨˜éŒ„èª°å»ºç«‹/è®Šæ›´ clientï¼Œtoken ç™¼æ”¾èˆ‡å¤±æ•—çµ±è¨ˆï¼Œscope ä½¿ç”¨é »ç‡ï¼ˆå¹«åŠ©åˆªæ¸›ä¸å¿…è¦ scopeï¼‰ã€‚

	10) å¸¸è¦‹å‘ä½
		* redirect-uri ä¸å®Œå…¨ç›¸ç¬¦ï¼ˆå°¾æ–œç·šã€å¤§å°å¯«ã€å­ç¶²åŸŸï¼‰â†’ æˆæ¬Šç¢¼æµç¨‹ç›´æ¥è¢«æ‹’ã€‚

		* audience èˆ‡è³‡æºä¼ºæœå™¨é æœŸä¸ä¸€è‡´ â†’ RS é©— token å¤±æ•—ï¼ˆaud ä¸å«è‡ªèº« IDï¼‰ã€‚

		* scope å®¢æˆ¶ç«¯å®£å‘Šèˆ‡ä¼ºæœå™¨ allowedScopes ä¸ä¸€è‡´ â†’ ç™¼ token è¢«æ‹’æˆ–æ‹¿ä¸åˆ°æœŸæœ›æ¬Šé™ã€‚

		* æ™‚é˜åç§»ï¼ˆNTPï¼‰â†’ nbf/exp é©—è­‰å‡ºéŒ¯ã€‚

		* å‰ç«¯åˆ‡ç’°å¢ƒå¿˜äº†æ› issuer-uri/client-id â†’ æ›ç’°å¢ƒæ™‚å…¨ç·šå ±éŒ¯ã€‚

å°çµï¼ˆä½ å¯ä»¥ç›´æ¥å¥—ç”¨çš„è½åœ°æ¸…å–®ï¼‰
	1.åœ¨ Auth Server å»ºç«‹ Token Profile è¡¨ï¼‹Client-Profile æ˜ å°„ï¼›æ‰€æœ‰ client å®£å‘ŠåŒ–ï¼ˆYAML/JSONï¼‰ä¸¦èµ° CI åŒ¯å…¥ã€‚

	2.åŒä¸€æ”¯å‰ç«¯/å¾Œç«¯åœ¨ä¸åŒç’°å¢ƒä¿ç•™ç›¸åŒçš„ registrationIdï¼Œé€éå±¬æ€§/å¯†é‘°åº«æ³¨å…¥è®Šæ•¸ï¼›ç¨‹å¼ç¢¼ä¸æ”¹ã€‚

	3.ç”¨ OAuth2TokenCustomizer çµ±ä¸€çŒå…¥ audience/custom claimsï¼›è³‡æºä¼ºæœå™¨æ“šæ­¤é©—è­‰ã€‚

	4.JWK ç”¨ KID + å¤šæŠŠ key ç®¡ç†ï¼Œå®šæœŸæ—‹è½‰ï¼›è³‡æºç«¯è¨­å¥½ JWKS å¿«å–èˆ‡å›è£œã€‚

	5.ç¶­è­·ä¸€ä»½å°ç…§çŸ©é™£ï¼ˆregistrationId â†” scopes/audiences/profile/owner/envï¼‰ï¼Œæ”¯æ´æ‰¹é‡æ²»ç†ã€‚
	


DDL MSSQL åƒè€ƒ
	
	oauth2_registered_client
		CREATE TABLE dbo.oauth2_registered_client (
			id                             nvarchar(100)  NOT NULL,
			client_id                      nvarchar(100)  NOT NULL,
			client_id_issued_at            datetime2      NOT NULL CONSTRAINT DF_oauth2_rc_client_id_issued_at DEFAULT (SYSUTCDATETIME()),
			client_secret                  nvarchar(200)  NULL,
			client_secret_expires_at       datetime2      NULL,
			client_name                    nvarchar(200)  NOT NULL,
			client_authentication_methods  nvarchar(1000) NOT NULL,
			authorization_grant_types      nvarchar(1000) NOT NULL,
			redirect_uris                  nvarchar(1000) NULL,
			post_logout_redirect_uris      nvarchar(1000) NULL,   -- SAS 1.1+
			scopes                         nvarchar(1000) NOT NULL,
			client_settings                nvarchar(2000) NOT NULL,
			token_settings                 nvarchar(2000) NOT NULL,
			CONSTRAINT PK_oauth2_registered_client PRIMARY KEY (id),
			CONSTRAINT UQ_oauth2_registered_client_client_id UNIQUE (client_id)
		);
	
	oauth2_authorization
		CREATE TABLE dbo.oauth2_authorization (
			id                              nvarchar(100)   NOT NULL,
			registered_client_id            nvarchar(100)   NOT NULL,
			principal_name                  nvarchar(200)   NOT NULL,
			authorization_grant_type        nvarchar(100)   NOT NULL,
			authorized_scopes               nvarchar(1000)  NULL,

			attributes                      varbinary(max)  NULL,
			state                           nvarchar(500)   NULL,           -- SAS 1.1 ä»¥å¾Œå®šç¾©ç‚ºå­—ä¸²æ¬„ä½

			authorization_code_value        varbinary(max)  NULL,
			authorization_code_issued_at    datetime2       NULL,
			authorization_code_expires_at   datetime2       NULL,
			authorization_code_metadata     varbinary(max)  NULL,

			access_token_value              varbinary(max)  NULL,
			access_token_issued_at          datetime2       NULL,
			access_token_expires_at         datetime2       NULL,
			access_token_metadata           varbinary(max)  NULL,
			access_token_type               nvarchar(100)   NULL,
			access_token_scopes             nvarchar(1000)  NULL,

			refresh_token_value             varbinary(max)  NULL,
			refresh_token_issued_at         datetime2       NULL,
			refresh_token_expires_at        datetime2       NULL,
			refresh_token_metadata          varbinary(max)  NULL,

			oidc_id_token_value             varbinary(max)  NULL,
			oidc_id_token_issued_at         datetime2       NULL,
			oidc_id_token_expires_at        datetime2       NULL,
			oidc_id_token_metadata          varbinary(max)  NULL,
			oidc_id_token_claims            nvarchar(max)   NULL,

			-- Device Authorization Grantï¼ˆSAS 1.1+ï¼‰
			user_code_value                 varbinary(max)  NULL,
			user_code_issued_at             datetime2       NULL,
			user_code_expires_at            datetime2       NULL,
			user_code_metadata              varbinary(max)  NULL,

			device_code_value               varbinary(max)  NULL,
			device_code_issued_at           datetime2       NULL,
			device_code_expires_at          datetime2       NULL,
			device_code_metadata            varbinary(max)  NULL,

			CONSTRAINT PK_oauth2_authorization PRIMARY KEY (id)
		);

		-- å»ºè­°ç´¢å¼•ï¼ˆä¾æ“šå¯¦å‹™æŸ¥è©¢éœ€æ±‚åŠ é€ŸæŸ¥æ‰¾ï¼‰
		CREATE INDEX IX_oauth2_authorization_state                    ON dbo.oauth2_authorization (state);
		CREATE INDEX IX_oauth2_authorization_auth_code_value          ON dbo.oauth2_authorization (authorization_code_value);
		CREATE INDEX IX_oauth2_authorization_access_token_value       ON dbo.oauth2_authorization (access_token_value);
		CREATE INDEX IX_oauth2_authorization_refresh_token_value      ON dbo.oauth2_authorization (refresh_token_value);
		CREATE INDEX IX_oauth2_authorization_user_code_value          ON dbo.oauth2_authorization (user_code_value);
		CREATE INDEX IX_oauth2_authorization_device_code_value        ON dbo.oauth2_authorization (device_code_value);

	oauth2_authorization_consent
		CREATE TABLE dbo.oauth2_authorization_consent (
			registered_client_id  nvarchar(100)  NOT NULL,
			principal_name        nvarchar(200)  NOT NULL,
			authorities           nvarchar(1000) NOT NULL,
			CONSTRAINT PK_oauth2_authorization_consent PRIMARY KEY (registered_client_id, principal_name)
		);

	å…¶ä»–å»ºè­°
		1.å¤–éµï¼ˆå¯é¸ï¼‰ï¼šè‹¥ä½ å¸Œæœ›åœ¨ DB å±¤åŠ å¼·ä¸€è‡´æ€§ï¼Œå¯åŠ ä¸Š registered_client_id â†’ oauth2_registered_client(id) çš„å¤–éµï¼›ä½†æ³¨æ„éƒ¨ç½²/æ¸…è³‡æ–™æ™‚çš„é †åºèˆ‡æ•ˆèƒ½å½±éŸ¿ã€‚
		2.è³‡æ–™é•·åº¦/å‹åˆ¥ï¼šå®˜æ–¹ schema ä½¿ç”¨ varchar(1000/2000) å­˜ JSON/é›†åˆå­—ä¸²ï¼›è‹¥ä½ æœ‰å¤šèªç³»éœ€æ±‚ï¼Œäº¦å¯æ”¹ nvarcharï¼ˆæœ¬ DDL å·²ä½¿ç”¨ nvarcharï¼‰ã€‚
		3.æ™‚é–“é è¨­å€¼ï¼šclient_id_issued_at æˆ‘ä»¥ SYSUTCDATETIME() åšç‚ºé è¨­ï¼Œç­‰åŒå®˜æ–¹ CURRENT_TIMESTAMP çš„èªæ„ï¼ˆä½†ç‚º UTCã€é«˜ç²¾åº¦ï¼‰ã€‚
		4.Migration å·¥å…·ï¼šå¯æ”¾æˆ Flyway V1__sas_schema_mssql.sqlï¼›æœªä¾†å‡ç´šè‡³ SAS æ–°ç‰ˆæ™‚ï¼Œè«‹æ¯”å°å®˜æ–¹è®Šæ›´ï¼ˆä¾‹å¦‚ 1.1 çš„æ–°å¢æ¬„ä½ï¼‰å†è£œ V2__... è…³æœ¬ã€‚
		5.ç›¸å®¹æ€§èªªæ˜ï¼šSAS JDBC å¯¦ä½œä¾è³´é€™ä¸‰å¼µè¡¨çš„çµæ§‹ï¼ˆé¡åˆ¥æ–‡ä»¶ä¹Ÿæœ‰ç‰¹åˆ¥å¼·èª¿éœ€è¦å°æ‡‰ schemaï¼‰ã€‚



å‚™è¨»:
	ã€Œç¨®å­æª”ã€æ„æ€å…¶å¯¦è·Ÿ seed dataï¼ˆç¨®å­è³‡æ–™ï¼‰
		èƒŒæ™¯
			Spring Authorization Server (SAS) æœ¬èº«æä¾›ä¸€çµ„å…§å»ºçš„è³‡æ–™è¡¨ï¼ˆä¾‹å¦‚ registered_clientï¼‰ï¼Œç”¨ä¾†å­˜æ”¾æ‰€æœ‰ OAuth2 Client çš„è³‡è¨Šï¼ˆclient-idã€secretã€redirect-uriã€scopeã€grant-type ç­‰ï¼‰ã€‚
			ä½†é€™äº› client ä¸å¯èƒ½é ã€Œæ‰‹å‹•é€² DBã€æˆ–ã€ŒConsole GUI é»é¸ã€ç¶­è­·ï¼Œå› ç‚ºï¼š

				* äººå·¥æ“ä½œå®¹æ˜“å‡ºéŒ¯

				* å„ç’°å¢ƒï¼ˆdev/test/prodï¼‰éœ€è¦ä¸€è‡´æ€§

				* è¦ç¬¦åˆ CI/CD è‡ªå‹•åŒ–å¸ƒç½²
			æ‰€ä»¥æœƒå»ºè­°ï¼šæŠŠæ‰€æœ‰ client çš„å®šç¾©å¯«åœ¨ä¸€å€‹å›ºå®šçš„æª”æ¡ˆè£¡ï¼ˆYAML æˆ– JSON æ ¼å¼ï¼‰â†’ CI/CD pipeline å•Ÿå‹•æ™‚è®€å–é€™å€‹æª”æ¡ˆ â†’ ç¨®é€²è³‡æ–™åº«ã€‚
	
		ç¨®å­æª”ï¼ˆseed fileï¼‰çš„æ¦‚å¿µ
			* å°±åƒè³‡æ–™åº«åˆå§‹åŒ–æ™‚çš„ data.sql ä¸€æ¨£ï¼Œç¨®å­æª”æä¾›ã€Œåˆå§‹è³‡æ–™ä¾†æºã€ã€‚

			* å…§å®¹æœƒæè¿°æ‰€æœ‰å·²è¨»å†Šçš„ OAuth2 clientï¼Œä¾‹å¦‚ï¼š
				oauth2:
				  clients:
					- clientId: my-service-a
					  clientSecret: "{noop}secret-a"
					  clientAuthenticationMethods: [ "client_secret_basic" ]
					  authorizationGrantTypes: [ "client_credentials" ]
					  scopes: [ "read", "write" ]
					- clientId: my-service-b
					  clientSecret: "{noop}secret-b"
					  clientAuthenticationMethods: [ "client_secret_basic" ]
					  authorizationGrantTypes: [ "authorization_code" ]
					  redirectUris: [ "https://my-b-app/callback" ]
					  scopes: [ "openid", "profile" ]
				æˆ– JSON ç‰ˆæœ¬ï¼š
					[
					  {
						"clientId": "my-service-a",
						"clientSecret": "{noop}secret-a",
						"clientAuthenticationMethods": ["client_secret_basic"],
						"authorizationGrantTypes": ["client_credentials"],
						"scopes": ["read","write"]
					  }
					]
		CI/CD åŒ¯å…¥æµç¨‹
			1.ç¨®å­æª” æ”¾åœ¨å°ˆæ¡ˆ repoï¼ˆæˆ–ç¨ç«‹ config repoï¼‰

			2.CI/CD pipeline åœ¨éƒ¨ç½² auth server æ™‚ï¼š
				* å°‡é€™å€‹æª”æ¡ˆæ›é€²å®¹å™¨æˆ–è¤‡è£½åˆ° /config=
				* å•Ÿå‹•ä¸€å€‹ã€Œè³‡æ–™åˆå§‹åŒ–ç¨‹å¼ã€è®€é€™å€‹æª”æ¡ˆ
				* å¦‚æœ registered_client è¡¨æ²’æœ‰è©² client â†’ insert
				* å¦‚æœå·²å­˜åœ¨ â†’ update æˆ– skip

			3.å¥½è™•ï¼š
				* æ¯æ¬¡å¸ƒç½²å°±èƒ½ç¢ºä¿ DB å…§ client ç‹€æ…‹èˆ‡ repo ä¸­çš„ç¨®å­æª”ä¸€è‡´
				* é¿å… DBA/å·¥ç¨‹å¸«æ‰‹å‹•æ”¹ DB
				* é·ç§»æ–°ç’°å¢ƒï¼ˆdev/test/prodï¼‰åªè¦ä¸€æ¨£çš„ç¨®å­æª”

		ğŸ‘‰ ç¸½çµï¼š
			ã€Œç¨®å­æª”ã€å°±æ˜¯ æè¿°æ‰€æœ‰ OAuth2 client è¨»å†Šè³‡æ–™çš„ YAML/JSON é…ç½®æª”ï¼Œ
			å®ƒæ˜¯ å–®ä¸€çœŸç›¸ä¾†æº (source of truth)ï¼Œé€é CI/CD åŒ¯å…¥ DBï¼Œè®“ Spring Authorization Server çš„ registered_client è¡¨ä¿æŒä¸€è‡´æ€§èˆ‡å¯è¿½è¹¤æ€§ã€‚
	
	
	ã€ŒToken Profileï¼ˆä»¤ç‰Œæ¨£æ¿ï¼‰ã€ è·Ÿ Spring Boot çš„ profile å®Œå…¨ç„¡é—œï¼Œæ„æ€æ¯”è¼ƒæ¥è¿‘ã€Œç¯„æœ¬é…ç½®ã€è€Œä¸æ˜¯ç’°å¢ƒ profileã€‚
		ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µæ˜¯ï¼š
			ä½ æœƒæœ‰å¾ˆå¤š RegisteredClientï¼ˆå¯èƒ½ä¸Šç™¾ä¸Šåƒå€‹ machine-to-machine clientï¼‰ã€‚

			ä½†å®ƒå€‘çš„ Token è¨­å®šå¸¸å¸¸æ˜¯ã€Œå¤§åŒå°ç•°ã€ï¼š
				* grant typeï¼ˆä¾‹å¦‚ client_credentialsï¼‰
				* access token TTLï¼ˆä¾‹å¦‚ 15 åˆ†é˜ï¼‰
				* refresh token TTLï¼ˆå¯èƒ½é—œé–‰ï¼‰
				* audienceï¼ˆtoken ç™¼çµ¦å“ªäº› resource serverï¼‰
				* scope ç™½åå–®
				* å¿…å¸¶ claimsï¼ˆä¾‹å¦‚ clientIdã€orgã€ç’°å¢ƒæ¨™ç±¤â€¦ï¼‰

		å¦‚æœæ¯å€‹ client éƒ½è¦å–®ç¨è¤‡è£½é€™äº›è¨­å®š â†’ ç®¡ç†è² æ“”æœƒçˆ†ç‚¸ã€‚
		æ‰€ä»¥æˆ‘å€‘é€šå¸¸æœƒåšä¸€å€‹ã€ŒæŠ½è±¡å±¤ã€ï¼š
		
		æ–¹æ¡ˆ Aï¼šå»ºä¸€å¼µ TokenProfile è¡¨ï¼ˆæ¨è–¦åšæ³•ï¼‰
			CREATE TABLE token_profile (
				id BIGINT PRIMARY KEY,
				code VARCHAR(50) UNIQUE NOT NULL,  -- ä¾‹å¦‚ "M2M_DEFAULT", "EXT_PARTNER"
				grant_types VARCHAR(200),
				access_token_ttl INT,              -- ç§’æ•¸
				refresh_token_ttl INT,
				audience VARCHAR(500),
				scope_whitelist VARCHAR(1000),
				required_claims VARCHAR(1000)
			);

			ALTER TABLE registered_client ADD COLUMN token_profile_id BIGINT;

			ç„¶å¾Œåœ¨ RegisteredClient è£¡æŒ‡å‘æŸå€‹ profileï¼š

				clientA â†’ M2M_DEFAULT

				clientB â†’ EXT_PARTNER

				clientC â†’ INTERNAL_LONG_LIVED

		æ–¹æ¡ˆ Bï¼šç´” YAML/JSON ç¨®å­æª”æŠ½è±¡
			ä¸å»ºæ–°è¡¨ï¼Œè€Œæ˜¯åœ¨ CI/CD åŒ¯å…¥ RegisteredClient çš„æ™‚å€™ï¼Œé  YAML æŠ½è±¡å‡ºã€Œæ¨£æ¿ã€ï¼Œç„¶å¾Œå±•é–‹æˆå¤šå€‹ clientã€‚
			ç¼ºé»æ˜¯æŸ¥è©¢/é‹ç¶­æ™‚ä¸ç›´è§€ï¼Œå› ç‚º DB è£¡æ²’æœ‰ profile æ¦‚å¿µï¼Œåªæœ‰ clientã€‚

		ğŸ‘‰ çµè«–ï¼š
			é€™è£¡çš„ Profile æŒ‡çš„æ˜¯ ä½ è‡ªè¨‚çš„ã€ŒToken è¨­å®šç¯„æœ¬ã€æŠ½è±¡å±¤ï¼Œé€šå¸¸æœƒå¯¦ä½œæˆä¸€å¼µ tableï¼ˆæˆ–è‡³å°‘æ˜¯ YAML ç¨®å­æª”çš„æŠ½è±¡ï¼‰ï¼Œä¸¦ä¸æ˜¯ Spring Boot çš„ profileã€‚