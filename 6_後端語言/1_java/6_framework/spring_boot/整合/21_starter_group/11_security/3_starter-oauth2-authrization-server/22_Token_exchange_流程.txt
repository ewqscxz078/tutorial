ref ChatGPT

grant_type èˆ‡ access token
	| ä½ å¸¸è¦‹çš„æµç¨‹                     | å°æ‡‰ grant_type       | çµæœ          |
	| ---------------------------- | -------------------- | ------------ |
	| client id + secret æ‹¿ token   | `client_credentials` | access token |
	| æœ‰ refresh token é‡æ–°æ‹¿ token   | `refresh_token`      | access token |
	| ç”¨ subject tokenï¼ˆATâ‚ï¼‰æ› token | `token_exchange`     | access token |


å¸¸è¦‹å…©ç¨®è®Šé«”
	| å‹å¼                        | æè¿°                                                | å„ªé»                    | ç¼ºé»              |
	| -------------------------- | -------------------------------------------------- | --------------------- | --------------- |
	| **é›™æ®µäº¤æ›ï¼ˆC â†’ C2P â†’ C2PEï¼‰** | å…ˆåœ¨é›²åŸŸ AS-C2P æ› ATâ‚‚ï¼Œå†ç”± AS-C2P å° AS-C2PE è¯é‚¦ç™¼ ATâ‚ƒ | æœ€å¸¸è¦‹ï¼›æ¬Šè²¬æ¸…æ¥šï¼›å¯å¯©è¨ˆæ¯ä¸€æ®µ | å¤šä¸€æ¬¡ RTTï¼›éœ€å…©å¥—ä¿¡ä»»é—œä¿‚ |
	| **å–®æ®µäº¤æ›ï¼ˆC â†’ C2PEï¼‰**       | AS-C ç›´æ¥èˆ‡ AS-C2PE è¯é‚¦                             | æ•ˆç‡é«˜                  | è·¨å€ä¿¡ä»»æ›´è¤‡é›œï¼Œå®‰å…¨åŸŸç¸®å°   |

ä»¥ä¸‹é‡å°é›™æ®µäº¤æ›èªªæ˜ä¹‹ AS-C2P å¯ä»¥ç›´æ¥ç™¼ AS-C2P æˆæ¬Š token
	å®šç¾©
		æ¥­å‹™æœå‹™
			CFA ç‚º client frontend a æœå‹™
			PBA ç‚º client on-prem backend a æœå‹™
		åŸºç¤å»ºè¨­æœå‹™
			AS-C ç‚º auth server for cloud
			AS-C2P ç‚º auth server for é›²åˆ°åœ°ä¹‹é›²ç«¯é‚Šç•Œ
			Gateway-C2P ç‚º Gateway é›²åˆ°åœ°ä¹‹é›²ç«¯é‚Šç•Œ
			Gateway-C2PE ç‚º Gateway é›²åˆ°åœ°ä¹‹åœ°ç«¯é‚Šç•Œ

	è·¨å€ Token exchange æµç¨‹ : é›™æ®µäº¤æ›
		| éšæ®µ | ä¸»é«”                         | å‹•ä½œ                                 | Token             |
		| --- | -------------------------- | ----------------------------------- | ----------------- |
		| 1   | CFA                        | å‘ AS-C æ‹¿ access token              | **ATâ‚ (é›²åŸŸ)**      |
		| 2   | CFA â†’ Gateway-C2P          | ç™¼è«‹æ±‚å¸¶ ATâ‚                           | é©—ç°½ ATâ‚            |
		| 3   | Gateway-C2P â†’ AS-C2P       | Token Exchange (subject_token=ATâ‚)   | å–å¾— **ATâ‚‚ (åœ°åŸŸ)**   |
		| 4   | Gateway-C2P â†’ Gateway-C2PE | è½‰ç™¼è«‹æ±‚ï¼ŒAuthorization: Bearer ATâ‚‚     | -                 |
		| 5   | Gateway-C2PE               | é©—ç°½ ATâ‚‚                              | é€šé                |
		| 6   | Gateway-C2PE â†’ PBA         | è½‰ç™¼çµ¦åœ°ç«¯æ¥­å‹™                          | PBA é©—ç°½æˆ–ä¿¡ä»» gateway |

	1ï¸.å„å€åŸŸçš„ Auth Server è²¬ä»»åˆ†é›¢
		AS-Cï¼šé›²åŸŸå…§ç®¡ç†é›²ç«¯è³‡æºï¼ˆä¾‹å¦‚ CBAï¼‰ã€‚
		AS-C2Pï¼šé›²ç«¯é‚Šç•Œä»£ç†ï¼Œä»£è¡¨é›²ç«¯å‘åœ°ç«¯äº¤æ›æˆæ¬Šã€‚
		AS-C2PEï¼šåœ°ç«¯é‚Šç•Œæˆæ¬Šï¼Œç°½ç™¼åœ°ç«¯å¯ç”¨çš„ Access Tokenã€‚
		âœ… å„è‡ªæŒæœ‰ä¸åŒ JWKSã€ä¿¡ä»»æ¸…å–®ã€å¯©è¨ˆç­–ç•¥ã€‚
		âœ… ä»»ä½• token åƒ…åœ¨è‡ªå·±ç¶²åŸŸæœ‰æ•ˆï¼Œä¸è·¨ç°½åä¿¡ä»»ã€‚

	2ï¸.Gateway æ˜¯ä¿¡ä»»é‚Šç•Œ
		Gateway-C2P æ˜¯å”¯ä¸€å¯ä»¥ã€Œæ›¿é›²ç«¯è«‹æ±‚è€…ç™¼èµ·äº¤æ›ã€çš„å¯¦é«”ã€‚
		é€™æ¨£å¯ä¿è­‰ï¼š
			* åœ°ç«¯ Auth Server ä¸å¿…æš´éœ²çµ¦å¤–ç¶²ã€‚
			* ä¸Šæ¸¸ client ä¸å¿…çŸ¥é“ä¸‹æ¸¸ Auth Server çš„å­˜åœ¨ã€‚

	ğŸ›¡ï¸ å¯¦ä½œæ™‚çš„å®‰å…¨é‡é»
		| é¢å‘                 | å»ºè­°                                                                |
		| ------------------- | ------------------------------------------------------------------ |
		| **Authentication**  | Gateway-C2P å‘ AS-C2P äº¤æ›æ™‚å¿…é ˆä½¿ç”¨ `client_secret_basic`ã€mTLS æˆ– DPoP |
		| **Claim å‚³é**       | ä½¿ç”¨ `act` (Actor) claim ä¿å­˜åŸ CFA çš„ sub/iss                        |
		| **Audience**        | ATâ‚‚ çš„ `aud` æ‡‰å°æº– Gateway-C2PE æˆ– åœ°ç«¯ API ç¾¤çµ„                       |
		| **Key Trust**       | AS-C2PE åªä¿¡ä»» AS-C2P çš„ç°½ç« å…¬é‘°ï¼Œä¸ä¿¡ä»» AS-C                             |
		| **JWKS Cache**      | Gateway æœ¬åœ°å¿«å– JWKS (çŸ­ TTL + ETag)                                 |
		| **Traceability**    | æ‰€æœ‰äº¤æ›è«‹æ±‚ç´€éŒ„ `subject_token_jti` â†” `exchanged_jti` é—œè¯              |


éšæ®µä¸‰
	åœ¨ Gateway-C2P éœ€è¦ã€Œåœ¨è½‰ç™¼å‰åšä¸€æ¬¡ RFC 8693 çš„æˆæ¬Šæµç¨‹ã€ï¼ŒæŠŠä¸Šæ¸¸å¸¶ä¾†çš„ ATâ‚ æ›æˆåœ°ç«¯å¯ç”¨çš„ ATâ‚‚ï¼Œç„¶å¾ŒæŠŠ Authorization æ›æ‰å†è½‰é€ã€‚

	1) Gateway-C2P è¦æº–å‚™ ClientRegistrationï¼ˆæ‰“AS-C2Pï¼‰
		ç”¨ ymlï¼ˆè‹¥ç‰ˆæœ¬å…è¨±è‡ªè¨‚ grant_typeï¼‰
			spring:
			  security:
				oauth2:
				  client:
					registration:
					  c2p-te:
						client-id: gateway-c2p
						client-secret: ${C2P_CLIENT_SECRET}
						authorization-grant-type: urn:ietf:params:oauth:grant-type:token-exchange
						scope: []   # é€šå¸¸ä¸éœ€è¦ï¼ŒTE ä¸»è¦é  audience/scope åƒæ•¸
						provider: c2p
					provider:
					  c2p:
						token-uri: https://auth.c2p.cloud/oauth2/token
						issuer-uri: https://auth.c2p.cloud

		æˆ–ç”¨ Java è¨»å†Šï¼ˆä¿éšªï¼‰
			@Bean
			ClientRegistrationRepository clientRegistrationRepository() {
				var teGrant = new AuthorizationGrantType("urn:ietf:params:oauth:grant-type:token-exchange");
				var c2p = ClientRegistration.withRegistrationId("c2p-te")
					.clientId("gateway-c2p")
					.clientSecret(System.getenv("C2P_CLIENT_SECRET"))
					.authorizationGrantType(teGrant)
					.tokenUri("https://auth.c2p.cloud/oauth2/token")
					.issuerUri("https://auth.c2p.cloud")
					.build();
				return new InMemoryClientRegistrationRepository(c2p);
			}

	2) Gateway-C2P å•Ÿç”¨ã€ŒToken Exchangeã€æˆæ¬Šæä¾›è€…
		@Bean
		OAuth2AuthorizedClientManager authorizedClientManager(
				ClientRegistrationRepository registrations,
				OAuth2AuthorizedClientRepository authorizedClients) {

			var teProvider = new TokenExchangeOAuth2AuthorizedClientProvider();
			teProvider.setAccessTokenResponseClient(new DefaultTokenExchangeTokenResponseClient());

			var provider = new DelegatingOAuth2AuthorizedClientProvider(teProvider);
			var manager = new DefaultOAuth2AuthorizedClientManager(registrations, authorizedClients);
			manager.setAuthorizedClientProvider(provider);
			return manager;
		}

	3) åœ¨ Gateway-C2P æ”¾ä¸€å€‹ WebClientï¼ˆæˆ– SCG MVC çš„ GlobalFilterï¼‰åšã€Œäº¤æ›ä¸¦æ›é ­ã€
		3.1 å»ºä¸€å€‹ ExchangeFilterFunction
			é€™å€‹ Filter æœƒï¼š
				1.å¾ä¸Šæ¸¸è«‹æ±‚è®€å‡º ATâ‚ï¼ˆAuthorization: Bearer ...ï¼‰ã€‚
				2.ç”¨ authorizedClientManager å° AS-C2P åš Token Exchangeï¼Œå¸¶ä¸Šå¿…è¦å±¬æ€§ï¼ˆsubject_token=ATâ‚ã€audience=api://pbaã€requested_token_type=access_tokenï¼‰ã€‚
				3.æ‹¿åˆ° ATâ‚‚ å¾Œï¼ŒæŠŠä¸‹æ¸¸è«‹æ±‚çš„ Authorization æ”¹æˆ Bearer ATâ‚‚ å†é€å‡ºã€‚
			@Bean
			ExchangeFilterFunction tokenExchangeFilter(OAuth2AuthorizedClientManager manager) {
				return (request, next) -> {
					var authz = request.headers().firstHeader(HttpHeaders.AUTHORIZATION);
					if (authz == null || !authz.startsWith("Bearer ")) {
						return next.exchange(request); // æ²’æœ‰ä¸Šæ¸¸ token å°±ä¸åš TE
					}
					var at1 = authz.substring("Bearer ".length());

					// é€™è£¡çš„ principal å¯ç”¨æŠ€è¡“å¸³è™Ÿä»£è¡¨ gateway è‡ªå·±
					var principal = new UsernamePasswordAuthenticationToken("gateway-c2p", "N/A",
							List.of(new SimpleGrantedAuthority("ROLE_GATEWAY")));

					var attrs = new HashMap<String, Object>();
					attrs.put("subject_token", at1);
					attrs.put("subject_token_type", "urn:ietf:params:oauth:token-type:access_token");
					attrs.put("requested_token_type", "urn:ietf:params:oauth:token-type:access_token");
					attrs.put("audience", "api://pba"); // æˆ– gateway-c2peï¼Œçœ‹ä½ çš„ç­–ç•¥
					// å¯é¸ï¼šattrs.put("scope", "pba.read pba.write");

					var authorize = OAuth2AuthorizeRequest
							.withClientRegistrationId("c2p-te")
							.principal(principal)
							.attributes(a -> a.putAll(attrs))
							.build();

					var authorized = manager.authorize(authorize);
					if (authorized == null || authorized.getAccessToken() == null) {
						return Mono.error(new IllegalStateException("Token Exchange failed: no access token"));
					}

					var at2 = authorized.getAccessToken().getTokenValue();

					var mutated = ClientRequest.from(request)
							.headers(h -> h.set(HttpHeaders.AUTHORIZATION, "Bearer " + at2))
							.build();

					return next.exchange(mutated);
				};
			}

		3.2 æŠŠ Filter æ›é€²ä½ ç”¨ä¾†æ‰“ Gateway-C2PE çš„ WebClient
			@Bean
			WebClient c2peClient(ExchangeFilterFunction tokenExchangeFilter) {
				return WebClient.builder()
					.baseUrl("https://gw.c2pe.edge") // ä½ åœ°ç«¯é–˜é“çš„å…¥å£
					.filter(tokenExchangeFilter)     // â† é—œéµï¼šæ¯æ¬¡è½‰é€å‰åš TE ä¸¦æ›é ­
					.build();
			}


	4) TE è«‹æ±‚å¿…è¦åƒæ•¸ï¼ˆé‡é»ï¼‰
		* grant_type: urn:ietf:params:oauth:grant-type:token-exchange
		* subject_token: ä¸Šæ¸¸å¸¶ä¾†çš„ ATâ‚
		* subject_token_type: urn:ietf:params:oauth:token-type:access_token
		* requested_token_type: urn:ietf:params:oauth:token-type:access_token
		* audience: è«‹å°æº–ã€Œä¸‹æ¸¸å¯¦éš›é©—è­‰é»ã€ï¼Œå»ºè­°ç”¨ gateway-c2pe æˆ–ä¸€çµ„åœ°ç«¯ API çš„è³‡æº ID

		* ï¼ˆé¸ï¼‰scope: è‹¥éœ€è¦ç¸®é™æˆ–æ“´å±•ï¼Œä¾ç­–ç•¥å¡«
		* ï¼ˆé¸ï¼‰Sender-constrainedï¼šè‹¥ä½ å•Ÿç”¨ DPoP æˆ– mTLSï¼Œè¦åŒæ™‚åœ¨ TE è«‹æ±‚èˆ‡å¾ŒçºŒå‘¼å«ä½¿ç”¨ç›¸åŒç¶å®š

	5) éŒ¯èª¤è™•ç†èˆ‡å¿«å–
		å¸¸è¦‹éŒ¯èª¤ç¢¼ï¼š
			invalid_grantï¼ˆsubject_token ç„¡æ•ˆ/éæœŸ/ä¸å¯äº¤æ›ï¼‰
			invalid_targetï¼ˆaudience ä¸è¢«å…è¨±ï¼‰
			insufficient_scopeï¼ˆTE å¾Œ scope ä¸è¶³ï¼‰

		å»ºè­°æŠŠ ATâ‚‚ ä¾ exp åšçŸ­æš«å¿«å–ï¼ˆä¾‹å¦‚ç”¨ OAuth2AuthorizedClientRepository é è¨­å°±æœƒä¿å­˜è‡³éæœŸï¼‰ï¼ŒåŒä¸€æ¢éˆè·¯å…§å¤šæ¬¡ä¸‹æ¸¸å‘¼å«å¯é‡ç”¨ï¼Œé¿å…æ¯æ¬¡éƒ½æ‰“ TEã€‚

	6) å°æŠ„ï¼šä½ è¦åš/é…å“ªäº›æ±è¥¿ï¼Ÿ
		 * AS-C2P æ”¯æ´ RFC 8693ï¼ˆå¾Œç«¯å·²å¯¦ä½œ provider/endpointï¼‰ã€‚
		 * Gateway-C2P
			 * è¨»å†Š ClientRegistrationï¼ˆc2p-teï¼‰
			 * å»ºç«‹ OAuth2AuthorizedClientManager + TokenExchange...Provider
			 * åœ¨è½‰ç™¼å‰è·‘ tokenExchangeFilterï¼ŒæŠŠ ATâ‚ â†’ ATâ‚‚ï¼Œæ› Authorization
		* Gateway-C2PE / PBA åªè¦ç…§å¸¸ç”¨ JWKS æœ¬åœ°é©—ç°½ ATâ‚‚ å³å¯ã€‚

	ç¸½çµ
		1.Gateway-C2P è¦è¨»å†Š ClientRegistrationRepository of AS-C2P token exchange
		2.Gateway-C2P å•Ÿç”¨ã€ŒToken Exchangeã€æˆæ¬Šæä¾›è€… OAuth2AuthorizedClientManager
		3.Gateway-C2P æ”¾ä¸€å€‹ WebClient åšã€Œäº¤æ›ä¸¦æ›é ­ JWTã€çš„ ExchangeFilterFunction è®“å…¶æ‰“ Gateway-C2PE ç½®æ›

		æ¦‚è¦æµç¨‹
			1.Gateway-C2P å…ˆå° AS-C2P é€å‡º Token Exchangeï¼ˆTEï¼‰ï¼›
			2.AS-C2P ä¾ç­–ç•¥ç”¢å‡ºã€Œåœ°ç«¯å¯ç”¨ã€çš„ access tokenï¼›
			3.Gateway-C2P æŠŠä¸Šæ¸¸ ATâ‚ æ›æˆ ATâ‚‚ï¼Œå†è½‰é€åˆ° Gateway-C2PEã€‚

			é—œéµæ˜¯ç¬¬ 2 æ­¥ AS-C2P å…§éƒ¨æ€éº¼å–å¾—â€œåœ°ç«¯å¯ç”¨â€ çš„ tokenï¼Œé€šå¸¸æœ‰å…©ç¨®è½åœ°æ³•ï¼ˆæ“‡ä¸€æˆ–ä¸¦å­˜ï¼‰ï¼š
				è·¯å¾‘ Aï¼šAS-C2P ç›´æ¥ç°½å‡ºã€ç”±åœ°ç«¯ä¿¡ä»»ï¼ˆå‰æœŸé–‹ç™¼æœ€å¸¸è¦‹ï¼‰
					* AS-C2P é©—å®Œ subject_token=ATâ‚ï¼ˆç”¨ AS-C çš„ JWKSï¼‰èˆ‡æ”¿ç­–ï¼ˆaudience/scope/actorâ€¦ï¼‰å¾Œï¼Œç›´æ¥ç°½ç™¼ ATâ‚‚ï¼Œiss = AS-C2Pã€‚
					* å‰æï¼šåœ°ç«¯é‚Šç•Œ Gateway-C2PE/PBA å¿…é ˆæŠŠ AS-C2P ç´å…¥ä¿¡ä»»åå–®ï¼ˆtrust its issuer & JWKSï¼‰ï¼Œæˆ–æŠŠ aud è¨­ç‚º Gateway-C2PE çš„è³‡æº IDã€‚
					* å„ªé»ï¼šAS ä¹‹é–“ä¸å¿…å†å‘¼å«ï¼›å»¶é²æœ€ä½ã€å¯ç”¨æ€§é«˜ã€‚
					* ä½ éœ€è¦åšçš„ï¼š
						* åœ¨ Gateway-C2PE/PBA é…ç½®ã€Œä¿¡ä»» iss = AS-C2P çš„ JWKSã€ã€‚
						* åœ¨ AS-C2P è¨­å®šåœ°ç«¯ audience å°æ‡‰èˆ‡ scope æ˜ å°„ï¼ˆaud=api://pba æˆ– aud=gateway-c2peï¼‰ã€‚

				è·¯å¾‘ Bï¼šAS-C2P èƒŒå¾Œå†å‘ AS-C2PE åšã€Œç¬¬äºŒæ®µäº¤æ›ã€
					* AS-C2P æ”¶åˆ° TE å¾Œï¼Œè‡ªå·±æˆç‚º OAuth2 clientï¼Œç”¨å®ƒå° AS-C2PE çš„æ†‘è­‰å†åšä¸€æ¬¡ TEï¼ˆæˆ– client_credentialsï¼‰ï¼Œå–å¾— ATâ‚‚ï¼ˆiss=AS-C2PEï¼‰ã€‚
					* å‰æï¼šAS-C2P èˆ‡ AS-C2PE ä¹‹é–“ç¶²è·¯å¯é”ä¸”æœ‰ client èªè­‰ï¼ˆclient_secret/mTLS/DPoPï¼‰ã€‚
					* ä½ éœ€è¦åšçš„ï¼š
						* åœ¨ AS-C2P å…§éƒ¨ä¹Ÿè¦æœ‰ä¸€ä»½ æŒ‡å‘ AS-C2PE çš„ ClientRegistrationï¼ˆçµ¦å®ƒè‡ªå·±å¾Œå°ç”¨ï¼‰ï¼Œä¾‹å¦‚ registration: c2pe-backchannelã€‚
						* è¨­å®šå¥½ç¬¬äºŒæ®µ TE æ‰€éœ€çš„ audience/scope æ˜ å°„ã€‚
					* å„ªé»ï¼šåœ°ç«¯åªä¿¡ä»» AS-C2PEï¼ˆå–®ä¸€ä¿¡ä»»ä¾†æºï¼‰ï¼›
					* ä»£åƒ¹ï¼šAS é–“å¤šä¸€æ¬¡å‘¼å«ï¼ŒAS-C2P æœ¬èº«è¦å…·å‚™ OAuth2 client èƒ½åŠ›ã€‚

å…©ç¨®æ‹“æ’²
	æ–¹æ¡ˆ Aï¼šBrokerï¼ˆé›™æ®µäº¤æ›ï¼‰
		* èª°é€å‡º TEï¼Ÿï¼šGateway-C2P
		* ç¬¬ä¸€è·³æ‰“å“ªï¼Ÿï¼šæ‰“ AS-C2Pï¼ˆé›²é‚Šç•Œ ASï¼‰ã€‚
		* ç¬¬äºŒè·³æ€ä¾†ï¼Ÿï¼šAS-C2P å†ã€Œè‡ªå·±ã€è·Ÿ AS-C2PE äº¤æ¡ï¼Œç°½å‡ºåœ°ç«¯å¯ç”¨çš„ tokenï¼ˆAS-C2Pâ†”AS-C2PE çš„å¾Œå°è¯é‚¦ï¼Œä¸æ˜¯ Gateway-C2P ç™¼ï¼‰ã€‚
		* å› æ­¤ï¼šGateway-C2P çš„ ClientRegistration æŒ‡å‘ AS-C2Pï¼ˆä¸æ˜¯ AS-C2PEï¼‰
	æ–¹æ¡ˆ Bï¼šDirectï¼ˆå–®æ®µäº¤æ›ï¼‰
		èª°é€å‡º TEï¼Ÿï¼šGateway-C2P
		ç¬¬ä¸€è·³æ‰“å“ªï¼Ÿï¼šç›´æ¥æ‰“ AS-C2PEï¼ˆåœ°ç«¯ ASï¼‰ã€‚
		å› æ­¤ï¼šGateway-C2P çš„ ClientRegistration å°±è¦æŒ‡å‘ AS-C2PEã€‚


æ‰€è¬‚çš„å…©æ®µå¼ Token exchange ä¹‹é›²ç®¡é›²çš„ã€åœ°ç®¡åœ°çš„ token æ¨¡å¼ ï¼ˆBroker æ¨¡å¼ï¼‰
	ğŸ§© ç°¡æ˜ç¸½è¦½ï¼šä¸‰å¼µ Token çš„ç”Ÿå‘½é€±æœŸ
		| Token åç¨± | èª°ç°½çš„ (issuer)                  | èª°ä½¿ç”¨                              | ç”¨é€”ï¼äº¤æ›ç›®çš„                                          |
		| -------- | ------------------------------- | -------------------------------- | ------------------------------------------------ |
		| **ATâ‚**  | ğŸŸ¦ **AS-C**ï¼ˆé›²ç«¯ Auth Serverï¼‰    | CFA â†’ Gateway-C2P                | é›²å‰ç«¯ CFA å‘¼å«é›²å´ API çš„åŸå§‹ access tokenï¼ˆsubject_tokenï¼‰ |
		| **ATâ‚‚**  | ğŸŸ¨ **AS-C2P**ï¼ˆé›²é‚Šç•Œ Auth Serverï¼‰ | Gateway-C2P â†’ AS-C2PE            | é›²é‚Šç•Œä»£è¡¨ CFA äº¤æ›å‡ºçš„ã€Œè·¨å€ä»£ç† tokenã€ï¼ˆintermediate tokenï¼‰   |
		| **ATâ‚ƒ**  | ğŸŸ« **AS-C2PE**ï¼ˆåœ°ç«¯ Auth Serverï¼‰ | Gateway-C2P â†’ Gateway-C2PE â†’ PBA | çœŸæ­£çµ¦åœ°ç«¯ç³»çµ±ç”¨çš„ access tokenï¼ˆæœ€çµ‚ tokenï¼‰                 |

		æ‰€ä»¥æ˜¯ ä¸‰å¼µ tokenï¼ˆATâ‚ â†’ ATâ‚‚ â†’ ATâ‚ƒï¼‰ï¼Œå°æ‡‰ å…©æ¬¡äº¤æ›ï¼š

			AT1 (AS-C)
			   â”‚   [ç¬¬ä¸€æ¬¡ TE]
			   â–¼
			AT2 (AS-C2P)
			   â”‚   [ç¬¬äºŒæ¬¡ TE]
			   â–¼
			AT3 (AS-C2PE)

		ğŸ” è©³ç´°èªªæ˜æ¯ä¸€å¼µ token
			1) ATâ‚ â€” ã€Œé›²å‰ç«¯æ†‘è­‰ã€
				| é …ç›®                   | èªªæ˜                                   |
				| -------------------- | -------------------------------------- |
				| **Issuer (`iss`)**   | `https://auth.c.cloud` (AS-C)          |
				| **Audience (`aud`)** | `gateway-c` æˆ– `gateway-c2p`           |
				| **Subject (`sub`)**  | `svc-cfa`ï¼ˆé›²å‰ç«¯ clientï¼‰               |
				| **ç”¨åœ¨èª°èº«ä¸Š**           | CFA â†’ Gateway-C2P                     |
				| **ç”¨é€”**               | é›²å‰ç«¯ CFA å‘¼å«é›²åˆ°åœ° API æ™‚çš„åŸå§‹ token     |
				| **ä¸‹ä¸€æ­¥**             | ä½œç‚º `subject_token` çµ¦ AS-C2P åšç¬¬ä¸€æ¬¡ TE |

			2) ATâ‚‚ â€” ã€Œè·¨å€ä»£ç† (intermediate) tokenã€
				| é …ç›®                   | èªªæ˜                                               |
				| -------------------- | -------------------------------------------------- |
				| **Issuer (`iss`)**   | `https://auth.c2p.cloud` (AS-C2P)                  |
				| **Audience (`aud`)** | `https://auth.c2pe.edge`ï¼ˆåœ°ç«¯ ASï¼‰                  |
				| **Subject (`sub`)**  | `gateway-c2p`                                      |
				| **Actor (`act`)**    | `{"sub":"svc-cfa","iss":"https://auth.c.cloud"}`   |
				| **ç”¨åœ¨èª°èº«ä¸Š**           | AS-C2P â†’ AS-C2PEï¼ˆç¬¬äºŒæ¬¡ TE æ™‚ï¼‰                      |
				| **ç”¨é€”**               | ä»£è¡¨ CFAï¼Œè®“ AS-C2P å¯ä»¥å° AS-C2PE è¦åœ°ç«¯ access token  |
				| **å£½å‘½**               | å¾ˆçŸ­ï¼ˆä¾‹å¦‚ 30 ç§’ï½1 åˆ†é˜ï¼‰                              |

			3ï¸) ATâ‚ƒ â€” ã€Œåœ°ç«¯ access tokenã€
				| é …ç›®                   | èªªæ˜                                               |
				| --------------------- | ------------------------------------------------- |
				| **Issuer (`iss`)**    | `https://auth.c2pe.edge` (AS-C2PE)                |
				| **Audience (`aud`)**  | `gateway-c2pe` æˆ– `api://pba`                      |
				| **Subject (`sub`)**   | `gateway-c2p`ï¼ˆä»£è¡¨è€…ï¼‰                              |
				| **Actor (`act`)**     | `{"sub":"svc-cfa","iss":"https://auth.c.cloud"}`  |
				| **ç”¨åœ¨èª°èº«ä¸Š**           | Gateway-C2P â†’ Gateway-C2PE â†’ PBA                  |
				| **ç”¨é€”**               | åœ°ç«¯å¯é©—ç°½ã€åŸ·è¡Œæ¥­å‹™çš„æœ€çµ‚ JWT                            |
				| **å£½å‘½**               | é€šå¸¸ 3ï½5 åˆ†é˜                                        |
				| **åœ°ç«¯ä¿¡ä»»çš„ AS**        | åªä¿¡ `iss=https://auth.c2pe.edge`                  |

		ğŸ§­ å…©æ¬¡ Token Exchange çš„å°æ‡‰é—œä¿‚
			| Exchange æ¬¡æ•¸  | èª°ç™¼èµ·       | èª°è™•ç†    | `subject_token`    | ç™¼å‡ºæ–°çš„ token | çµæœ              |
			| ------------ | ----------- | ------- | ------------------- | ------------ | --------------- |
			| **ç¬¬ä¸€æ¬¡ TE**  | Gateway-C2P | AS-C2P  | ATâ‚                 | ATâ‚‚          | é›²åˆ°é‚Šç•Œä»£ç† token   |
			| **ç¬¬äºŒæ¬¡ TE**  | AS-C2P      | AS-C2PE | ATâ‚‚ (æˆ–ç›´æ¥ ATâ‚ï¼Œä¾ç­–ç•¥) | ATâ‚ƒ          | åœ°ç«¯ access token |

		ğŸ” éª¨å¹¹æµç¨‹ï¼ˆç¸½è¦½ï¼‰
			sequenceDiagram
			  participant CFA
			  participant GW_C2P as Gateway-C2P
			  participant AS_C2P as Auth Server C2P
			  participant AS_C2PE as Auth Server C2PE
			  participant GW_C2PE as Gateway-C2PE
			  participant PBA

			  CFA->>GW_C2P: API + ATâ‚ (iss=AS-C)
			  GW_C2P->>AS_C2P: TE #1 (subject_token=ATâ‚)
			  AS_C2P-->>GW_C2P: ATâ‚‚ (iss=AS-C2P)
			  AS_C2P->>AS_C2PE: TE #2 (subject_token=ATâ‚‚)
			  AS_C2PE-->>AS_C2P: ATâ‚ƒ (iss=AS-C2PE)
			  AS_C2P-->>GW_C2P: ATâ‚ƒ
			  GW_C2P->>GW_C2PE: Authorization: Bearer ATâ‚ƒ
			  GW_C2PE->>PBA: Forward request
			  PBA-->>GW_C2PE: 200 OK
			  GW_C2PE-->>CFA: Response


		ğŸ§  é€™æ¨£åˆ†å±¤çš„å¥½è™•
			| å±¤            | æˆæ¬Šè²¬ä»»                                    | èªªæ˜ |
			| ------------ | ----------------------------------------- | -- |
			| AS-C         | é›²å…§æˆæ¬Šï¼Œåªç™¼é›²åŸŸ tokenï¼ˆATâ‚ï¼‰                  |    |
			| AS-C2P       | é©—é›²ç«¯ tokenï¼Œæ±ºå®šæ˜¯å¦å…è¨±è·¨å€ï¼›åªç™¼ä¸­ä»‹ tokenï¼ˆATâ‚‚ï¼‰ |    |
			| AS-C2PE      | åœ°ç«¯ç°½ç™¼ tokenï¼ˆATâ‚ƒï¼‰ï¼Œæˆæ¬Šåœ°ç«¯è³‡æº               |    |
			| Gateway-C2P  | åªç®¡è½‰æ›ã€å¿«å–ï¼›ä¸ç°½ç™¼ã€ä¸é©—ç°½                    |    |
			| Gateway-C2PE | é©—ç°½åœ°ç«¯ tokenï¼Œè½‰çµ¦ PBA                      	|    |

		âœ… é€™æ¨£ï¼š
			* æ¯å€‹å€åªç®¡ç†è‡ªå·±å€çš„ tokenï¼›
			* æ¯å€‹ token çš„ iss å”¯ä¸€æ­¸å±¬ï¼›
			* æ¯å±¤ä¿¡ä»»é‚Šç•Œæ¸…æ¥šï¼›
			* ç¨½æ ¸éˆå®Œæ•´ï¼ˆATâ‚ â†” ATâ‚‚ â†” ATâ‚ƒ éƒ½æœ‰ act claimï¼‰ã€‚

		âœ³ï¸ åœ¨æ­£å¼çš„ã€Œé›²ç®¡é›²ã€åœ°ç®¡åœ°ã€å…©æ®µå¼ Token Exchange æ¶æ§‹ä¸­ï¼š
			ä½ æœƒçœ‹åˆ°ä¸‰å¼µ tokenï¼š
				* ATâ‚ï¼ˆé›²ç«¯ access token, AS-Cï¼‰
				* ATâ‚‚ï¼ˆä¸­ä»‹ exchange token, AS-C2Pï¼‰
				* ATâ‚ƒï¼ˆåœ°ç«¯ access token, AS-C2PEï¼‰

			Gateway-C2P è§¸ç™¼ç¬¬ä¸€æ¬¡äº¤æ›ï¼ˆATâ‚â†’ATâ‚‚ï¼‰ï¼Œ
			AS-C2P è§¸ç™¼ç¬¬äºŒæ¬¡äº¤æ›ï¼ˆATâ‚‚â†’ATâ‚ƒï¼‰ï¼Œ
			æœ€çµ‚ ATâ‚ƒ æ˜¯å”¯ä¸€èƒ½è¢«åœ°ç«¯é©—ç°½ã€æˆæ¬Šä½¿ç”¨çš„ tokenã€‚