旋轉策略表：oauth2aj001 : jwk_rotation_policy
	v1
		CREATE TABLE dbo.jwk_rotation_policy (
			id                      INT IDENTITY(1,1) PRIMARY KEY,
			issuer                  NVARCHAR(200) NOT NULL,     -- e.g. https://auth.example.com
			purpose                 NVARCHAR(8)  NOT NULL,      -- 'sig' or 'enc'
			alg                     NVARCHAR(32) NOT NULL,      -- 'RS256','ES256','EdDSA'...
			key_bits                INT NULL,                   -- RSA 長度
			curve                   NVARCHAR(32) NULL,          -- EC 曲線
			rotate_every_days       INT NOT NULL,               -- 幾天換鑰
			overlap_minutes         INT NOT NULL,               -- ACTIVE→GRACE 重疊多久（驗章容忍期）
			not_before_skew_secs    INT NOT NULL DEFAULT 0,     -- NBF 時鐘偏移
			max_token_ttl_minutes   INT NOT NULL,               -- 系統核發之最大 token TTL（便於計算 GRACE）
			allow_parallel_active   BIT NOT NULL DEFAULT 0,     -- 是否允許同演算法同時多把 ACTIVE（通常否）
			enabled                 BIT NOT NULL DEFAULT 1,
			comment                 NVARCHAR(4000) NULL
		);
		CREATE UNIQUE INDEX UX_rotation_policy_key
		ON dbo.jwk_rotation_policy(issuer, purpose, alg);

	v2
		CREATE TABLE dbo.jwk_rotation_policy (
		  id                   BIGINT IDENTITY(1,1) PRIMARY KEY,
		  issuer               NVARCHAR(200) NOT NULL,       -- e.g. https://auth.example.com
		  purpose              NVARCHAR(8)   NOT NULL,       -- 'sig' or 'enc'
		  kty                  NVARCHAR(16)  NOT NULL,       -- 'RSA','EC','OKP'...
		  alg                  NVARCHAR(32)  NOT NULL,       -- 'RS256','ES256','EdDSA'...
		  rotation_interval_days   INT        NOT NULL,      -- 多久輪一次（例：30）
		  transition_days          INT        NOT NULL,      -- ACTIVE -> PREV_ACTIVE 的過渡期（例：7）
		  prev_active_days         INT        NOT NULL,      -- 保留上一把 ACTIVE 的天數（例：7）
		  overlap_grace_days       INT        NOT NULL,      -- 舊 token 容忍期（資源端驗證 grace）（例：1~3）
		  auto_rotate              BIT        NOT NULL,      -- 是否自動輪轉
		  max_keys_retained        INT        NOT NULL,      -- 最多保留幾把歷史鑰（含非發佈）
		  last_rotated_at          DATETIME2  NULL,
		  next_rotate_at           DATETIME2  NULL,
		  created_at               DATETIME2  NOT NULL DEFAULT SYSUTCDATETIME(),
		  updated_at               DATETIME2  NOT NULL DEFAULT SYSUTCDATETIME()
		);

		CREATE UNIQUE INDEX UX_jwk_rotation_policy_issuer_purpose_alg
		  ON dbo.jwk_rotation_policy(issuer, purpose, alg);

		CREATE INDEX IX_jwk_rotation_policy_next_due
		  ON dbo.jwk_rotation_policy(next_rotate_at) WHERE auto_rotate = 1;

	v3
		CREATE TABLE dbo.jwk_rotation_policy (
		  id                     BIGINT IDENTITY(1,1) PRIMARY KEY,
		  issuer                 NVARCHAR(200) NOT NULL,         -- e.g. https://auth.example.com
		  purpose                NVARCHAR(8)   NOT NULL,         -- 'sig' | 'enc'
		  kty                    NVARCHAR(16)  NOT NULL,         -- 'RSA' | 'EC' | 'OKP' ...
		  alg                    NVARCHAR(32)  NOT NULL,         -- 'RS256' | 'ES256' | 'EdDSA' ...

		  -- 策略時間：存 ISO-8601 Duration 字串，如 PT30M / PT2H / P1D
		  rotation_interval_iso  NVARCHAR(40)  NOT NULL CONSTRAINT DF_jrp_rotation_interval_iso DEFAULT N'P1D',
		  transition_iso         NVARCHAR(40)  NOT NULL CONSTRAINT DF_jrp_transition_iso        DEFAULT N'P7D',
		  prev_active_iso        NVARCHAR(40)  NOT NULL CONSTRAINT DF_jrp_prev_active_iso       DEFAULT N'P7D',
		  overlap_grace_iso      NVARCHAR(40)  NOT NULL CONSTRAINT DF_jrp_overlap_grace_iso     DEFAULT N'PT48H',

		  auto_rotate            BIT           NOT NULL CONSTRAINT DF_jrp_auto_rotate           DEFAULT (1),
		  max_keys_retained      INT           NOT NULL CONSTRAINT DF_jrp_max_keys_retained     DEFAULT (6),

		  last_rotated_at        DATETIME2     NULL,
		  next_rotate_at         DATETIME2     NULL,

		  created_at             DATETIME2     NOT NULL CONSTRAINT DF_jrp_created_at            DEFAULT SYSUTCDATETIME(),
		  updated_at             DATETIME2     NOT NULL CONSTRAINT DF_jrp_updated_at            DEFAULT SYSUTCDATETIME(),

		  -- 唯一鍵：同 issuer/purpose/alg 僅一條策略
		  CONSTRAINT UX_jrp_issuer_purpose_alg UNIQUE (issuer, purpose, alg),

		  -- 基本檢核
		  CONSTRAINT CK_jrp_purpose CHECK (purpose IN (N'sig', N'enc')),
		  CONSTRAINT CK_jrp_rotation_interval_iso CHECK (rotation_interval_iso LIKE N'P%'),
		  CONSTRAINT CK_jrp_transition_iso        CHECK (transition_iso        LIKE N'P%'),
		  CONSTRAINT CK_jrp_prev_active_iso       CHECK (prev_active_iso       LIKE N'P%'),
		  CONSTRAINT CK_jrp_overlap_grace_iso     CHECK (overlap_grace_iso     LIKE N'P%')
		);
		GO

		-- 到期自動輪轉常用查詢：過濾索引（僅 auto_rotate=1 且有時間者）
		CREATE INDEX IX_jrp_next_due
		  ON dbo.jwk_rotation_policy (next_rotate_at)
		  WHERE auto_rotate = 1 AND next_rotate_at IS NOT NULL;
		GO

		-- 依 issuer 查詢/發佈時會用到
		CREATE INDEX IX_jrp_issuer ON dbo.jwk_rotation_policy (issuer);
		GO
