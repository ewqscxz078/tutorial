ref ChatGPT


å‰ç«¯è¦åšçš„äº‹ï¼ˆOIDC Clientï¼‰
	1) å…ˆæº–å‚™ï¼ˆè¨»å†Šè³‡è¨Šï¼‰

		* ä½ åœ¨ IdP/Auth Server è¨»å†Šä¸€å€‹ Clientï¼ˆé€šå¸¸æ˜¯ã€ŒPublic Clientã€ï¼‰

		* è¨­å¥½ï¼š

			* redirect_uriï¼ˆç™»å…¥å¾Œå°å›å‰ç«¯çš„ URIï¼‰

			* post_logout_redirect_uriï¼ˆç™»å‡ºå¾Œå°å›ï¼‰

			* scopesï¼šè‡³å°‘ openidï¼Œå¸¸åŠ  profileã€email

			* å›æ‡‰å‹åˆ¥ï¼šresponse_type=code

			* PKCEï¼šé€šå¸¸è¦æ±‚ S256

	2) ç”¢ç”Ÿ PKCE åƒæ•¸ + state/nonce

		å‰ç«¯åœ¨ã€Œå°å»ç™»å…¥ã€å‰è¦åšï¼š

			* ç”¢ç”Ÿ code_verifierï¼ˆé«˜ç†µéš¨æ©Ÿå­—ä¸²ï¼‰

			* ç”¢ç”Ÿ code_challenge = BASE64URL(SHA256(code_verifier))

			* ç”¢ç”Ÿ stateï¼ˆé˜² CSRF / å›æ‡‰å°æ‡‰ï¼‰

			* ç”¢ç”Ÿ nonceï¼ˆOIDC ç”¨ä¾†ç¶å®š ID Tokenï¼Œé˜²é‡æ”¾ï¼‰

		ä¸¦æŠŠ code_verifierã€stateã€nonce æš«å­˜ï¼ˆå¸¸è¦‹ï¼šmemory æˆ– sessionStorageï¼›ä¸å»ºè­° localStorage æ”¾æ•æ„Ÿè³‡æ–™ï¼‰ã€‚

	3) é€ä½¿ç”¨è€…å»æˆæ¬Šç«¯é»ï¼ˆAuthorization Requestï¼‰

		å‰ç«¯å°å‘ï¼š

			* GET /authorize?...
			åŒ…å«ï¼š

			* client_id

			* redirect_uri

			* response_type=code

			* scope=openid ...

			* code_challenge

			* code_challenge_method=S256

			* state

			* nonce

	4) æ¥æ”¶ redirect å›ä¾†çš„ code

		ç™»å…¥æˆåŠŸå¾Œï¼ŒIdP æœƒæŠŠä½¿ç”¨è€…å°å› redirect_uriï¼Œå¸¶ï¼š

			* code

			* state

		å‰ç«¯è¦åšï¼š

			* æª¢æŸ¥ state æ˜¯å¦èˆ‡å…ˆå‰ä¿å­˜ä¸€è‡´ï¼ˆä¸ä¸€è‡´å°±ä¸Ÿæ‰ï¼‰

			* å–å¾— code å¾Œï¼Œé€²è¡Œã€Œæ› Tokenã€

	5) ç”¨ PKCE æ› Tokenï¼ˆToken Requestï¼‰

		å‰ç«¯å‘¼å« token endpointï¼š

			* POST /token
			å¸¶ï¼š

			* grant_type=authorization_code

			* client_idï¼ˆPublic client å¸¸è¦‹ä»éœ€è¦ï¼‰

			* code

			* redirect_uri

			* code_verifierï¼ˆé—œéµï¼šPKCE çš„ verifierï¼‰

		æ›å›ï¼š

			* id_tokenï¼ˆOIDCï¼‰

			* access_token

			* refresh_tokenï¼ˆæ˜¯å¦çµ¦ï¼Œçœ‹ IdP æ”¿ç­–ï¼›SPA ç¾åœ¨å¾ˆå¤šå»ºè­°ç”¨ refresh rotation/æˆ–ä¹¾è„†ä¸ç”¨ï¼‰

			* expires_in

	6) é©—è­‰ / ä½¿ç”¨ Tokenï¼ˆå‰ç«¯è§’åº¦ï¼‰

		* æœ€å°è¦æ±‚ï¼šè‡³å°‘è¦åš id_token çš„ nonce æª¢æŸ¥ï¼ˆå¾ˆå¤š OIDC library æœƒå¹«ä½ åšï¼‰

		* å–å¾—ä½¿ç”¨è€…è³‡è¨Šï¼š

			* æ–¹å¼ Aï¼šè§£ id_token claimsï¼ˆå¸¸ç”¨ï¼‰

			* æ–¹å¼ Bï¼šå‘¼å« userinfo endpointï¼ˆaccess_token + scope æ§åˆ¶ï¼‰

		* å‘¼å«å¾Œç«¯ API æ™‚ï¼š

			* Authorization: Bearer <access_token>

	7) Token å„²å­˜ç­–ç•¥ï¼ˆéå¸¸é—œéµï¼‰

		å¸¸è¦‹é¸æ“‡ï¼š

		* BFF æ¨¡å¼ï¼ˆæ¨è–¦ï¼‰ï¼šå‰ç«¯ä¸è¦æ‹¿ access_tokenï¼Œæ”¹ç”±å¾Œç«¯æŒæœ‰ tokenï¼›å‰ç«¯åªæ‹¿ session cookieï¼ˆHttpOnly + SameSiteï¼‰ï¼Œå®‰å…¨æ€§æœ€å¥½ã€‚

		* ç´” SPA æ¨¡å¼ï¼šå‰ç«¯æŒæœ‰ access_token

			* å„ªå…ˆæ”¾ memoryï¼ˆé‡æ•´æœƒæ‰ï¼Œè¦è‡ªè¡Œè™•ç†ï¼‰

			* ç›¡é‡ä¸è¦ localStorageï¼ˆXSS é¢¨éšªï¼‰

	8) ç™»å‡º

		* å‰ç«¯å°å‘ end_session_endpointï¼ˆæˆ– IdP logout endpointï¼‰

		* å¸¶ id_token_hintã€post_logout_redirect_uriï¼ˆä¾ IdPï¼‰

		* æœ¬åœ°ä¹Ÿè¦æ¸…æ‰ session/token


å¾Œç«¯è¦åšçš„äº‹ï¼ˆAPI / Resource Server / BFFï¼‰

	ä½ å¾Œç«¯çš„è§’è‰²æœƒæœ‰å…©ç¨®å…¸å‹ï¼š
		A) å¾Œç«¯æ˜¯ Resource Serverï¼ˆå‰ç«¯ç›´æ¥å¸¶ access_token ä¾†ï¼‰

			é€™æ˜¯ã€ŒSPA ç›´æ¥å‘¼å« APIã€æœ€å¸¸è¦‹çš„åˆ‡æ³•ã€‚

				1) é©—è­‰ JWT Access Token

					* è¨­å®š issuer-uriï¼ˆæˆ– jwk-set-uriï¼‰

					* é©—ç« ï¼ˆç°½ç« ã€æœ‰æ•ˆæœŸã€issuerã€audienceã€scope/rolesï¼‰

					* æŠŠ claims æ˜ å°„æˆä½ ç³»çµ±çš„æˆæ¬Šæ¨¡å‹ï¼ˆAuthorities/Rolesï¼‰

				2) æˆæ¬Šï¼ˆAuthorizationï¼‰

					* ç”¨ scope / roles / è‡ªè¨‚ claimï¼ˆä¾‹å¦‚ä½ çš„ aud / tenant / zoneï¼‰

					* API ç«¯é»åšæ¬Šé™æ§åˆ¶ï¼ˆä¾‹å¦‚ Spring Security hasAuthority("SCOPE_xxx")ï¼‰

				3) CORS / CSRF

					* å› ç‚ºæ˜¯ Bearer tokenï¼Œå¤šæ•¸æƒ…æ³ CSRF ä¸é©ç”¨ï¼ˆä¸æ˜¯ cookie-basedï¼‰

					* ä½†ä½ è¦æ­£ç¢ºè¨­å®š CORSï¼ˆå…è¨±å‰ç«¯ç¶²åŸŸã€headersã€methodsï¼‰

				4) ä¸è¦æŠŠ token ç•¶ session

					* å¾Œç«¯æ‡‰è©²ç„¡ç‹€æ…‹é©—è­‰ï¼ˆJWTï¼‰

					* åªåœ¨å¿…è¦æ™‚åš token blacklist / jti denyï¼ˆç™»å‡ºç«‹å³å¤±æ•ˆçš„éœ€æ±‚æ‰åšï¼‰

		B) å¾Œç«¯æ˜¯ BFFï¼ˆBackend For Frontendï¼‰ï¼ˆæ¨è–¦åšæ³•ï¼‰

			å‰ç«¯åªè·Ÿ BFF æºé€šï¼ŒBFF æ‰è·Ÿ IdP æ› tokenã€è·Ÿè³‡æºä¼ºæœå™¨å‘¼å« APIã€‚

				1) BFF è®Šæˆ OIDC Client

					* BFF è² è²¬ï¼š

					* å»ºç«‹ authorization requestï¼ˆå« PKCEï¼Œæˆ–ç”±æ¡†æ¶è‡ªå‹•è™•ç†ï¼‰

					* æ¥ redirectï¼ˆcode å›åˆ° BFFï¼‰

					* ç”¨ code_verifier å» token endpoint æ› token

					* token å­˜åœ¨å¾Œç«¯ï¼ˆserver-sideï¼‰

				2) å°å‰ç«¯ç”¨ã€ŒSession Cookieã€

					* BFF å»ºç«‹ sessionï¼Œç™¼ HttpOnly cookie çµ¦ç€è¦½å™¨

					* å‰ç«¯å‘¼å« BFF API æ™‚ä¸å¸¶ access_tokenï¼Œåªé  cookie

				3) BFF ä»£å‘¼å«ä¸‹æ¸¸ API

					* BFF å¾è‡ªå·±çš„ token store å–å‡º access_token

					* å‘¼å«ä¸‹æ¸¸ Resource Serverï¼ˆæˆ– Gatewayï¼‰æ™‚åŠ ä¸Š Bearer token

				4) å®‰å…¨æ€§å„ªé»

					* å‰ç«¯ JS æ‹¿ä¸åˆ° tokenï¼ˆå¤§å¹…é™ä½ XSS é€ æˆ token å¤–æ´©çš„é¢¨éšªï¼‰

					* refresh token ä¹Ÿä¸æœƒè½åœ¨ç€è¦½å™¨

å‚™è¨»:

	å°ç…§è¡¨
		| éšæ®µ       | Token     | aud      | ç”¨ä¾†å¹¹å˜›        |
		| ---------- | --------- | -------- | --------------- |
		| ç™»å…¥       | AT_portal | portal   | è­‰æ˜ä½¿ç”¨è€…ç™»å…¥  |
		| é»å­ç³»çµ± A | AT_A      | system-a | å‘¼å« A API      |
		| é»å­ç³»çµ± B | AT_B      | system-b | å‘¼å« B API      |

	æ±ºç­–è¡¨
		| æ¢ä»¶               | é¸æ“‡                     |
		| ------------------ | ------------------------ |
		| æœ‰ Gateway         | âœ… Token Exchange        |
		| æœ‰è·¨å€ / zone      | âœ… Token Exchange        |
		| å­ç³»çµ±ä¸æ˜¯ç¬¬ä¸‰æ–¹   | âœ… Token Exchange        |
		| å¼·èª¿å¹³å°æ²»ç†       | âœ… Token Exchange        |
		| ç´” SaaS / å¤–éƒ¨æ•´åˆ | Authorization Code Flow  |

	ã€Œå®Œæ•´ç‰ˆæœ¬æµç¨‹ã€
		ğŸ”¹ Step 1ï¼šä½¿ç”¨è€…ç™»å…¥ Portalï¼ˆäººé¡ç™»å…¥ï¼‰
			Browser
			  â†’ /authorize (code + PKCE)
			  â†’ /token
			å–å¾—ï¼š
				| Token                    | ç”¨é€”                  |
				| ------------------------ | --------------------- |
				| `id_token`               | ä½¿ç”¨è€…èº«åˆ†ï¼ˆç™»å…¥æ…‹ï¼‰  |
				| `access_token (portal)`  | Portal / BFF ç”¨       |
				| `refresh_token (portal)` | âœ… å¯é¸ï¼ˆä¸‹é¢è§£é‡‹ï¼‰   |
			ğŸ‘‰ é€™ä¸€æ­¥æ˜¯ã€Œäºº â†’ IdPã€

		ğŸ”¹ Step 2ï¼šé»å­ç³»çµ±ï¼ˆç³»çµ±èº«åˆ†è½‰æ›ï¼‰
			Portal / Gateway
			  â†’ /token (grant_type=token_exchange)
			åƒæ•¸æ¦‚å¿µï¼š

				* subject_token = access_token (portal)

				* audience = system-A

				* scope = system-a.*
			å–å¾—ï¼š
				| Token                     | ç”¨é€”              |
				| ------------------------- | ----------------- |
				| `access_token (system-A)` | æ‰“ system A API   |
				| `refresh_token`           | âŒ é€šå¸¸ã€Œä¸ç™¼ã€   |
			ğŸ‘‰ é€™ä¸€æ­¥æ˜¯ã€Œç³»çµ± â†’ IdPã€

		ğŸ”¥ é—œéµä¿®æ­£é»ï¼šä¸æ˜¯ã€Œæ¯é¡† token éƒ½è©² refreshã€

		1.Portal ç™»å…¥ tokenï¼šå¯ä»¥æœ‰ refresh tokenï¼ˆçœ‹æ¶æ§‹ï¼‰
			ä»€éº¼æ™‚å€™ã€Œå¯ä»¥çµ¦ã€ï¼Ÿ

				* Portal æ˜¯ BFF / server-side

				* refresh token ä¸æœƒè½åœ¨ç€è¦½å™¨ JS

				* ä½ å¸Œæœ›ï¼š

					* ä½¿ç”¨è€…ä¹…åä¸è¢«è¸¢

					* Portal session å¯è‡ªå‹•å»¶é•·

			ğŸ‘‰ é€™å¾ˆåˆç†

		2.Token Exchange å‡ºä¾†çš„ system tokenï¼šé€šå¸¸ã€Œä¸ refreshã€
			ç‚ºä»€éº¼ï¼Ÿ

				å› ç‚ºå®ƒçš„å®šä½æ˜¯ï¼š

					ã€ŒçŸ­å‘½ã€ç”¨é€”å–®ä¸€ã€å¯é‡æ›ã€çš„ç³»çµ± token

			æ­£è¦åšæ³•æ˜¯ï¼š

				system access tokenï¼š

					* TTL çŸ­ï¼ˆ5~15 åˆ†é˜ï¼‰

				å¿«éæœŸæ™‚ï¼š

					* å†è·‘ä¸€æ¬¡ Token Exchange

					* è€Œä¸æ˜¯ refresh å®ƒ

				AT_system-A å¿«éæœŸ
				   â†“
				å†ç”¨ AT_portal
				   â†“
				Token Exchange
				   â†“
				æ–°çš„ AT_system-A

				ğŸ‘‰ ä½ å·²ç¶“æœ‰ source of truthï¼ˆportal tokenï¼‰äº†ï¼Œä¸éœ€è¦ refresh system token

	ã€Œæœ€ä¹¾æ·¨æ¨¡å‹ã€
		ã€ç™»å…¥å±¤ã€‘
			Authorization Code + PKCE
			  â†’ AT_portal (+ RT_portal)

		ã€ç³»çµ±å±¤ã€‘
			Token Exchange
			  â†’ AT_system (çŸ­å‘½ã€ç„¡ RT)

		ã€å»¶é•·ç­–ç•¥ã€‘
			- Portal sessionï¼šç”¨ RT_portal
			- System tokenï¼šé‡æ–° exchange

	ä¸€å¼µã€Œæœ€çµ‚è²¬ä»»è¡¨ã€
		| Token     | ä¾†æº           | æœ‰ RTï¼Ÿ     | æ€éº¼å»¶é•·       |
		| --------- | -------------- | ----------- | -------------- |
		| AT_portal | Auth Code Flow | âœ… å¯é¸     | refresh_token  |
		| AT_system | Token Exchange | âŒ å»ºè­°ä¸è¦ | å† exchange    |
		| id_token  | Auth Code Flow | âŒ          | ä¸å»¶           |

	çµè«–
		Portal ç™»å…¥ç”¨ Authorization Code Flow + PKCE
		å­ç³»çµ±å­˜å–ç”¨ Token Exchange
		å»¶é•·ç™»å…¥ç”¨ refresh tokenï¼ˆåªé™ Portal å±¤ï¼‰
		ç³»çµ± token ä¸€å¾‹çŸ­å‘½ã€å¯é‡æ›


ä½ çš„æ¶æ§‹è„ˆçµ¡ä¸‹ï¼ˆPortal + å¤šå­ç³»çµ± + Token Exchangeï¼‰ï¼Œå»ºè­°

	* å…ˆç”¨ oidc-client-ts æŠŠ Portal çš„ Code+PKCE ç™»å…¥è·‘ç©©ï¼ˆæœ€å°‘è®Šæ•¸ã€æœ€ç¬¦åˆè¦æ ¼ï¼‰

	* å­ç³»çµ± token çš„äº‹æƒ…ï¼ˆToken Exchange / refresh / çºŒæœŸï¼‰ç›¡é‡æ”¾åœ¨ Gateway/BFF ç«¯åšï¼Œå‰ç«¯åªç¶­æŒç™»å…¥ç‹€æ…‹æˆ–æ‹¿çŸ­å‘½ access token

	* å› ç‚ºã€Œç€è¦½å™¨ç«¯å¾ˆé›£å®‰å…¨ä¿å­˜ tokenã€æ˜¯æ¥­ç•Œé•·æœŸå…±è­˜ï¼ŒBFF/Token Handler é€™é¡æ¨¡å¼å°±æ˜¯ç‚ºäº†æŠŠ token ç•™åœ¨å¾Œç«¯ã€‚