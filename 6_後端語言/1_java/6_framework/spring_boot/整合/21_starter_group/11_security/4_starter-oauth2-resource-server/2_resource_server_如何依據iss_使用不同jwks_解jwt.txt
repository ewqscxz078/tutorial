ref ChatGPT

resource server
	JWT å¯ä»¥ã€ŒæŒ‡å®šè¦ç”¨å“ªç¾¤ JWKã€ä¾†é©—ç°½ï¼Œå¸¸è¦‹åšæ³•æ˜¯é€é kid (Key ID) èˆ‡ ä¸åŒçš„ JWK Set ç«¯é» ä¾†å€éš”

å¸¸è¦‹çš„åšæ³•
	1. ç”¨ ä¸åŒçš„ kid + åŒä¸€å€‹ /jwks
		* JWT header å¸¶æœ‰ kidï¼ŒDecoder æœƒå» /jwks æ‰¾åˆ°ç›¸ç¬¦çš„å…¬é‘°é©—ç°½ã€‚
		* é€™ç¨®æƒ…æ³ä¸‹ã€ŒåŒä¸€çµ„ /jwksã€å¯ä»¥åŒæ™‚å®¹ç´ï¼š
			* ä¸€äº›å¤–éƒ¨å…±ç”¨ã€ä¸åš rotation çš„å›ºå®šå…¬é‘°ã€‚
			* ä¸€äº›å…§éƒ¨æœƒå®šæœŸ rotation çš„å‹•æ…‹å…¬é‘°ã€‚

		* å„ªé»ï¼šç¶­è­·å–®ä¸€ç«¯é»ã€‚
		* ç¼ºé»ï¼šå¤–éƒ¨çš„ key ç„¡æ³•æ§ç®¡ï¼Œå¯èƒ½æœƒè®“ JWKS è¶Šä¾†è¶Šå¤§ï¼Œæˆ–è€…å…§å¤–ç•Œç·šæ¨¡ç³Šã€‚

	2. ç”¨ ä¸åŒçš„ jwk setï¼ˆä¸åŒ URL/Issuerï¼‰
		* æœ€ä¹¾æ·¨çš„æ–¹å¼æ˜¯ã€Œä¸åŒ Issuer ä»£è¡¨ä¸åŒçš„ key policyã€ï¼š
			å¤–éƒ¨ï¼ˆkong ç™¼çš„ï¼‰ï¼šä¾‹å¦‚ https://kong.example.com/jwks
			å…§éƒ¨ï¼ˆauth server ç™¼çš„ï¼‰ï¼šä¾‹å¦‚ https://auth.internal.local/jwks

		* ä½ çš„æœå‹™åœ¨é©— JWT æ™‚ï¼Œå…ˆæ ¹æ“š Issuer (iss) claim æˆ– audience (aud) claimï¼Œæ±ºå®šè¦å»å“ªå€‹ JWK Set æ‹‰å…¬é‘°ã€‚
		* å„ªé»ï¼šé‚Šç•Œæ¸…æ¥šï¼Œå…§å¤–éƒ¨ä¿¡ä»»éˆå¯åˆ†é–‹æ²»ç†ã€‚
		* ç¼ºé»ï¼šæœå‹™è¦èƒ½è™•ç†ã€Œå¤šå€‹ JWK sourceã€ã€‚

	3. æœå‹™ç«¯ç¶­è­·å¤šå€‹ JwtDecoder

		åœ¨ Spring Securityï¼ˆSpring Authorization Server æˆ– Resource Serverï¼‰è£¡ï¼Œä½ å¯ä»¥é€™æ¨£åšï¼š
			* ä¸€å€‹ JwtDecoder å°æ‡‰ã€Œå…§éƒ¨ JWK rotation çš„ sourceã€ã€‚
			* å¦ä¸€å€‹ JwtDecoder å°æ‡‰ã€Œå¤–éƒ¨ kong çš„å›ºå®šå…¬é‘°ã€ã€‚

		ç„¶å¾Œé€é JwtIssuerAuthenticationManagerResolver æˆ–è‡ªè¨‚çš„ AuthenticationManagerResolver<HttpServletRequest>ï¼Œå‹•æ…‹æ±ºå®šè¦ç”¨å“ªå€‹ decoderã€‚
			ç¯„ä¾‹ï¼š
				@Bean
				AuthenticationManagerResolver<HttpServletRequest> authenticationManagerResolver() {
					return new JwtIssuerAuthenticationManagerResolver(
						"https://auth.internal.local/",
						"https://kong.example.com/"
					);
				}
		é€™æ¨£ä¸€ä¾†ï¼š
			iss = https://auth.internal.local/ â†’ ç”¨å…§éƒ¨ jwksï¼ˆæœ‰ rotationï¼‰ã€‚
			iss = https://kong.example.com/ â†’ ç”¨å¤–éƒ¨ jwksï¼ˆå›ºå®š keyï¼Œä¸ rotationï¼‰ã€‚

å»ºè­°ç­–ç•¥ï¼ˆä¾ç…§ä½ çš„æƒ…å¢ƒï¼‰

	å¤–éƒ¨ kongï¼šä½ æ§åˆ¶ä¸äº† rotationï¼Œå°±è®“å®ƒç¨ç«‹ä¸€çµ„ JWKS / Issuerï¼Œä¸¦ä¸”åªé©—å®ƒéœ€è¦çš„ tokenã€‚

	å…§éƒ¨ç³»çµ±ï¼šç”¨ä½ è‡ªå·±çš„ Auth Serverï¼Œæ­é… DB æ¨¡å¼çš„ JWK rotationã€‚

	Resource Serverï¼ˆè¢«å‘¼å«æ–¹ï¼‰ï¼šå¿…é ˆèƒ½æ ¹æ“š iss æˆ– aud åˆ†è¾¨ã€Œè©²ç”¨å“ªç¾¤ JWK é©—ç°½ã€ã€‚

ğŸ‘‰ ç¸½çµï¼š
	JWT æœ¬èº«é€é kid å¯ä»¥æŒ‡å®šå–®ä¸€é‡‘é‘°ï¼Œä½†**ã€ŒæŒ‡å®šå“ªç¾¤ JWKã€é€šå¸¸æ˜¯é  issï¼ˆIssuerï¼‰æˆ– audï¼ˆAudienceï¼‰ä¾†å€åˆ†**ï¼Œ
	å†æ­é…å¤šå€‹ JWKS ä¾†æºã€‚é€™æ¨£ä½ å°±èƒ½åŒæ™‚æ”¯æŒå¤–éƒ¨ kongï¼ˆå›ºå®š keyï¼‰èˆ‡å…§éƒ¨ï¼ˆæœ‰ rotation çš„ keyï¼‰ã€‚

é‡é»æ˜¯ç”¨ AuthenticationManagerResolver<HttpServletRequest> ä¾ issï¼ˆIssuerï¼‰æŠŠè«‹æ±‚å°åˆ°å°æ‡‰çš„ JwtDecoder
	ç›®æ¨™èƒ½åŠ›
		* ä¾ issï¼ˆæˆ–ä½ è¦ä¹Ÿèƒ½æ”¹æˆçœ‹ audï¼‰æŠŠ JWT åˆ†æµåˆ°ä¸åŒçš„ JWK ç¾¤ã€‚

		* å…§éƒ¨ Issuerï¼šèµ° OIDC æˆ–å…¬é–‹çš„ /.well-known/openid-configurationï¼Œè‡ªå‹•ç™¼ç¾ jwks_uriï¼ˆæ”¯æ´ rotationï¼‰ã€‚

		* å¤–éƒ¨ Kong Issuerï¼šå¯ç”¨

			* issuer-uriï¼ˆè‹¥ Kong æœ‰å°å¤– OIDC metadataï¼‰ï¼Œæˆ–

			* ç›´æ¥æŒ‡å®š jwk-set-uriï¼Œæˆ–

			* ä¹¾è„†æ”¾å›ºå®š PEM å…¬é‘°ï¼ˆè‹¥çœŸçš„å®Œå…¨ç„¡ rotationï¼‰ã€‚

	è¦é”æˆçš„éœ€æ±‚
		1.æœ‰å…©ç¾¤ JWT
			å…§éƒ¨ JWTï¼šç”±ä½ çš„ Auth Server ç°½ç™¼ â†’ è¦æœ‰ JWK rotationã€‚
			å¤–éƒ¨ JWTï¼ˆä¾‹å¦‚ Kongï¼‰ï¼šä½ æ²’è¾¦æ³•æ§ç®¡ rotationï¼Œåªèƒ½ç”¨å®ƒæä¾›çš„ä¸€çµ„å›ºå®š JWK / å…¬é‘°ã€‚

		2.Resource Server è¦èƒ½åŒæ™‚é©—è­‰é€™å…©ç¨® JWTï¼Œè€Œä¸”è¦çŸ¥é“è©²ç”¨å“ªä¸€ç¾¤ JWK ä¾†é©—ã€‚

	æœ€ä½³ç­–ç•¥å»ºè­°
		ğŸ‘‰ ç”¨ iss (Issuer Claim) å€åˆ†ï¼Œæ˜¯æœ€ä¹¾æ·¨ã€æœ€ç©©å®šçš„åšæ³•ã€‚
			åŸå› ï¼š
				* JWT è¦ç¯„æœ¬ä¾†å°±è¦æ±‚ iss æŒ‡æ˜ã€Œé€™å€‹ token æ˜¯å“ªå€‹ issuer ç™¼çš„ã€ã€‚
				* ä½ å¯ä»¥æŠŠã€Œæ¯å€‹ issuer ç¶å®šä¸€çµ„ JWKSã€ï¼š
					* iss=https://auth.internal.local â†’ ç”¨å…§éƒ¨çš„ JWKSï¼ˆæœ‰ rotationï¼‰ã€‚
					* iss=https://kong.example.com â†’ ç”¨å¤–éƒ¨ Kong çš„ JWKSï¼ˆå›ºå®šä¸è®Šï¼‰ã€‚
				* Spring Securityï¼ˆæˆ–å…¶ä»–é©—è­‰æ¡†æ¶ï¼‰éƒ½æœ‰æ”¯æ´ã€Œå¤šå€‹ Issuer â†’ å¤šå€‹ JWKSã€çš„ resolver æ©Ÿåˆ¶ï¼Œä¸ç”¨è‡ªå·±ç¡¬å¯«å…¨éƒ¨é‚è¼¯ã€‚
	ç‚ºä»€éº¼ä¸ç”¨å–®é  kid
		* kid åªèƒ½åœ¨ã€ŒåŒä¸€å€‹ JWKS é›†åˆè£¡ã€æŒ‘å“ªæŠŠ keyã€‚
		* ä½†ä½ é€™è£¡å…¶å¯¦æ˜¯ã€Œå…©å€‹å®Œå…¨ä¸åŒçš„é‡‘é‘°ä¾†æºã€ï¼ˆä¸€å€‹å…§éƒ¨è‡ªå·±æ§ç®¡ rotationï¼Œä¸€å€‹å¤–éƒ¨å›ºå®š keyï¼‰ã€‚
		* è‹¥å…¨éƒ½æ··é€²åŒä¸€å€‹ JWKSï¼Œå°±å¾ˆé›£ç®¡è½„ rotation èˆ‡ policyï¼Œé‚„æœƒæœ‰å®‰å…¨é‚Šç•Œä¸æ¸…çš„å•é¡Œã€‚

	âœ… ç¸½çµä¸€å¥ï¼š
		æ˜¯çš„ï¼Œæœ€ä½³ç­–ç•¥å°±æ˜¯ï¼šJWT å…ˆçœ‹ issï¼ˆIssuerï¼‰ï¼Œå†æ±ºå®šå»ç”¨å“ªä¸€ç¾¤ JWKS ä¾†é©—è­‰ã€‚
		å…§éƒ¨ iss â†’ å…§éƒ¨ JWKSï¼ˆrotationï¼‰ã€‚
		å¤–éƒ¨ iss â†’ å¤–éƒ¨ JWKSï¼ˆå›ºå®š keyï¼‰ã€‚

æ ¸å¿ƒç¨‹å¼ç¢¼ç¯„ä¾‹
	resource server 
		1. application.yml
			security:
			  jwt:
				internal:
				  issuer: https://auth.internal.local
				  jwk-set-uri: https://auth.internal.local/oauth2/jwks
				kong:
				  issuer: https://kong.example.com
				  jwk-set-uri: https://kong.example.com/jwks
		
		2. SecurityConfig.java
			import jakarta.servlet.http.HttpServletRequest;
			import org.springframework.context.annotation.Bean;
			import org.springframework.context.annotation.Configuration;
			import org.springframework.security.authentication.AuthenticationManager;
			import org.springframework.security.authentication.AuthenticationManagerResolver;
			import org.springframework.security.authentication.ProviderManager;
			import org.springframework.security.config.annotation.web.builders.HttpSecurity;
			import org.springframework.security.oauth2.jwt.*;
			import org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationProvider;
			import org.springframework.security.web.SecurityFilterChain;

			import java.util.HashMap;
			import java.util.Map;

			@Configuration
			public class SecurityConfig {

				@Bean
				SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
					http
						.authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
						.oauth2ResourceServer(oauth2 -> oauth2
							.authenticationManagerResolver(authenticationManagerResolver())
						);
					return http.build();
				}

				@Bean
				AuthenticationManagerResolver<HttpServletRequest> authenticationManagerResolver() {
					// 1. å»ºç«‹ä¸åŒçš„ JwtDecoder
					JwtDecoder internalDecoder =
						NimbusJwtDecoder.withJwkSetUri("https://auth.internal.local/oauth2/jwks").build();
					JwtDecoder kongDecoder =
						NimbusJwtDecoder.withJwkSetUri("https://kong.example.com/jwks").build();

					// 2. å»ºç«‹ AuthenticationManager (ä¸€å€‹ issuer å°æ‡‰ä¸€å€‹)
					Map<String, AuthenticationManager> managers = new HashMap<>();
					managers.put("https://auth.internal.local",
						new ProviderManager(new JwtAuthenticationProvider(internalDecoder)));
					managers.put("https://kong.example.com",
						new ProviderManager(new JwtAuthenticationProvider(kongDecoder)));

					// 3. ç”¨ Spring æä¾›çš„ JwtIssuerAuthenticationManagerResolver
					return new JwtIssuerAuthenticationManagerResolver(managers::get);
				}
			}
