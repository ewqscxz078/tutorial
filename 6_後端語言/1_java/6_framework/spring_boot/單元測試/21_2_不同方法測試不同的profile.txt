ref ChatGPT

ä¸åŒæ–¹æ³•æ¸¬è©¦ä¸åŒçš„profile
	æ–¹æ¡ˆ
		æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ @Nestedï¼Œè®“ä¸åŒ Profile æ¸¬è©¦æ”¾åœ¨ä¸åŒå…§éƒ¨é¡åˆ¥
		æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ System.setProperty å‹•æ…‹è®Šæ›´ spring.profiles.active
		æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ ContextCustomizerFactory (é€²éš)
		æ–¹æ¡ˆ 4ï¼šä½¿ç”¨ @DirtiesContext å¼·åˆ¶é‡æ–°è¼‰å…¥ Context
		æ–¹æ¡ˆ 5ï¼šåˆ†é–‹ä¸åŒçš„æ¸¬è©¦é¡åˆ¥

	æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ @Nestedï¼Œè®“ä¸åŒ Profile æ¸¬è©¦æ”¾åœ¨ä¸åŒå…§éƒ¨é¡åˆ¥
		é©ç”¨å ´æ™¯
			ApplicationContext æœƒç‚º æ¯å€‹ @Nested æ¸¬è©¦é¡åˆ¥é‡æ–°å•Ÿå‹•ï¼Œ
				é€™æ˜¯ Spring å®˜æ–¹å»ºè­°çš„ Profile æ¸¬è©¦æ–¹å¼ã€‚
			é€™æ¨£çš„ Profile æœƒå½±éŸ¿ @Bean è¨»å†Šã€‚
		ç¯„ä¾‹
			@SpringBootTest
			public class MyServiceTest {

				@Nested
				@ActiveProfiles("main")
				class ProfileMain {
					@Test
					void testMain() {
						System.out.println("æ¸¬è©¦ main profile");
					}
				}

				@Nested
				@ActiveProfiles({"main", "a"})
				class ProfileA {
					@Test
					void testProfileA() {
						System.out.println("æ¸¬è©¦ main + a profile");
					}
				}

				@Nested
				@ActiveProfiles({"main", "b"})
				class ProfileB {
					@Test
					void testProfileB() {
						System.out.println("æ¸¬è©¦ main + b profile");
					}
				}
			}
		ğŸ“Œ å„ªå‹¢
			é©ç”¨æ–¼ Profile å½±éŸ¿ @Bean è¨»å†Šçš„æƒ…æ³ï¼Œæ¯å€‹ Profile éƒ½æœƒå»ºç«‹ä¸€å€‹æ–°çš„ ApplicationContextã€‚
			@ActiveProfiles å¯ä»¥æ­£å¸¸ç”Ÿæ•ˆï¼Œå› ç‚ºå®ƒä½œç”¨æ–¼ @Nested é¡åˆ¥ã€‚
		ğŸ“Œ ç¼ºé»
			æ¯å€‹ @Nested æ¸¬è©¦é¡åˆ¥éƒ½æœƒé‡æ–°å•Ÿå‹• ApplicationContextï¼Œå½±éŸ¿æ¸¬è©¦é€Ÿåº¦ã€‚

	æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ System.setProperty å‹•æ…‹è®Šæ›´ spring.profiles.active
		é©ç”¨å ´æ™¯ï¼š
			éœ€è¦ ä¸åŒæ¸¬è©¦æ–¹æ³•ä½¿ç”¨ä¸åŒçš„ Profileã€‚
			åªæƒ³å•Ÿå‹•ä¸€æ¬¡ ApplicationContextï¼Œæ¸›å°‘ Spring Boot å•Ÿå‹•æ™‚é–“ã€‚
			Profile ä¸»è¦å½±éŸ¿ @Valueã€ç’°å¢ƒè®Šæ•¸ï¼Œä¸å½±éŸ¿ @Bean è¨»å†Šã€‚
		ç¯„ä¾‹
			@SpringBootTest
			@TestInstance(TestInstance.Lifecycle.PER_CLASS) // è®“æ‰€æœ‰æ¸¬è©¦å…±ç”¨åŒä¸€å€‹æ¸¬è©¦é¡å¯¦ä¾‹
			public class MyServiceTest {

				@Autowired
				private Environment environment;

				@BeforeEach
				void setup(TestInfo testInfo) {
					if (testInfo.getTestMethod().get().getName().equals("testMain")) {
						System.setProperty("spring.profiles.active", "main");
					} else if (testInfo.getTestMethod().get().getName().equals("testProfileA")) {
						System.setProperty("spring.profiles.active", "main,a");
					} else if (testInfo.getTestMethod().get().getName().equals("testProfileB")) {
						System.setProperty("spring.profiles.active", "main,b");
					}
				}

				@Test
				void testMain() {
					assertEquals("main-value", environment.getProperty("my.property"));
				}

				@Test
				void testProfileA() {
					assertEquals("a-value", environment.getProperty("my.property"));
				}

				@Test
				void testProfileB() {
					assertEquals("b-value", environment.getProperty("my.property"));
				}
			}
		ğŸ“Œ å„ªå‹¢ï¼š
			åªæœƒ å•Ÿå‹•ä¸€æ¬¡ ApplicationContextï¼ŒåŸ·è¡Œé€Ÿåº¦å¿«ã€‚
			é©åˆ Profile å½±éŸ¿çš„æ˜¯ ç’°å¢ƒè®Šæ•¸ (@Value)ï¼Œè€Œä¸æ˜¯ @Bean è¨»å†Šã€‚
		ğŸ“Œ ç¼ºé»ï¼š
			System.setProperty å½±éŸ¿çš„æ˜¯ JVMï¼Œè€Œä¸æ˜¯ Spring Environmentï¼Œå¯èƒ½ä¸æœƒå³æ™‚ç”Ÿæ•ˆã€‚
			å¦‚æœ Profile å½±éŸ¿ @Bean è¨»å†Šï¼Œé€™ç¨®æ–¹å¼ç„¡æ•ˆï¼Œå› ç‚º ApplicationContext ä¸æœƒé‡æ–°è¼‰å…¥ Beanã€‚

	æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ ContextCustomizerFactory (é€²éš)
		é©ç”¨å ´æ™¯ï¼š
			ä¸åŒæ¸¬è©¦æ–¹æ³•å‹•æ…‹è®Šæ›´ Profileï¼Œä¸¦è®“ Spring ApplicationContext é‡æ–°è¼‰å…¥ã€‚
			é¿å… System.setProperty ä¸ç”Ÿæ•ˆçš„å•é¡Œã€‚
		ç¯„ä¾‹
			è‡ªè¨‚ ContextCustomizerFactory
				import org.junit.jupiter.api.extension.ExtensionContext;
				import org.springframework.test.context.ContextCustomizer;
				import org.springframework.test.context.ContextCustomizerFactory;
				import org.springframework.test.context.MergedContextConfiguration;

				import java.lang.reflect.Method;

				public class DynamicProfileContextCustomizerFactory implements ContextCustomizerFactory {
					@Override
					public ContextCustomizer createContextCustomizer(Class<?> testClass, MergedContextConfiguration config) {
						return (context) -> {
							ExtensionContext.Store store = ExtensionContext.Namespace.GLOBAL.getStore();
							Method testMethod = store.get(ExtensionContext.Namespace.GLOBAL, Method.class);
							if (testMethod != null) {
								String profile = testMethod.getName().contains("ProfileA") ? "main,a"
										: testMethod.getName().contains("ProfileB") ? "main,b"
										: "main";
								System.setProperty("spring.profiles.active", profile);
							}
						};
					}
				}
			æ¸¬è©¦é¡åˆ¥ä¸Šä½¿ç”¨
				@SpringBootTest
				@ExtendWith(SpringExtension.class)
				@ContextConfiguration(initializers = DynamicProfileContextCustomizerFactory.class)
				public class MyServiceTest {

					@Autowired
					private Environment environment;

					@Test
					void testMain() {
						assertEquals("main-value", environment.getProperty("my.property"));
					}

					@Test
					void testProfileA() {
						assertEquals("a-value", environment.getProperty("my.property"));
					}

					@Test
					void testProfileB() {
						assertEquals("b-value", environment.getProperty("my.property"));
					}
				}
			ğŸ“Œ å„ªå‹¢ï¼š
				å¯ä»¥å‹•æ…‹ è®“ Spring Boot é‡æ–°è¼‰å…¥ Profileï¼Œç¢ºä¿ Profile è®Šæ›´å° Bean ç”Ÿæ•ˆã€‚
				Profile åˆ‡æ›ä¸æœƒå½±éŸ¿æ•´å€‹ JVMï¼Œé¿å… System.setProperty çš„å•é¡Œã€‚
			ğŸ“Œ ç¼ºé»ï¼š
				ä»ç„¶æœƒè§¸ç™¼ ApplicationContext é‡æ–°è¼‰å…¥ï¼Œæ¸¬è©¦é€Ÿåº¦è¼ƒæ…¢ã€‚
				è¼ƒç‚ºé€²éšï¼Œä¸å¦‚ System.setProperty ç°¡å–®ã€‚

	æ–¹æ¡ˆ 4ï¼šä½¿ç”¨ @DirtiesContext å¼·åˆ¶é‡æ–°è¼‰å…¥ Context
		ğŸ“Œ é©ç”¨å ´æ™¯ï¼š
			éœ€è¦æ¸¬è©¦æ–¹æ³• è®Šæ›´ Profileï¼Œä¸¦ä¸”å½±éŸ¿ @Bean è¨­å®šã€‚
			å¯ä»¥æ¥å— æ¸¬è©¦åŸ·è¡Œé€Ÿåº¦è¼ƒæ…¢ã€‚
		ç¯„ä¾‹
			@SpringBootTest
			public class MyServiceTest {

				@Autowired
				private Environment environment;

				@Test
				@DirtiesContext
				@ActiveProfiles("main")
				void testMain() {
					assertEquals("main-value", environment.getProperty("my.property"));
				}

				@Test
				@DirtiesContext
				@ActiveProfiles({"main", "a"})
				void testProfileA() {
					assertEquals("a-value", environment.getProperty("my.property"));
				}

				@Test
				@DirtiesContext
				@ActiveProfiles({"main", "b"})
				void testProfileB() {
					assertEquals("b-value", environment.getProperty("my.property"));
				}
			}
		ğŸ“Œ å„ªå‹¢ï¼š
			Spring æœƒ æ¯æ¬¡æ¸¬è©¦å¾ŒéŠ·æ¯€ ApplicationContextï¼Œç¢ºä¿ Profile åˆ‡æ›æ™‚ä¸æœƒç™¼ç”ŸéŒ¯èª¤ã€‚
		ğŸ“Œ ç¼ºé»ï¼š
			æ¸¬è©¦é€Ÿåº¦è®Šæ…¢ï¼Œå› ç‚ºæ¯å€‹æ¸¬è©¦æ–¹æ³• éƒ½æœƒé‡æ–°å•Ÿå‹• ApplicationContextã€‚

	 æ–¹æ¡ˆ 5ï¼šåˆ†é–‹ä¸åŒçš„æ¸¬è©¦é¡åˆ¥
		é©ç”¨å ´æ™¯ï¼š
			æ¸¬è©¦ Profile å½±éŸ¿ @Bean è¨»å†Šï¼Œç„¡æ³•å…±ç”¨ ApplicationContextã€‚
			éœ€è¦ æ¯å€‹ Profile éƒ½æœ‰ç¨ç«‹çš„æ¸¬è©¦ã€‚
		ç¯„ä¾‹
			@SpringBootTest
			@ActiveProfiles("main")
			public class MyServiceMainTest {

				@Test
				void testMain() {
					assertEquals("main-value", System.getProperty("my.property"));
				}
			}
			@SpringBootTest
			@ActiveProfiles({"main", "a"})
			public class MyServiceATest {

				@Test
				void testProfileA() {
					assertEquals("a-value", System.getProperty("my.property"));
				}
			}
		ğŸ“Œ å„ªå‹¢ï¼š
			Profile ç¨ç«‹ï¼Œæ¸¬è©¦æ›´ä¹¾æ·¨ï¼Œä¸æœƒç™¼ç”Ÿ Profile æ²–çªã€‚
			Spring Boot æœƒæ ¹æ“š @ActiveProfiles å•Ÿå‹•ä¸åŒçš„ ApplicationContextã€‚
		ğŸ“Œ ç¼ºé»ï¼š
			éœ€è¦å»ºç«‹å¤šå€‹æ¸¬è©¦é¡åˆ¥ï¼Œæ¸¬è©¦é¡åˆ¥æ•¸é‡è®Šå¤šã€‚

âœ… æœ€ä½³é¸æ“‡
	å¦‚æœ Profile å½±éŸ¿ @Bean è¨»å†Šï¼Œä½¿ç”¨ @DirtiesContext æˆ– æ‹†é–‹ä¸åŒé¡åˆ¥ (æ–¹æ¡ˆ 4 & æ–¹æ¡ˆ 5)ã€‚
	å¦‚æœ Profile åªå½±éŸ¿ @Valueï¼Œä½¿ç”¨ System.setProperty (æ–¹æ¡ˆ 2)ï¼Œæœ€å¿«ï¼
	å¦‚æœæƒ³å…¼é¡§é€Ÿåº¦èˆ‡ Profile è®Šæ›´ï¼Œä½¿ç”¨ ContextCustomizerFactory (æ–¹æ¡ˆ 3)ã€‚